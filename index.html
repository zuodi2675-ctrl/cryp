<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>LUMINA v2.3 PRO</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#000000">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 fill=%22%23000%22/><circle cx=%2250%22 cy=%2250%22 r=%2235%22 stroke=%22%2300e5ff%22 stroke-width=%228%22 fill=%22none%22/><text x=%2250%22 y=%2262%22 font-family=%22sans-serif%22 font-size=%2240%22 font-weight=%22900%22 fill=%22%23eee%22 text-anchor=%22middle%22>L</text></svg>">

    <style>
        :root { --accent: #00e5ff; --bg: #000; --panel: #141414; --text: #eee; --safe-top: env(safe-area-inset-top); --safe-bottom: env(safe-area-inset-bottom); }
        * { box-sizing: border-box; user-select: none; outline: none; -webkit-tap-highlight-color: transparent; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        body { margin: 0; background: var(--bg); color: var(--text); height: 100vh; width: 100vw; overflow: hidden; display: flex; flex-direction: column; }

        /* Top Bar */
        .top-bar {
            height: calc(50px + var(--safe-top)); padding-top: var(--safe-top);
            display: flex; justify-content: space-between; align-items: center; padding: var(--safe-top) 15px 0 15px;
            background: linear-gradient(to bottom, rgba(0,0,0,0.9), transparent); 
            z-index: 200; position: absolute; top:0; left:0; right:0; pointer-events: none;
        }
        .top-btn { 
            pointer-events: auto; background: rgba(30,30,30,0.6); backdrop-filter: blur(10px); 
            width: 40px; height: 40px; border-radius: 50%; display: flex; justify-content: center; align-items: center; 
            font-size: 18px; border: 1px solid rgba(255,255,255,0.1); cursor: pointer; 
        }

        /* Stage */
        .stage-area { flex: 1; position: relative; background: #000; display: flex; justify-content: center; align-items: center; overflow: hidden; }
        #canvas-wrap { transition: transform 0.1s linear; box-shadow: 0 0 50px rgba(0,0,0,0.8); display: none; }
        canvas { display: block; }
        
        #empty-state { position: absolute; inset: 0; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 50; pointer-events: auto; }
        .add-icon { font-size: 40px; color: #333; margin-bottom: 10px; width: 80px; height: 80px; border: 2px dashed #333; border-radius: 50%; display: flex; justify-content: center; align-items: center; }

        /* Controls */
        .controls { 
            background: var(--panel); border-top-left-radius: 20px; border-top-right-radius: 20px;
            padding-bottom: var(--safe-bottom); position: relative; z-index: 100;
            display: flex; flex-direction: column; border-top: 1px solid #222;
        }

        /* Nav */
        .nav-bar { display: flex; justify-content: space-around; height: 60px; align-items: center; border-bottom: 1px solid #222; flex-shrink: 0; }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; opacity: 0.4; height: 100%; gap: 4px; transition: 0.2s; }
        .nav-item.active { opacity: 1; color: var(--accent); }
        .nav-lbl { font-size: 10px; font-weight: 600; }

        /* Panels */
        .panel-container { height: 200px; position: relative; overflow: hidden; }
        .panel { position: absolute; inset: 0; display: none; flex-direction: column; padding: 15px; overflow-y: auto; -webkit-overflow-scrolling: touch; }
        .panel.active { display: flex; }

        /* --- PRESETS UI (PC Grouping) --- */
        .group-title { font-size: 10px; color: var(--accent); font-weight: 900; margin: 10px 0 5px 5px; text-transform: uppercase; letter-spacing: 1px; }
        .preset-row { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 10px; scrollbar-width: none; }
        .preset-row::-webkit-scrollbar { display: none; }
        .p-chip { 
            flex-shrink: 0; width: 70px; height: 85px; background: #222; border-radius: 6px; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            border: 1px solid #333; position: relative; overflow: hidden;
        }
        .p-chip.active { background: #222; border-color: var(--accent); }
        .p-chip.active::after { content:''; position: absolute; bottom:0; left:0; right:0; height:3px; background:var(--accent); }
        .p-name { color: #fff; font-size: 11px; font-weight: bold; margin-bottom: 2px; }
        .p-tag { font-size: 9px; color: #666; background: #111; padding: 1px 3px; border-radius: 2px; }

        /* --- COLOR WHEEL UI (Fixed) --- */
        .col-tabs { display: flex; justify-content: center; gap: 8px; margin-bottom: 10px; }
        .c-btn { font-size: 11px; color: #888; padding: 4px 10px; border-radius: 12px; border: 1px solid #333; background: #111; }
        .c-btn.active { color: #000; background: var(--accent); border-color: var(--accent); font-weight: bold; }
        
        .wheel-container { display: flex; justify-content: center; align-items: center; height: 120px; width: 100%; }
        .wheel-disk { 
            width: 120px; height: 120px; /* Fixed Size */
            border-radius: 50%; background: #000; border: 2px solid #333; 
            position: relative; touch-action: none; flex-shrink: 0; /* Prevent deform */
        }
        .wheel-grad { position: absolute; inset: 2px; border-radius: 50%; background: conic-gradient(red, magenta, blue, cyan, lime, yellow, red); opacity: 0.7; pointer-events: none; }
        .wheel-puck { width: 14px; height: 14px; border: 2px solid #fff; background: rgba(0,0,0,0.5); border-radius: 50%; position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%); pointer-events: none; box-shadow: 0 0 5px #000; }

        /* Sliders */
        .slider-row { margin-bottom: 15px; }
        .sl-head { display: flex; justify-content: space-between; font-size: 11px; color: #ccc; margin-bottom: 6px; }
        .sl-val { color: var(--accent); font-family: monospace; }
        input[type=range] { width: 100%; background: transparent; height: 20px; -webkit-appearance: none; margin:0; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 2px; background: #333; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%; background: #fff; margin-top: -7px; box-shadow: 0 1px 3px rgba(0,0,0,0.5); border: 1px solid #000; }

        #toast { position: fixed; top: 50%; left: 50%; transform: translate(-50%,-50%); background: rgba(0,0,0,0.8); color: #fff; padding: 10px 20px; border-radius: 20px; opacity: 0; pointer-events: none; transition: 0.3s; z-index: 999; }
        .comp-btn { position: absolute; bottom: 210px; right: 15px; width: 44px; height: 44px; background: rgba(50,50,50,0.6); border-radius: 50%; display: none; justify-content: center; align-items: center; font-size: 20px; backdrop-filter: blur(5px); z-index: 150; border: 1px solid #444; }
    </style>
</head>
<body>

<div id="toast">âœ… å·²ä¿å­˜</div>
<input type="file" id="fileInput" accept="image/*" style="display:none" onchange="loadFile(this)">

<div class="top-bar">
    <div class="top-btn" onclick="document.getElementById('fileInput').click()">ğŸ“‚</div>
    <div style="font-weight:900; font-style:italic;">LUMINA <span style="color:var(--accent)">PRO</span></div>
    <div class="top-btn" onclick="exportImg()">ğŸ’¾</div>
</div>

<main class="stage-area" id="stage">
    <div id="empty-state" onclick="document.getElementById('fileInput').click()">
        <div class="add-icon">ï¼‹</div><div style="font-size:12px;color:#666">æ‰“å¼€ç…§ç‰‡</div>
    </div>
    <div id="canvas-wrap">
        <canvas id="gl"></canvas>
    </div>
    <div class="comp-btn" id="btn-comp" ontouchstart="setCmp(1)" ontouchend="setCmp(0)">ğŸ‘</div>
</main>

<div class="controls">
    <div class="panel-container">
        
        <div class="panel active" id="p-pre">
            <div class="group-title">æ™ºèƒ½åœºæ™¯ AI</div>
            <div class="preset-row" id="grp-ai"></div>
            
            <div class="group-title">ç»å…¸èƒ¶ç‰‡ FILM</div>
            <div class="preset-row" id="grp-film"></div>
        </div>

        <div class="panel" id="p-adj">
            <div class="slider-row"><div class="sl-head"><span>æ›å…‰ Exposure</span><span class="sl-val" id="v-exp">0</span></div><input type="range" id="s-exp" min="-2" max="2" step="0.01" value="0" oninput="u('exp',this.value)"></div>
            <div class="slider-row"><div class="sl-head"><span>å¯¹æ¯”åº¦ Contrast</span><span class="sl-val" id="v-con">1.0</span></div><input type="range" id="s-con" min="0" max="2" step="0.01" value="1" oninput="u('con',this.value)"></div>
            <div class="slider-row"><div class="sl-head"><span>é¥±å’Œåº¦ Saturation</span><span class="sl-val" id="v-sat">1.0</span></div><input type="range" id="s-sat" min="0" max="2" step="0.01" value="1" oninput="u('sat',this.value)"></div>
            <div class="slider-row"><div class="sl-head"><span>æ°›å›´ Boost</span><span class="sl-val" id="v-boost">0</span></div><input type="range" id="s-boost" min="0" max="1" step="0.01" value="0" oninput="u('boost',this.value)"></div>
            <div class="slider-row"><div class="sl-head"><span>äº®åº¦ Brightness</span><span class="sl-val" id="v-brt">0</span></div><input type="range" id="s-brt" min="-0.5" max="0.5" step="0.01" value="0" oninput="u('brt',this.value)"></div>
        </div>

        <div class="panel" id="p-col">
            <div class="col-tabs">
                <div class="c-btn active" onclick="setWheel('lift')" id="t-lift">æš—éƒ¨ Lift</div>
                <div class="c-btn" onclick="setWheel('gamma')" id="t-gamma">ä¸­ç° Gamma</div>
                <div class="c-btn" onclick="setWheel('gain')" id="t-gain">äº®éƒ¨ Gain</div>
                <div class="c-btn" onclick="setWheel('off')" id="t-off">åç§» Offset</div>
            </div>
            <div class="wheel-container">
                <div class="wheel-disk" id="wheel">
                    <div class="wheel-grad"></div>
                    <div class="wheel-puck" id="puck"></div>
                </div>
            </div>
            <div style="text-align:center; font-size:9px; color:#555; margin-top:5px;">* åŒå‡»è‰²è½®é‡ç½®å½“å‰é€šé“</div>
        </div>

        <div class="panel" id="p-por">
            <div class="slider-row"><div class="sl-head"><span>ç£¨çš® Smooth</span><span class="sl-val" id="v-sm">0</span></div><input type="range" id="s-sm" min="0" max="1" step="0.01" value="0" oninput="u('sm',this.value)"></div>
            <div class="slider-row"><div class="sl-head"><span>ç¾ç™½ Whiten</span><span class="sl-val" id="v-wh">0</span></div><input type="range" id="s-wh" min="0" max="1" step="0.01" value="0" oninput="u('wh',this.value)"></div>
            <div class="slider-row"><div class="sl-head"><span>çº¢æ¶¦ Rosy</span><span class="sl-val" id="v-ros">0</span></div><input type="range" id="s-ros" min="0" max="1" step="0.01" value="0" oninput="u('ros',this.value)"></div>
            <div class="slider-row"><div class="sl-head"><span>é™å™ª Noise Red.</span><span class="sl-val" id="v-nz">0</span></div><input type="range" id="s-nz" min="0" max="1" step="0.01" value="0" oninput="u('nz',this.value)"></div>
        </div>
    </div>

    <div class="nav-bar">
        <div class="nav-item active" onclick="nav('pre',this)"><div style="font-size:20px">ğŸï¸</div><span class="nav-lbl">æ»¤é•œ</span></div>
        <div class="nav-item" onclick="nav('adj',this)"><div style="font-size:20px">ğŸšï¸</div><span class="nav-lbl">å…‰æ•ˆ</span></div>
        <div class="nav-item" onclick="nav('col',this)"><div style="font-size:20px">ğŸ¨</div><span class="nav-lbl">è‰²è½®</span></div>
        <div class="nav-item" onclick="nav('por',this)"><div style="font-size:20px">ğŸ‘¤</div><span class="nav-lbl">äººåƒ</span></div>
    </div>
</div>

<script id="vs" type="x-shader/x-vertex">attribute vec2 p; attribute vec2 u; varying vec2 v; void main(){gl_Position=vec4(p,0,1);v=u;}</script>
<script id="fs" type="x-shader/x-fragment">
precision mediump float; uniform sampler2D t; varying vec2 v; uniform vec2 res;
uniform float brt,exp,con,sat,hue,boost,cmp,sm,wh,ros,nz;
uniform vec4 lft,gam,gan,off;
const vec3 W = vec3(0.299, 0.587, 0.114);

vec3 satf(vec3 c, float s) { float g=dot(c,W); return mix(vec3(g),c,s); }
vec3 r2h(vec3 c) { vec4 K=vec4(0.,-1./3.,2./3.,-1.); vec4 p=mix(vec4(c.bg,K.wz),vec4(c.gb,K.xy),step(c.b,c.g)); vec4 q=mix(vec4(p.xyw,c.r),vec4(c.r,p.yzx),step(p.x,c.r)); float d=q.x-min(q.w,q.y); float e=1.0e-10; return vec3(abs(q.z+(q.w-q.y)/(6.*d+e)),d/(q.x+e),q.x); }
vec3 h2r(vec3 c) { vec4 K=vec4(1.,2./3.,1./3.,3.); vec3 p=abs(fract(c.xxx+K.xyz)*6.-K.www); return c.z*mix(K.xxx,clamp(p-K.xxx,0.,1.),c.y); }

void main(){
    vec4 px = texture2D(t, v);
    if(cmp > 0.5) { gl_FragColor = px; return; }
    vec3 c = px.rgb;

    // Portrait & Denoise
    if(nz>0.0 || sm>0.0) {
        vec2 d = vec2(1.5)/res;
        vec3 b = texture2D(t, v+d).rgb + texture2D(t, v-d).rgb + texture2D(t, v+vec2(d.x,-d.y)).rgb + texture2D(t, v+vec2(-d.x,d.y)).rgb;
        if(nz>0.0) c = mix(c, b*0.25, nz);
        if(sm>0.0) { float sk = (c.r > c.g && c.g > c.b) ? 1.0 : 0.0; c = mix(c, b*0.25, sm*sk*0.8); }
    }
    if(wh>0.0 && c.r>c.g && c.g>c.b) c = mix(c, pow(c, vec3(1.0-wh*0.2)), 0.6);
    if(ros>0.0 && c.r>c.g && c.g>c.b) c.r += ros*0.06;

    // Basic
    if(abs(hue)>0.001){ vec3 h=r2h(c); h.x+=hue; c=h2r(h); }
    c += brt; c *= pow(2.0, exp); c = 0.5 + (c - 0.5) * con; c = satf(c, sat); c = satf(c, 1.0 + boost);

    // ASC-CDL Color Wheels
    vec3 L=lft.rgb; vec3 G=1.0/(1.0+gam.rgb); vec3 A=1.0+gan.rgb; vec3 O=off.rgb;
    c = (c + L*0.2) * A; c = pow(max(vec3(0), c), G); c += O*0.2;

    gl_FragColor = vec4(c, px.a);
}
</script>

<script>
    // --- Data: 1:1 Matching PC Version ---
    const presetsAI = [
        {id:'none', n:'åŸå§‹', t:'RAW', v:{}},
        {id:'port', n:'äººåƒ', t:'SOFT', v:{sm:0.3, wh:0.2, con:1.05}},
        {id:'land', n:'é£æ™¯', t:'VIVID', v:{sat:1.2, con:1.1, boost:0.1}},
        {id:'arch', n:'å»ºç­‘', t:'HDR', v:{con:1.1, lft:{r:0.02,g:0.02,b:0.02}}},
        {id:'food', n:'ç¾é£Ÿ', t:'WARM', v:{sat:1.2, gam:{r:0.05}}},
        {id:'plant',n:'æ¤ç‰©', t:'FRESH', v:{sat:1.1, lft:{g:0.05}}},
        {id:'ani',  n:'åŠ¨ç‰©', t:'SHARP', v:{con:1.15, exp:0.05}},
        {id:'mov',  n:'ç”µå½±', t:'TEAL', v:{con:1.1, lft:{b:-0.1}, gan:{r:0.1}}}
    ];
    const presetsFilm = [
        {id:'fuji', n:'å¯Œå£«', t:'NC', v:{sat:1.1, lft:{b:0.08}}},
        {id:'kd',   n:'æŸ¯è¾¾', t:'GOLD', v:{sat:1.1, gam:{r:0.05,b:-0.05}}},
        {id:'leica',n:'å¾•å¡', t:'BW', v:{sat:0, con:1.3, lft:{r:-0.05,g:-0.05,b:-0.05}}},
        {id:'pana', n:'æ¾ä¸‹', t:'LOG', v:{con:0.9, sat:0.9}},
        {id:'sony', n:'ç´¢å°¼', t:'STD', v:{con:1.2}},
        {id:'canon',n:'ä½³èƒ½', t:'POR', v:{ros:0.1, sat:1.05}},
        {id:'nikon',n:'å°¼åº·', t:'NEU', v:{con:1.05, exp:0.05}},
        {id:'pen',  n:'å®¾å¾—', t:'SAT', v:{sat:1.3}},
        {id:'ric',  n:'ç†å…‰', t:'HI-C', v:{con:1.3, sat:0.8}},
        {id:'pol',  n:'æ‹ç«‹å¾—',t:'INS', v:{con:0.9, lft:{r:0.1}, exp:0.1}}
    ];

    const def = { 
        brt:0, exp:0, con:1, sat:1, hue:0, boost:0, cmp:0,
        sm:0, wh:0, ros:0, nz:0,
        lft:{r:0,g:0,b:0}, gam:{r:0,g:0,b:0}, gan:{r:0,g:0,b:0}, off:{r:0,g:0,b:0}
    };
    
    let st = JSON.parse(JSON.stringify(def));
    let gl, prog, tex, cvs = document.getElementById('gl');
    let actWheel = 'lift';

    // --- Init ---
    window.onload = () => {
        try{ gl=cvs.getContext('webgl',{preserveDrawingBuffer:true}); }catch(e){}
        if(!gl) return alert("WebGL Error");
        initGL();
        renderPresets();

        // Touch wheel logic
        const wd = document.getElementById('wheel');
        wd.addEventListener('touchstart', e=>handleWheel(e), {passive:false});
        wd.addEventListener('touchmove', e=>handleWheel(e), {passive:false});
        wd.addEventListener('dblclick', ()=>{ st[actWheel]={r:0,g:0,b:0}; updPuck(); draw(); });
        
        // Canvas Zoom
        const stage=document.getElementById('canvas-wrap');
        let zs=1, zd=0;
        document.getElementById('stage').addEventListener('touchmove',e=>{
            if(e.touches.length==2){
                e.preventDefault();
                const d=Math.hypot(e.touches[0].pageX-e.touches[1].pageX, e.touches[0].pageY-e.touches[1].pageY);
                if(zd>0) zs=Math.min(3, Math.max(0.8, zs*(d/zd)));
                stage.style.transform=`scale(${zs})`; zd=d;
            }
        },{passive:false});
        document.getElementById('stage').addEventListener('touchstart',e=>{if(e.touches.length==2)zd=Math.hypot(e.touches[0].pageX-e.touches[1].pageX, e.touches[0].pageY-e.touches[1].pageY);});
    }

    // --- Core Funcs ---
    function loadFile(el) {
        if(!el.files.length) return;
        const img = new Image();
        img.onload = () => {
            let w=img.width, h=img.height;
            const max=2048; if(w>max||h>max){const s=Math.min(max/w,max/h);w=Math.floor(w*s);h=Math.floor(h*s);}
            cvs.width=w; cvs.height=h;
            
            // Fix CSS Size
            const s=document.getElementById('stage');
            const r=Math.min((s.clientWidth-20)/w, (s.clientHeight-20)/h);
            cvs.style.width=(w*r)+'px'; cvs.style.height=(h*r)+'px';

            const c=document.createElement('canvas'); c.width=w; c.height=h; c.getContext('2d').drawImage(img,0,0,w,h);
            if(tex) gl.deleteTexture(tex);
            tex=gl.createTexture();
            gl.bindTexture(gl.TEXTURE_2D,tex);
            gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR);
            gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE);
            gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);
            gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,c);

            document.getElementById('empty-state').style.display='none';
            document.getElementById('canvas-wrap').style.display='block';
            document.getElementById('btn-comp').style.display='flex';
            resetAll(true);
        };
        img.src = URL.createObjectURL(el.files[0]);
    }

    function initGL(){
        const vs=gl.createShader(gl.VERTEX_SHADER); gl.shaderSource(vs,document.getElementById('vs').text); gl.compileShader(vs);
        const fs=gl.createShader(gl.FRAGMENT_SHADER); gl.shaderSource(fs,document.getElementById('fs').text); gl.compileShader(fs);
        prog=gl.createProgram(); gl.attachShader(prog,vs); gl.attachShader(prog,fs); gl.linkProgram(prog); gl.useProgram(prog);
        gl.bindBuffer(gl.ARRAY_BUFFER,gl.createBuffer()); gl.bufferData(gl.ARRAY_BUFFER,new Float32Array([-1,-1,0,1,1,-1,1,1,-1,1,0,0,-1,1,0,0,1,-1,1,1,1,1,1,0]),gl.STATIC_DRAW);
    }

    function draw(){
        if(!tex) return;
        gl.useProgram(prog); gl.viewport(0,0,cvs.width,cvs.height);
        const p=gl.getAttribLocation(prog,"p"); gl.enableVertexAttribArray(p); gl.vertexAttribPointer(p,2,gl.FLOAT,false,16,0);
        const u=gl.getAttribLocation(prog,"u"); gl.enableVertexAttribArray(u); gl.vertexAttribPointer(u,2,gl.FLOAT,false,16,8);
        
        const f=(k,v)=>gl.uniform1f(gl.getUniformLocation(prog,k),v);
        f("brt",st.brt); f("exp",st.exp); f("con",st.con); f("sat",st.sat); f("hue",st.hue); f("boost",st.boost); f("cmp",st.cmp);
        f("sm",st.sm); f("wh",st.wh); f("ros",st.ros); f("nz",st.nz);
        gl.uniform2f(gl.getUniformLocation(prog,"res"),cvs.width,cvs.height);
        
        const v3=(k,v)=>gl.uniform4f(gl.getUniformLocation(prog,k),v.r,v.g,v.b,0);
        v3("lft",st.lft); v3("gam",st.gam); v3("gan",st.gan); v3("off",st.off);
        
        gl.drawArrays(gl.TRIANGLES,0,6);
    }

    // --- Interaction ---
    window.nav = (id, el) => {
        document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
        document.getElementById('p-'+id).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
        el.classList.add('active');
    };

    window.u = (k, v) => { st[k]=parseFloat(v); document.getElementById('v-'+k).innerText=st[k]; draw(); };
    window.setCmp = (v) => { st.cmp=v; draw(); };

    window.setWheel = (w) => {
        actWheel=w; 
        document.querySelectorAll('.c-btn').forEach(b=>b.classList.remove('active'));
        document.getElementById('t-'+w).classList.add('active');
        updPuck();
    };

    function handleWheel(e) {
        e.preventDefault(); e.stopPropagation(); // Stop Scroll
        const rect=document.getElementById('wheel').getBoundingClientRect();
        const t=e.touches[0];
        const dx=(t.clientX-(rect.left+rect.width/2))/(rect.width/2);
        const dy=(t.clientY-(rect.top+rect.height/2))/(rect.height/2);
        const d=Math.sqrt(dx*dx+dy*dy);
        const nx=(d>1?dx/d:dx), ny=(d>1?dy/d:dy);
        
        st[actWheel].r = nx * 0.25; // Scale down for precision
        st[actWheel].b = -ny * 0.25; 
        updPuck(); draw();
    }
    
    function updPuck(){
        const x=(st[actWheel].r/0.25)*50, y=-(st[actWheel].b/0.25)*50;
        document.getElementById('puck').style.transform=`translate(calc(-50% + ${x}%), calc(-50% + ${y}%))`;
    }

    function renderPresets(){
        const mkChip=(p, c)=>'<div class="p-chip" onclick="applyPre(this,\''+p.id+'\', \''+c+'\')"><span class="p-name">'+p.n+'</span><span class="p-tag">'+p.t+'</span></div>';
        document.getElementById('grp-ai').innerHTML = presetsAI.map(p=>mkChip(p, 'ai')).join('');
        document.getElementById('grp-film').innerHTML = presetsFilm.map(p=>mkChip(p, 'film')).join('');
        document.querySelector('.p-chip').classList.add('active'); // Activate first
    }

    window.applyPre = (el, id, type) => {
        document.querySelectorAll('.p-chip').forEach(c=>c.classList.remove('active'));
        el.classList.add('active');
        const p = (type==='ai'?presetsAI:presetsFilm).find(x=>x.id===id);
        
        st = JSON.parse(JSON.stringify(def)); // Reset
        for(let k in p.v) st[k] = (typeof p.v[k]==='object') ? {...st[k], ...p.v[k]} : p.v[k];
        
        // Sync UI
        ['exp','con','sat','hue','boost','brt','sm','wh','ros','nz'].forEach(k=>{
            const i=document.getElementById('s-'+k); if(i){i.value=st[k]||0; document.getElementById('v-'+k).innerText=st[k]||0;}
        });
        updPuck(); draw();
    };

    window.resetAll = (full=true) => {
        if(full) applyPre(document.querySelector('.p-chip'), 'none', 'ai');
        else { st=JSON.parse(JSON.stringify(def)); draw(); }
    };
    
    window.exportImg = () => {
        if(!tex) return; draw();
        const a=document.createElement('a'); a.download='LUMINA_Mobile.jpg'; a.href=cvs.toDataURL('image/jpeg',0.95); a.click();
        const t=document.getElementById('toast'); t.style.opacity=1; setTimeout(()=>t.style.opacity=0, 2000);
    };
</script>
</body>
</html>
