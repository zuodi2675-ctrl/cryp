<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>LUMINA PWA v3.4</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#000000">

    <style>
        :root { --accent: #00e5ff; --bg: #000; --panel: #141414; --text: #eee; --safe-top: env(safe-area-inset-top); --safe-bottom: env(safe-area-inset-bottom); }
        * { box-sizing: border-box; user-select: none; outline: none; -webkit-tap-highlight-color: transparent; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        body { margin: 0; background: var(--bg); color: var(--text); height: 100vh; width: 100vw; overflow: hidden; display: flex; flex-direction: column; }

        /* --- é¡¶éƒ¨æ  --- */
        .top-bar {
            height: calc(50px + var(--safe-top)); padding-top: var(--safe-top);
            display: flex; justify-content: space-between; align-items: center; padding: var(--safe-top) 15px 0 15px;
            background: linear-gradient(to bottom, rgba(0,0,0,0.9), transparent); 
            z-index: 200; position: absolute; top:0; left:0; right:0; pointer-events: none;
        }
        .top-btn { 
            pointer-events: auto; background: rgba(30,30,30,0.6); backdrop-filter: blur(10px); 
            width: 40px; height: 40px; border-radius: 50%; display: flex; justify-content: center; align-items: center; 
            font-size: 18px; border: 1px solid rgba(255,255,255,0.1); cursor: pointer; transition: 0.2s;
        }
        .top-btn:active { transform: scale(0.9); background: rgba(255,255,255,0.2); }

        /* --- èˆå°åŒºåŸŸ (å®Œç¾æ¯”ä¾‹é€‚é…æ–¹æ¡ˆ) --- */
        .stage-area { 
            flex: 1; position: relative; background: #000; overflow: hidden; 
            display: flex; justify-content: center; align-items: center;
        }
        
        /* å®¹å™¨ï¼šè´Ÿè´£æ˜¾ç¤ºå°ºå¯¸ (CSS pixels) */
        #canvas-wrap { 
            box-shadow: 0 0 50px rgba(0,0,0,0.8); 
            display: none; 
            transform-origin: center center; 
            position: relative; /* ç¡®ä¿åœ¨æµä¸­æ­£ç¡®å®šä½ */
        }
        
        /* ç”»å¸ƒï¼šè´Ÿè´£çœŸå®åˆ†è¾¨ç‡ (Physical pixels) */
        canvas { 
            display: block; 
            width: 100%; height: 100%; /* æ’‘æ»¡å®¹å™¨ */
            pointer-events: none; 
        }
        
        #empty-state { position: absolute; inset: 0; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 50; pointer-events: auto; }
        .add-icon { font-size: 40px; color: #333; margin-bottom: 10px; width: 80px; height: 80px; border: 2px dashed #333; border-radius: 50%; display: flex; justify-content: center; align-items: center; }

        /* --- æµ®åŠ¨æŒ‰é’® --- */
        .float-btns { position: absolute; bottom: 230px; right: 15px; display: none; flex-direction: column; gap: 15px; z-index: 150; }
        .fab {
            width: 44px; height: 44px; background: rgba(20,20,20,0.85); 
            border-radius: 50%; display: flex; justify-content: center; align-items: center; 
            font-size: 18px; backdrop-filter: blur(5px); border: 1px solid #444; 
            transition: 0.2s; color: #aaa; box-shadow: 0 4px 10px rgba(0,0,0,0.5); pointer-events: auto;
        }
        .fab:active { transform: scale(0.9); }
        .fab.active { color: #000; background: var(--accent); border-color: var(--accent); box-shadow: 0 0 15px rgba(0,229,255,0.4); }

        /* --- å¯¹æ¯”åˆ†å‰²çº¿ --- */
        #compare-overlay { position: absolute; inset: 0; pointer-events: none; display: none; z-index: 10; }
        .split-line { 
            position: absolute; top: 0; bottom: 0; width: 2px; background: #fff; left: 50%; 
            box-shadow: 0 0 10px rgba(0,0,0,0.5); cursor: ew-resize; pointer-events: auto;
        }
        .split-handle {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 32px; height: 32px; background: rgba(0,0,0,0.8); border: 2px solid #fff; border-radius: 50%;
            display: flex; justify-content: center; align-items: center; font-size: 14px;
        }

        /* --- æ§åˆ¶é¢æ¿ --- */
        .controls { 
            background: var(--panel); border-top-left-radius: 20px; border-top-right-radius: 20px;
            padding-bottom: var(--safe-bottom); position: relative; z-index: 100;
            display: flex; flex-direction: column; border-top: 1px solid #222;
        }
        .nav-bar { display: flex; justify-content: space-around; height: 60px; align-items: center; border-bottom: 1px solid #222; flex-shrink: 0; }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; opacity: 0.4; height: 100%; gap: 4px; transition: 0.2s; }
        .nav-item.active { opacity: 1; color: var(--accent); }
        .nav-lbl { font-size: 10px; font-weight: 600; }

        .panel-container { height: 220px; position: relative; overflow: hidden; }
        .panel { position: absolute; inset: 0; display: none; flex-direction: column; padding: 15px; overflow-y: auto; -webkit-overflow-scrolling: touch; }
        .panel.active { display: flex; }

        .group-title { font-size: 11px; color: var(--accent); font-weight: 900; margin: 15px 0 8px 5px; border-left: 3px solid var(--accent); padding-left: 8px; }
        .preset-row { display: flex; flex-wrap: wrap; gap: 8px; padding-bottom: 10px; }
        .p-chip { 
            width: calc(25% - 6px); aspect-ratio: 0.8; background: #222; border-radius: 6px; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            border: 1px solid #333; position: relative; overflow: hidden; transition: 0.1s;
        }
        .p-chip.active { background: #222; border-color: var(--accent); box-shadow: inset 0 0 0 1px var(--accent); }
        .p-name { color: #fff; font-size: 11px; font-weight: bold; margin-bottom: 2px; text-align: center; }
        .p-tag { font-size: 9px; color: #666; background: #111; padding: 1px 4px; border-radius: 2px; }

        .slider-row { margin-bottom: 20px; padding: 0 5px; }
        .sl-head { display: flex; justify-content: space-between; font-size: 12px; color: #ccc; margin-bottom: 8px; }
        .sl-val { color: var(--accent); font-family: monospace; }
        input[type=range] { width: 100%; background: transparent; height: 30px; -webkit-appearance: none; margin:0; touch-action: none; display: block; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 3px; background: #333; border-radius: 2px; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 20px; width: 20px; border-radius: 50%; background: #fff; margin-top: -9px; box-shadow: 0 2px 5px rgba(0,0,0,0.5); border: 2px solid var(--bg); transform: scale(1); transition: 0.1s; }
        input[type=range]:active::-webkit-slider-thumb { transform: scale(1.3); background: var(--accent); }

        /* è‰²è½®ä¿®å¤ */
        .col-tabs { display: flex; justify-content: space-between; gap: 5px; margin-bottom: 10px; flex-shrink: 0; }
        .c-btn { flex:1; font-size: 11px; color: #666; padding: 6px 0; border-radius: 4px; text-align: center; background: #181818; border: 1px solid #222; }
        .c-btn.active { color: #000; background: var(--accent); border-color: var(--accent); font-weight: bold; }

        .wheel-layout { display: flex; height: 140px; gap: 15px; width: 100%; touch-action: none; }
        .wheel-box { 
            flex: 0 0 140px; height: 140px; position: relative; 
            background: #111; border-radius: 8px; border: 1px solid #333; 
            display: flex; justify-content: center; align-items: center;
            touch-action: none; user-select: none;
        }
        .wheel-disk { width: 120px; height: 120px; border-radius: 50%; border: 2px solid #444; position: relative; pointer-events: none; }
        .wheel-grad { position: absolute; inset: 2px; border-radius: 50%; background: conic-gradient(red, magenta, blue, cyan, lime, yellow, red); opacity: 0.7; }
        .wheel-puck { width: 16px; height: 16px; border: 2px solid #fff; background: rgba(0,0,0,0.5); border-radius: 50%; position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%); box-shadow: 0 0 5px #000; }
        
        .gears-box { 
            flex: 1; display: flex; justify-content: space-between; align-items: center; 
            background: #111; border-radius: 8px; border: 1px solid #333; padding: 5px;
            touch-action: none; 
        }
        .gear-col { flex: 1; display: flex; flex-direction: column; align-items: center; height: 100%; justify-content: center; gap:4px; }
        .gear-track { 
            width: 80%; height: 100px; background: #181818; border: 1px solid #333; border-radius: 4px; position: relative; overflow: hidden; 
            background-image: repeating-linear-gradient(0deg, transparent, transparent 4px, #222 4px, #222 5px);
            touch-action: none;
        }
        .gear-mid { position: absolute; top: 50%; width: 100%; height: 1px; background: #555; pointer-events: none; }
        .gear-fill { position: absolute; top: 50%; left: 0; right: 0; background: currentColor; opacity: 0.7; transition: 0.1s; pointer-events: none; height: 0%; }
        .gear-lbl { font-size: 9px; font-weight: bold; color: #555; }
        .c-r { color: #ff4444; } .c-g { color: #44ff44; } .c-b { color: #4444ff; } .c-y { color: #ffffff; }

        #toast { position: fixed; top: 50%; left: 50%; transform: translate(-50%,-50%); background: rgba(0,0,0,0.8); color: #fff; padding: 10px 20px; border-radius: 20px; opacity: 0; pointer-events: none; transition: 0.3s; z-index: 999; }
    </style>
</head>
<body>

<div id="toast">âœ… å·²ä¿å­˜åˆ°ç›¸å†Œ</div>
<input type="file" id="fileInput" accept="image/*" style="display:none" onchange="loadFile(this)">

<div class="top-bar">
    <div class="top-btn" onclick="document.getElementById('fileInput').click()">ğŸ“‚</div>
    <div style="font-weight:900; font-style:italic;">LUMINA <span style="color:var(--accent)">PWA</span></div>
    <div class="top-btn" onclick="exportImg()">ğŸ’¾</div>
</div>

<main class="stage-area" id="stage-area">
    <div id="empty-state" onclick="document.getElementById('fileInput').click()">
        <div class="add-icon">ï¼‹</div><div style="font-size:12px;color:#666">æ‰“å¼€ç…§ç‰‡</div>
    </div>
    
    <div id="canvas-wrap">
        <canvas id="gl"></canvas>
        <div id="compare-overlay">
            <div class="split-line" id="split-line">
                <div class="split-handle">â¬Œ</div>
            </div>
        </div>
    </div>

    <div class="float-btns" id="float-btns">
        <div class="fab" onclick="resetAll(false)">â†º</div>
        <div class="fab" id="btn-comp" onclick="toggleCompare()">ğŸ‘</div>
    </div>
</main>

<div class="controls">
    <div class="panel-container">
        <div class="panel active" id="p-pre">
            <div class="group-title">æ™ºèƒ½åœºæ™¯ AI</div>
            <div class="preset-row" id="grp-ai"></div>
            <div class="group-title">ç»å…¸èƒ¶ç‰‡ FILM</div>
            <div class="preset-row" id="grp-film"></div>
        </div>

        <div class="panel" id="p-adj">
            <div class="slider-row"><div class="sl-head"><span>æ›å…‰</span><span class="sl-val" id="v-exp">0</span></div><input type="range" id="s-exp" min="-2" max="2" step="0.01" value="0" oninput="u('exp',this.value)"></div>
            <div class="slider-row"><div class="sl-head"><span>å¯¹æ¯”åº¦</span><span class="sl-val" id="v-con">1.0</span></div><input type="range" id="s-con" min="0" max="2" step="0.01" value="1" oninput="u('con',this.value)"></div>
            <div class="slider-row"><div class="sl-head"><span>é¥±å’Œåº¦</span><span class="sl-val" id="v-sat">1.0</span></div><input type="range" id="s-sat" min="0" max="2" step="0.01" value="1" oninput="u('sat',this.value)"></div>
            <div class="slider-row"><div class="sl-head"><span>è‰²ç›¸</span><span class="sl-val" id="v-hue">0</span></div><input type="range" id="s-hue" min="-0.5" max="0.5" step="0.01" value="0" oninput="u('hue',this.value)"></div>
            <div class="slider-row"><div class="sl-head"><span>é˜´å½±</span><span class="sl-val" id="v-shadows">0</span></div><input type="range" id="s-shadows" min="-1" max="1" step="0.01" value="0" oninput="u('shadows',this.value)"></div>
            <div class="slider-row"><div class="sl-head"><span>é«˜å…‰</span><span class="sl-val" id="v-highlights">0</span></div><input type="range" id="s-highlights" min="-1" max="1" step="0.01" value="0" oninput="u('highlights',this.value)"></div>
            <div class="slider-row"><div class="sl-head"><span>æ°›å›´å¢å¼º</span><span class="sl-val" id="v-boost">0</span></div><input type="range" id="s-boost" min="0" max="1" step="0.01" value="0" oninput="u('boost',this.value)"></div>
        </div>

        <div class="panel" id="p-col">
            <div class="col-tabs">
                <div class="c-btn active" onclick="setWheelTab('lft')" id="t-lft">æš—éƒ¨</div>
                <div class="c-btn" onclick="setWheelTab('gam')" id="t-gam">ä¸­ç°</div>
                <div class="c-btn" onclick="setWheelTab('gan')" id="t-gan">äº®éƒ¨</div>
                <div class="c-btn" onclick="setWheelTab('off')" id="t-off">åç§»</div>
            </div>
            
            <div class="wheel-layout">
                <div class="wheel-box" id="wheel-touch-zone">
                    <div class="wheel-disk">
                        <div class="wheel-grad"></div>
                        <div class="wheel-puck" id="wheel-puck"></div>
                    </div>
                </div>
                <div class="gears-box">
                    <div class="gear-col"><div class="gear-lbl">R</div><div class="gear-track" id="gt-r"><div class="gear-mid"></div><div class="gear-fill c-r" id="gf-r"></div></div></div>
                    <div class="gear-col"><div class="gear-lbl">G</div><div class="gear-track" id="gt-g"><div class="gear-mid"></div><div class="gear-fill c-g" id="gf-g"></div></div></div>
                    <div class="gear-col"><div class="gear-lbl">B</div><div class="gear-track" id="gt-b"><div class="gear-mid"></div><div class="gear-fill c-b" id="gf-b"></div></div></div>
                    <div class="gear-col"><div class="gear-lbl">Y</div><div class="gear-track" id="gt-y"><div class="gear-mid"></div><div class="gear-fill c-y" id="gf-y"></div></div></div>
                </div>
            </div>
            <div style="text-align:center; font-size:9px; color:#555; margin-top:5px;">* åŒå‡»è‰²ç›˜é‡ç½®å½“å‰é€šé“</div>
        </div>

        <div class="panel" id="p-por">
            <div class="slider-row"><div class="sl-head"><span>æ™ºèƒ½é™å™ª</span><span class="sl-val" id="v-nz">0</span></div><input type="range" id="s-nz" min="0" max="1" step="0.01" value="0" oninput="u('nz',this.value)"></div>
            <div class="slider-row"><div class="sl-head"><span>ç£¨çš®</span><span class="sl-val" id="v-sm">0</span></div><input type="range" id="s-sm" min="0" max="1" step="0.01" value="0" oninput="u('sm',this.value)"></div>
            <div class="slider-row"><div class="sl-head"><span>ç¾ç™½</span><span class="sl-val" id="v-wh">0</span></div><input type="range" id="s-wh" min="0" max="1" step="0.01" value="0" oninput="u('wh',this.value)"></div>
            <div class="slider-row"><div class="sl-head"><span>çº¢æ¶¦</span><span class="sl-val" id="v-ros">0</span></div><input type="range" id="s-ros" min="0" max="1" step="0.01" value="0" oninput="u('ros',this.value)"></div>
        </div>
    </div>

    <div class="nav-bar">
        <div class="nav-item active" onclick="nav('pre',this)"><div style="font-size:20px">ğŸï¸</div><span class="nav-lbl">æ»¤é•œ</span></div>
        <div class="nav-item" onclick="nav('adj',this)"><div style="font-size:20px">ğŸšï¸</div><span class="nav-lbl">å…‰æ•ˆ</span></div>
        <div class="nav-item" onclick="nav('col',this)"><div style="font-size:20px">ğŸ¨</div><span class="nav-lbl">è‰²è½®</span></div>
        <div class="nav-item" onclick="nav('por',this)"><div style="font-size:20px">ğŸ‘¤</div><span class="nav-lbl">äººåƒ</span></div>
    </div>
</div>

<script id="vs" type="x-shader/x-vertex">
    attribute vec2 p; attribute vec2 u; varying vec2 v; void main(){gl_Position=vec4(p,0,1);v=u;}
</script>
<script id="fs" type="x-shader/x-fragment">
    precision mediump float; uniform sampler2D t; varying vec2 v; uniform vec2 res;
    uniform float brt,exp,con,sat,hue,boost,shadows,highlights,sm,wh,ros,nz;
    uniform float cmp, splitPos; 
    uniform vec4 lft,gam,gan,off;
    const vec3 W = vec3(0.299, 0.587, 0.114);
    
    vec3 satf(vec3 c, float s) { float g=dot(c,W); return mix(vec3(g),c,s); }
    vec3 rgb2hsv(vec3 c){vec4 K=vec4(0.,-1./3.,2./3.,-1.);vec4 p=mix(vec4(c.bg,K.wz),vec4(c.gb,K.xy),step(c.b,c.g));vec4 q=mix(vec4(p.xyw,c.r),vec4(c.r,p.yzx),step(p.x,c.r));float d=q.x-min(q.w,q.y);float e=1.0e-10;return vec3(abs(q.z+(q.w-q.y)/(6.*d+e)),d/(q.x+e),q.x);}
    vec3 hsv2rgb(vec3 c){vec4 K=vec4(1.,2./3.,1./3.,3.);vec3 p=abs(fract(c.xxx+K.xyz)*6.-K.www);return c.z*mix(K.xxx,clamp(p-K.xxx,0.,1.),c.y);}
    vec3 denoise(vec3 c, vec2 uv, float s) {
        if(s <= 0.0) return c; vec2 d = vec2(1.5)/res;
        vec3 acc = c;
        acc += texture2D(t, uv+vec2(d.x,0.0)).rgb; acc += texture2D(t, uv-vec2(d.x,0.0)).rgb;
        acc += texture2D(t, uv+vec2(0.0,d.y)).rgb; acc += texture2D(t, uv-vec2(0.0,d.y)).rgb;
        return mix(c, acc*0.2, s);
    }

    void main(){
        vec4 px = texture2D(t, v);
        vec3 raw = px.rgb;
        if(cmp > 0.5 && v.x > splitPos) { gl_FragColor = vec4(raw, px.a); return; }

        vec3 c = raw;
        if(nz > 0.0) c = denoise(c, v, nz);
        if(sm > 0.0) {
            vec2 d = vec2(2.0)/res; vec3 b = texture2D(t,v+d).rgb + texture2D(t,v-d).rgb;
            float isSkin = (c.r > c.g && c.g > c.b) ? 1.0 : 0.0;
            c = mix(c, b*0.5, sm * isSkin * 0.7);
        }
        if(wh > 0.0 && c.r > c.g && c.g > c.b) c = mix(c, pow(c, vec3(1.0 - wh*0.2)), 0.6);
        if(ros > 0.0 && c.r > c.g && c.g > c.b) c.r += ros * 0.06;

        if(abs(hue)>0.001){ vec3 h=rgb2hsv(c); h.x+=hue; c=hsv2rgb(h); }
        c += brt; c *= pow(2.0, exp); c = 0.5 + (c - 0.5) * con; c = satf(c, sat); c = satf(c, 1.0 + boost);

        float lum = dot(c, W);
        c += shadows * (1.0 - smoothstep(0.0, 0.5, lum)) * 0.2;
        c -= highlights * smoothstep(0.5, 1.0, lum) * 0.2;

        vec3 L = lft.rgb + lft.w; vec3 G = 1.0 / (1.0 + gam.rgb + gam.w); vec3 A = 1.0 + gan.rgb + gan.w; vec3 O = off.rgb + off.w;
        c = (c + L * 0.2) * A; c = pow(max(vec3(0.0), c), G); c += O * 0.2;

        gl_FragColor = vec4(c, px.a);
    }
</script>

<script>
    const presetsAI=[{id:'none',n:'åŸå§‹',t:'RAW',v:{}},{id:'port',n:'äººåƒ',t:'SOFT',v:{sm:0.3,wh:0.2,con:1.05}},{id:'land',n:'é£æ™¯',t:'VIVID',v:{sat:1.2,con:1.1,boost:0.1}},{id:'arch',n:'å»ºç­‘',t:'HDR',v:{con:1.1,shadows:0.2,highlights:0.3}},{id:'food',n:'ç¾é£Ÿ',t:'WARM',v:{sat:1.2,gam:{r:0.05,w:0}}},{id:'plant',n:'æ¤ç‰©',t:'FRESH',v:{sat:1.1,lft:{g:0.05,w:0}}},{id:'ani',n:'åŠ¨ç‰©',t:'SHARP',v:{con:1.15,exp:0.05}},{id:'mov',n:'ç”µå½±',t:'TEAL',v:{con:1.1,lft:{b:-0.1,w:0},gan:{r:0.1,w:0}}}];
    const presetsFilm=[{id:'fuji',n:'å¯Œå£«',t:'NC',v:{sat:1.1,lft:{b:0.08,w:0}}},{id:'kd',n:'æŸ¯è¾¾',t:'GOLD',v:{sat:1.1,gam:{r:0.05,b:-0.05,w:0}}},{id:'leica',n:'å¾•å¡',t:'BW',v:{sat:0,con:1.3,lft:{r:-0.05,g:-0.05,b:-0.05,w:0}}},{id:'pana',n:'æ¾ä¸‹',t:'LOG',v:{con:0.9,sat:0.9}},{id:'sony',n:'ç´¢å°¼',t:'STD',v:{con:1.2}},{id:'canon',n:'ä½³èƒ½',t:'POR',v:{ros:0.1,sat:1.05}},{id:'nikon',n:'å°¼åº·',t:'NEU',v:{con:1.05,exp:0.05}},{id:'pen',n:'å®¾å¾—',t:'SAT',v:{sat:1.3}},{id:'ric',n:'ç†å…‰',t:'HI-C',v:{con:1.3,sat:0.8}},{id:'pol',n:'æ‹ç«‹å¾—',t:'INS',v:{con:0.9,lft:{r:0.1,w:0},exp:0.1}}];

    const def={brt:0,exp:0,con:1,sat:1,hue:0,boost:0,shadows:0,highlights:0,sm:0,wh:0,ros:0,nz:0,cmp:0,splitPos:0.5,lft:{r:0,g:0,b:0,w:0},gam:{r:0,g:0,b:0,w:0},gan:{r:0,g:0,b:0,w:0},off:{r:0,g:0,b:0,w:0}};
    let st=JSON.parse(JSON.stringify(def));
    let gl, prog, tex, cvs=document.getElementById('gl'), actWheel='lft';
    let state={zoom:1,panX:0,panY:0,lastDist:0,isDragging:false,startX:0,startY:0};

    window.onload=()=>{
        try{gl=cvs.getContext('webgl',{preserveDrawingBuffer:true});}catch(e){}
        if(!gl)return alert("WebGL Error");
        initGL(); renderPresets(); initGestures(); initWheelUI(); initSplitDrag();
    }

    function loadFile(el){
        if(!el.files.length)return;
        const img=new Image();
        img.onload=()=>{
            let w=img.width, h=img.height;
            const max=4096;
            if(w>max||h>max){const s=Math.min(max/w,max/h);w=Math.floor(w*s);h=Math.floor(h*s);}
            
            // ä¿®å¤1ï¼šCanvas åˆ†è¾¨ç‡è®¾ç½®
            cvs.width=w; cvs.height=h;
            
            // ä¿®å¤2ï¼šå®¹å™¨å°ºå¯¸è®¡ç®— (Fit to Screen)
            const area=document.getElementById('stage-area');
            const padding=40;
            const mw = area.clientWidth - padding;
            const mh = area.clientHeight - padding;
            
            // è®¡ç®—é€‚é…æ¯”ä¾‹
            let ratio = Math.min(mw / w, mh / h);
            
            // è®¾ç½®å®¹å™¨æ˜¾ç¤ºå°ºå¯¸ï¼ˆCSS Pixelï¼‰
            const cssW = w * ratio;
            const cssH = h * ratio;
            
            const wrap=document.getElementById('canvas-wrap');
            wrap.style.width = cssW + 'px';
            wrap.style.height = cssH + 'px';
            wrap.style.display = 'block';

            const c=document.createElement('canvas');c.width=w;c.height=h;c.getContext('2d').drawImage(img,0,0,w,h);
            if(tex)gl.deleteTexture(tex); tex=gl.createTexture();
            gl.bindTexture(gl.TEXTURE_2D,tex);
            gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR);
            gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE);
            gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);
            gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,c);

            document.getElementById('empty-state').style.display='none';
            
            // é‡ç½®ç¼©æ”¾
            state.zoom=1; state.panX=0; state.panY=0;
            updateTransform();

            document.getElementById('float-btns').style.display='flex';
            resetAll(true);
            requestAnimationFrame(()=>{gl.viewport(0,0,w,h);draw();});
        };
        img.src=URL.createObjectURL(el.files[0]);
    }

    function initGL(){
        const vs=gl.createShader(gl.VERTEX_SHADER);gl.shaderSource(vs,document.getElementById('vs').text);gl.compileShader(vs);
        const fs=gl.createShader(gl.FRAGMENT_SHADER);gl.shaderSource(fs,document.getElementById('fs').text);gl.compileShader(fs);
        prog=gl.createProgram();gl.attachShader(prog,vs);gl.attachShader(prog,fs);gl.linkProgram(prog);gl.useProgram(prog);
        gl.bindBuffer(gl.ARRAY_BUFFER,gl.createBuffer());gl.bufferData(gl.ARRAY_BUFFER,new Float32Array([-1,-1,0,1,1,-1,1,1,-1,1,0,0,-1,1,0,0,1,-1,1,1,1,1,1,0]),gl.STATIC_DRAW);
    }

    function draw(){
        if(!tex)return; gl.useProgram(prog); 
        const f=(k,v)=>gl.uniform1f(gl.getUniformLocation(prog,k),v);
        f("brt",st.brt);f("exp",st.exp);f("con",st.con);f("sat",st.sat);f("hue",st.hue);f("boost",st.boost);f("shadows",st.shadows);f("highlights",st.highlights);
        f("sm",st.sm);f("wh",st.wh);f("ros",st.ros);f("nz",st.nz);f("cmp",st.cmp);f("splitPos",st.splitPos);
        gl.uniform2f(gl.getUniformLocation(prog,"res"),cvs.width,cvs.height);
        const v4=(k,v)=>gl.uniform4f(gl.getUniformLocation(prog,k),v.r,v.g,v.b,v.w);
        v4("lft",st.lft);v4("gam",st.gam);v4("gan",st.gan);v4("off",st.off);
        const p=gl.getAttribLocation(prog,"p");gl.enableVertexAttribArray(p);gl.vertexAttribPointer(p,2,gl.FLOAT,false,16,0);
        const u=gl.getAttribLocation(prog,"u");gl.enableVertexAttribArray(u);gl.vertexAttribPointer(u,2,gl.FLOAT,false,16,8);
        gl.drawArrays(gl.TRIANGLES,0,6);
    }

    function initGestures(){
        const area=document.getElementById('stage-area');
        area.addEventListener('touchstart',e=>{
            if(e.touches.length===1&&!st.cmp){state.isDragging=true;state.startX=e.touches[0].clientX-state.panX;state.startY=e.touches[0].clientY-state.panY;}
            else if(e.touches.length===2){state.isDragging=false;state.lastDist=Math.hypot(e.touches[0].clientX-e.touches[1].clientX,e.touches[0].clientY-e.touches[1].clientY);}
        },{passive:false});
        area.addEventListener('touchmove',e=>{
            if(!tex)return; e.preventDefault();
            if(e.touches.length===1&&state.isDragging&&!st.cmp){state.panX=e.touches[0].clientX-state.startX;state.panY=e.touches[0].clientY-state.startY;updateTransform();}
            else if(e.touches.length===2){const dist=Math.hypot(e.touches[0].clientX-e.touches[1].clientX,e.touches[0].clientY-e.touches[1].clientY);if(dist>0&&state.lastDist>0){state.zoom*=dist/state.lastDist;state.zoom=Math.max(0.1,Math.min(5,state.zoom));updateTransform();}state.lastDist=dist;}
        },{passive:false});
        area.addEventListener('touchend',()=>{state.isDragging=false;});
    }

    function updateTransform(){document.getElementById('canvas-wrap').style.transform=`translate(${state.panX}px,${state.panY}px) scale(${state.zoom})`;}

    // ä¿®å¤3ï¼šè‰²è½®æ˜ å°„ (é”®åå¯¹é½)
    function initWheelUI(){
        const zone=document.getElementById('wheel-touch-zone');
        const disk=document.querySelector('.wheel-disk');
        
        const hW=(e)=>{
            e.preventDefault(); e.stopPropagation();
            const rect=disk.getBoundingClientRect();
            const t=e.touches[0]||e;
            let dx=(t.clientX-(rect.left+rect.width/2))/(rect.width/2);
            let dy=(t.clientY-(rect.top+rect.height/2))/(rect.height/2);
            const dist=Math.sqrt(dx*dx+dy*dy);if(dist>1){dx/=dist;dy/=dist;}
            
            // ç¡®ä¿ actWheel å¯¹åº”çš„å¯¹è±¡å­˜åœ¨
            if(st[actWheel]){
                st[actWheel].r=dx*0.25;
                st[actWheel].b=-dy*0.25;
                updV();draw();
            }
        };

        zone.addEventListener('touchstart',hW,{passive:false});
        zone.addEventListener('touchmove',hW,{passive:false});
        zone.addEventListener('dblclick',()=>{if(st[actWheel]){st[actWheel].r=0;st[actWheel].b=0;updV();draw();}});

        ['r','g','b','y'].forEach(ch=>{
            const track=document.getElementById('gt-'+ch);let sY=0,sV=0;
            track.addEventListener('touchstart',e=>{sY=e.touches[0].clientY;sV=st[actWheel][ch=='y'?'w':ch];e.stopPropagation();},{passive:false});
            track.addEventListener('touchmove',e=>{const dy=sY-e.touches[0].clientY;let val=sV+dy*0.005;val=Math.max(-0.5,Math.min(0.5,val));st[actWheel][ch=='y'?'w':ch]=val;updV();draw();e.preventDefault();e.stopPropagation();},{passive:false});
        });
    }

    // ä¿®å¤4ï¼šä¿®æ­£Tab IDä¼ å‚ï¼Œç¡®ä¿ä¸æ•°æ®é”®åä¸€è‡´ (lft, gam, gan, off)
    window.setWheelTab=(w)=>{
        actWheel=w;
        document.querySelectorAll('.c-btn').forEach(b=>b.classList.remove('active'));
        document.getElementById('t-'+w).classList.add('active');
        updV();
    }
    
    function updV(){
        if(!st[actWheel]) return;
        const x=(st[actWheel].r/0.25)*50,y=-(st[actWheel].b/0.25)*50;
        document.getElementById('wheel-puck').style.transform=`translate(calc(-50% + ${x}%),calc(-50% + ${y}%))`;
        const map={r:'r',g:'g',b:'b',y:'w'};
        for(let k in map){const val=st[actWheel][map[k]],h=Math.abs(val)*200,el=document.getElementById('gf-'+k);el.style.height=Math.min(50,h)+'%';el.style.top=(val>0?(50-Math.min(50,h)):50)+'%';}
    }

    window.toggleCompare=()=>{if(!tex)return;st.cmp=st.cmp?0:1;const b=document.getElementById('btn-comp'),o=document.getElementById('compare-overlay');if(st.cmp){b.classList.add('active');o.style.display='block';st.splitPos=0.5;document.getElementById('split-line').style.left='50%';}else{b.classList.remove('active');o.style.display='none';}draw();}
    function initSplitDrag(){
        const ov=document.getElementById('compare-overlay'),l=document.getElementById('split-line');
        ov.addEventListener('touchstart',e=>{if(!st.cmp)return;e.preventDefault();e.stopPropagation();},{passive:false});
        ov.addEventListener('touchmove',e=>{if(!st.cmp)return;e.preventDefault();e.stopPropagation();const r=ov.getBoundingClientRect();let x=e.touches[0].clientX-r.left;x=Math.max(0,Math.min(r.width,x));const pct=x/r.width;st.splitPos=pct;l.style.left=(pct*100)+'%';draw();},{passive:false});
    }

    window.nav=(id,el)=>{document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));document.getElementById('p-'+id).classList.add('active');document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));el.classList.add('active');};
    window.u=(k,v)=>{st[k]=parseFloat(v);document.getElementById('v-'+k).innerText=st[k];draw();};
    function renderPresets(){
        const mk=(p,c)=>'<div class="p-chip" onclick="applyPre(this,\''+p.id+'\',\''+c+'\')"><span class="p-name">'+p.n+'</span><span class="p-tag">'+p.t+'</span></div>';
        document.getElementById('grp-ai').innerHTML=presetsAI.map(p=>mk(p,'ai')).join('');
        document.getElementById('grp-film').innerHTML=presetsFilm.map(p=>mk(p,'film')).join('');
        document.querySelector('.p-chip').classList.add('active');
    }
    window.applyPre=(el,id,type)=>{
        document.querySelectorAll('.p-chip').forEach(c=>c.classList.remove('active'));el.classList.add('active');
        const p=(type==='ai'?presetsAI:presetsFilm).find(x=>x.id===id);
        st=JSON.parse(JSON.stringify(def));
        for(let k in p.v){if(typeof p.v[k]==='object'&&!Array.isArray(p.v[k]))st[k]={...st[k],...p.v[k]};else st[k]=p.v[k];}
        syncUI(); updV(); draw();
    };
    function syncUI(){
        ['exp','con','sat','hue','boost','brt','shadows','highlights','sm','wh','ros','nz'].forEach(k=>{const i=document.getElementById('s-'+k);if(i){i.value=st[k]||0;document.getElementById('v-'+k).innerText=st[k]||0;}});
    }
    window.resetAll=(isInit=false)=>{
        if(!isInit) { st=JSON.parse(JSON.stringify(def)); syncUI(); updV(); draw(); document.querySelectorAll('.p-chip').forEach(c=>c.classList.remove('active')); document.querySelector('.p-chip').classList.add('active'); }
        else { applyPre(document.querySelector('.p-chip'),'none','ai'); }
    };
    window.exportImg=()=>{if(!tex)return;const o=st.cmp;st.cmp=0;draw();const a=document.createElement('a');a.download='LUMINA_Edit.jpg';a.href=cvs.toDataURL('image/jpeg',0.95);a.click();const t=document.getElementById('toast');t.style.opacity=1;setTimeout(()=>t.style.opacity=0,2000);st.cmp=o;draw();};
</script>
</body>
</html>
