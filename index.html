<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>加密货币实时价格与分析</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117;
            color: #c9d1d9;
        }
        .container {
            max-width: 900px;
        }
        .price-card {
            min-width: 200px;
        }
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #3498db;
            width: 30px;
            height: 30px;
            -webkit-animation: spin 1s linear infinite; /* Safari */
            animation: spin 1s linear infinite;
        }
        /* Safari */
        @-webkit-keyframes spin {
            0% { -webkit-transform: rotate(0deg); }
            100% { -webkit-transform: rotate(360deg); }
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .modal {
            transition: opacity 0.3s ease-in-out;
        }
    </style>
</head>
<body class="p-4">

    <!-- 主容器 -->
    <div class="container mx-auto p-6 bg-gray-800 rounded-2xl shadow-xl">
        <h1 class="text-3xl font-bold text-center mb-8 text-white">实时加密货币价格</h1>

        <!-- 实时价格展示区 -->
        <div id="price-display" class="flex flex-col gap-6 mb-8">
            <!-- BTC 价格卡片 -->
            <div id="btc-card" class="price-card p-6 bg-gray-700 rounded-xl shadow-lg transition-transform transform hover:scale-105" data-symbol="BTC">
                <h2 class="text-xl font-semibold mb-2 text-blue-400">BTC/USDT</h2>
                <div class="flex items-center justify-between">
                    <p class="flex items-center text-4xl font-bold text-white">
                        <span id="btc-price">-</span>
                        <span id="btc-trend-indicator" class="ml-2 text-2xl font-bold"></span>
                    </p>
                    <div class="flex flex-col space-y-2">
                         <button id="btc-analyze-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-full shadow-lg transition-colors duration-300 whitespace-nowrap">
                            AI 交易分析
                        </button>
                    </div>
                </div>
                <div class="mt-4 text-center">
                    <button class="alert-btn bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-semibold py-2 px-4 rounded-full text-sm transition-colors duration-300">设置提醒</button>
                </div>
            </div>
            <!-- ETH 价格卡片 -->
            <div id="eth-card" class="price-card p-6 bg-gray-700 rounded-xl shadow-lg transition-transform transform hover:scale-105" data-symbol="ETH">
                <h2 class="text-xl font-semibold mb-2 text-purple-400">ETH/USDT</h2>
                <div class="flex items-center justify-between">
                    <p class="flex items-center text-4xl font-bold text-white">
                        <span id="eth-price">-</span>
                        <span id="eth-trend-indicator" class="ml-2 text-2xl font-bold"></span>
                    </p>
                    <div class="flex flex-col space-y-2">
                        <button id="eth-analyze-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-full shadow-lg transition-colors duration-300 whitespace-nowrap">
                            AI 交易分析
                        </button>
                    </div>
                </div>
                <div class="mt-4 text-center">
                    <button class="alert-btn bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-semibold py-2 px-4 rounded-full text-sm transition-colors duration-300">设置提醒</button>
                </div>
            </div>
            <!-- SOL 价格卡片 -->
            <div id="sol-card" class="price-card p-6 bg-gray-700 rounded-xl shadow-lg transition-transform transform hover:scale-105" data-symbol="SOL">
                <h2 class="text-xl font-semibold mb-2 text-emerald-400">SOL/USDT</h2>
                <div class="flex items-center justify-between">
                    <p class="flex items-center text-4xl font-bold text-white">
                        <span id="sol-price">-</span>
                        <span id="sol-trend-indicator" class="ml-2 text-2xl font-bold"></span>
                    </p>
                    <div class="flex flex-col space-y-2">
                        <button id="sol-analyze-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-full shadow-lg transition-colors duration-300 whitespace-nowrap">
                            AI 交易分析
                        </button>
                    </div>
                </div>
                <div class="mt-4 text-center">
                    <button class="alert-btn bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-semibold py-2 px-4 rounded-full text-sm transition-colors duration-300">设置提醒</button>
                </div>
            </div>
        </div>

        <!-- 价格提醒输入模态框 (新增) -->
        <div id="alert-input-modal" class="hidden modal fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50">
            <div class="bg-gray-800 p-8 rounded-xl shadow-2xl w-full max-w-sm">
                <h2 id="alert-input-title" class="text-2xl font-bold text-white mb-4 text-center">设置价格提醒</h2>
                <p id="alert-input-message" class="text-lg text-gray-300 mb-6 text-center"></p>
                <div class="flex flex-col gap-4">
                    <input id="alert-price-input" type="number" step="0.01" class="bg-gray-700 text-white p-3 rounded-lg w-full focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="输入提醒价格">
                    <div class="flex justify-between gap-4 mt-4">
                        <button id="cancel-alert-btn" class="flex-1 bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-full transition-colors duration-300">取消</button>
                        <button id="set-alert-btn" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-full transition-colors duration-300">设置</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 通知模态框 (用于提醒和错误信息) -->
        <div id="notification-modal" class="hidden modal fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50">
            <div class="bg-gray-800 p-8 rounded-xl shadow-2xl w-full max-w-sm text-center">
                <h2 id="notification-title" class="text-2xl font-bold text-white mb-4"></h2>
                <p id="notification-message" class="text-lg text-gray-300 mb-6"></p>
                <button id="close-notification-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-full transition-colors duration-300">确定</button>
            </div>
        </div>

        <!-- 分析报告展示区 -->
        <div id="analysis-report" class="hidden mt-10 p-8 bg-gray-700 rounded-2xl shadow-xl">
            <h2 id="report-title" class="text-3xl font-bold text-white mb-6 text-center">AI 交易分析报告</h2>
            <div id="report-content" class="prose max-w-none text-gray-300 leading-relaxed">
                <!-- 报告内容将在这里动态插入 -->
                <div class="flex items-center justify-center space-x-2">
                    <div class="loading-spinner"></div>
                    <span class="text-lg text-gray-400">正在生成报告，请稍候...</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 定义全局变量，供 Canvas 环境注入
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : '';
        const apiKey = ""; // API 密钥，在 Canvas 环境中会自动填充

        // 加密货币符号映射
        const symbols = {
            'BTC': 'BTCUSDT',
            'ETH': 'ETHUSDT',
            'SOL': 'SOLUSDT'
        };

        // 获取 DOM 元素
        const btcPriceEl = document.getElementById('btc-price');
        const ethPriceEl = document.getElementById('eth-price');
        const solPriceEl = document.getElementById('sol-price');
        const btcIndicatorEl = document.getElementById('btc-trend-indicator');
        const ethIndicatorEl = document.getElementById('eth-trend-indicator');
        const solIndicatorEl = document.getElementById('sol-trend-indicator');
        const btcAnalyzeBtn = document.getElementById('btc-analyze-btn');
        const ethAnalyzeBtn = document.getElementById('eth-analyze-btn');
        const solAnalyzeBtn = document.getElementById('sol-analyze-btn');
        const analysisReport = document.getElementById('analysis-report');
        const reportTitle = document.getElementById('report-title');
        const reportContent = document.getElementById('report-content');
        const priceCards = document.querySelectorAll('.price-card');
        const alertButtons = document.querySelectorAll('.alert-btn');
        const notificationModal = document.getElementById('notification-modal');
        const notificationTitle = document.getElementById('notification-title');
        const notificationMessage = document.getElementById('notification-message');
        const closeNotificationBtn = document.getElementById('close-notification-btn');

        // 价格提醒输入模态框元素
        const alertInputModal = document.getElementById('alert-input-modal');
        const alertInputTitle = document.getElementById('alert-input-title');
        const alertInputMessage = document.getElementById('alert-input-message');
        const alertPriceInput = document.getElementById('alert-price-input');
        const cancelAlertBtn = document.getElementById('cancel-alert-btn');
        const setAlertBtn = document.getElementById('set-alert-btn');

        // 存储上一个周期的价格
        let previousPrices = {
            'BTCUSDT': null,
            'ETHUSDT': null,
            'SOLUSDT': null
        };

        // 存储价格历史，用于趋势判断（最近3个价格）
        let priceHistory = {
            'BTCUSDT': [],
            'ETHUSDT': [],
            'SOLUSDT': []
        };

        // 存储价格提醒
        let priceAlerts = {};
        
        let currentAlertSymbol = null; // 存储当前价格提醒的币种符号

        /**
         * 使用指数退避安全地调用 API
         * @param {Function} apiCall - 包含 API 调用的异步函数
         * @param {number} retries - 重试次数
         */
        async function fetchWithRetry(apiCall, retries = 3) {
            let delay = 1000; // 初始延迟 1 秒
            for (let i = 0; i < retries; i++) {
                try {
                    return await apiCall();
                } catch (error) {
                    console.error(`API 调用失败，正在重试第 ${i + 1} 次...`, error);
                    if (i < retries - 1) {
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2; // 指数增加延迟
                    } else {
                        throw error;
                    }
                }
            }
        }

        /**
         * 从 Binance API 获取实时价格
         * @param {string} symbol - 货币符号，例如 'BTCUSDT'
         * @returns {Promise<string>} - 价格字符串
         */
        async function fetchPrice(symbol) {
            const response = await fetchWithRetry(() => fetch(`https://api.binance.com/api/v3/ticker/price?symbol=${symbol}`));
            if (!response.ok) {
                throw new Error('网络请求失败');
            }
            const data = await response.json();
            return parseFloat(data.price).toFixed(2);
        }

        /**
         * 从 Binance API 获取 K 线数据
         * @param {string} symbol - 货币符号，例如 'BTCUSDT'
         * @param {string} interval - 时间间隔，例如 '1h' 或 '15m'
         * @returns {Promise<Array>} - K 线数据数组
         */
        async function fetchKlines(symbol, interval = '5m') {
            const response = await fetchWithRetry(() => fetch(`https://api.binance.com/api/v3/klines?symbol=${symbol}&interval=${interval}&limit=100`));
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`获取 K 线数据失败: ${response.status} ${response.statusText} - ${errorText}`);
            }
            const data = await response.json();
            if (!Array.isArray(data) || data.length === 0) {
                 throw new Error('K 线数据为空或格式不正确');
            }
            return data;
        }

        /**
         * 更新所有货币的价格，并根据价格变动改变颜色
         */
        async function updatePrices() {
            try {
                // 并行获取价格以提高效率
                const [btcPrice, ethPrice, solPrice] = await Promise.all([
                    fetchPrice(symbols.BTC),
                    fetchPrice(symbols.ETH),
                    fetchPrice(symbols.SOL)
                ]);

                updatePriceDisplay(btcPriceEl, symbols.BTC, btcPrice);
                updateTrendIndicator(btcIndicatorEl, symbols.BTC, btcPrice);
                
                updatePriceDisplay(ethPriceEl, symbols.ETH, ethPrice);
                updateTrendIndicator(ethIndicatorEl, symbols.ETH, ethPrice);

                updatePriceDisplay(solPriceEl, symbols.SOL, solPrice);
                updateTrendIndicator(solIndicatorEl, symbols.SOL, solPrice);
                
                checkPriceAlerts();

            } catch (error) {
                console.error('更新价格失败:', error);
                showAlertModal("更新失败", "无法获取实时价格，请检查网络连接或稍后再试。");
            }
        }

        /**
         * 更新价格显示并根据价格变化设置字体颜色
         * @param {HTMLElement} element - 显示价格的 DOM 元素
         * @param {string} symbol - 货币符号
         * @param {string} newPrice - 新价格
         */
        function updatePriceDisplay(element, symbol, newPrice) {
            const oldPrice = previousPrices[symbol];
            const priceText = `${newPrice}`;

            element.classList.remove('text-green-500', 'text-red-500', 'text-white');
            
            if (oldPrice === null) {
                element.classList.add('text-white');
            } else if (parseFloat(newPrice) > parseFloat(oldPrice)) {
                element.classList.add('text-green-500');
            } else if (parseFloat(newPrice) < parseFloat(oldPrice)) {
                element.classList.add('text-red-500');
            } else {
                element.classList.add('text-white');
            }

            element.textContent = `$${priceText}`;
            previousPrices[symbol] = newPrice;
        }

        /**
         * 更新趋势指示箭头
         * @param {HTMLElement} element - 显示箭头的 DOM 元素
         * @param {string} symbol - 货币符号
         * @param {string} newPrice - 新价格
         */
        function updateTrendIndicator(element, symbol, newPrice) {
            priceHistory[symbol].push(parseFloat(newPrice));
            if (priceHistory[symbol].length > 3) {
                priceHistory[symbol].shift();
            }

            if (priceHistory[symbol].length === 3) {
                const [p1, p2, p3] = priceHistory[symbol];
                element.classList.remove('text-green-500', 'text-red-500');

                if (p1 < p2 && p2 < p3) {
                    element.innerHTML = '&#8599;';
                    element.classList.add('text-green-500');
                } else if (p1 > p2 && p2 > p3) {
                    element.innerHTML = '&#8600;';
                    element.classList.add('text-red-500');
                } else {
                    element.innerHTML = '';
                }
            } else {
                element.innerHTML = '';
            }
        }

        /**
         * 检查是否有价格提醒被触发
         */
        function checkPriceAlerts() {
            for (const symbol in priceAlerts) {
                if (priceAlerts[symbol] !== null) {
                    const currentPrice = parseFloat(previousPrices[symbol]);
                    const alertPrice = parseFloat(priceAlerts[symbol]);

                    if (currentPrice >= alertPrice) {
                        triggerAudioAlert();
                        showAlertModal("价格提醒", `${symbol} 已达到或超过你的提醒价格 $${alertPrice}！`);
                        priceAlerts[symbol] = null;
                    }
                }
            }
        }

        /**
         * 播放音频提醒
         */
        function triggerAudioAlert() {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.type = 'sine';
            oscillator.frequency.value = 440;
            gainNode.gain.setValueAtTime(0, audioContext.currentTime);
            gainNode.gain.linearRampToValueAtTime(0.5, audioContext.currentTime + 0.1);

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            oscillator.start();
            
            setTimeout(() => {
                gainNode.gain.linearRampToValueAtTime(0, audioContext.currentTime + 0.1);
                oscillator.stop(audioContext.currentTime + 0.1);
            }, 2000);
        }

        /**
         * 显示通知模态框
         * @param {string} title - 标题
         * @param {string} message - 消息内容
         */
        function showAlertModal(title, message) {
            notificationTitle.textContent = title;
            notificationMessage.textContent = message;
            notificationModal.classList.remove('hidden');
        }

        /**
         * 调用 Gemini API 生成交易分析报告，传入实时 K 线数据
         * @param {string} coinSymbol - 货币符号
         */
        async function generateAnalysis(coinSymbol) {
            analysisReport.classList.remove('hidden');
            reportTitle.textContent = `✨ ${coinSymbol} 交易分析报告`;
            reportContent.innerHTML = `
                <div class="flex flex-col items-center justify-center space-y-4">
                    <div class="loading-spinner"></div>
                    <p class="text-xl text-gray-400">正在获取 ${coinSymbol} 最新数据并调用AI生成报告，请稍候...</p>
                </div>
            `;
            
            try {
                const klines = await fetchKlines(symbols[coinSymbol], '5m');
                if (!klines || klines.length === 0) {
                    throw new Error('获取 K 线数据失败');
                }

                const formattedKlines = klines.map(kline => ({
                    open: parseFloat(kline[1]),
                    high: parseFloat(kline[2]),
                    low: parseFloat(kline[3]),
                    close: parseFloat(kline[4]),
                    volume: parseFloat(kline[5]),
                    timestamp: new Date(kline[0]).toLocaleString()
                }));

                const prompt = `
                    根据以下最新的实时K线数据，为加密货币 ${coinSymbol} 生成一份简洁的交易分析报告。报告应提供两种可能的交易策略：看多（Bullish）和看空（Bearish）。
                    对于每种策略，请提供具体的入场价格（Entry Price）、止盈价格（Take-Profit）和止损价格（Stop-Loss），以及简要的理由说明。
                    K线数据（5分钟周期，最近100条）：
                    ${JSON.stringify(formattedKlines, null, 2)}
                    请直接以JSON格式返回结果，JSON结构如下：
                    {
                        "bullish": {
                            "entryPrice": "具体的数值",
                            "takeProfit": "具体的数值",
                            "stopLoss": "具体的数值",
                            "rationale": "简短的看多理由"
                        },
                        "bearish": {
                            "entryPrice": "具体的数值",
                            "takeProfit": "具体的数值",
                            "stopLoss": "具体的数值",
                            "rationale": "简短的看空理由"
                        }
                    }
                `;

                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                const payload = { 
                    contents: chatHistory,
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            "type": "OBJECT",
                            "properties": {
                                "bullish": {
                                    "type": "OBJECT",
                                    "properties": {
                                        "entryPrice": { "type": "STRING" },
                                        "takeProfit": { "type": "STRING" },
                                        "stopLoss": { "type": "STRING" },
                                        "rationale": { "type": "STRING" }
                                    }
                                },
                                "bearish": {
                                    "type": "OBJECT",
                                    "properties": {
                                        "entryPrice": { "type": "STRING" },
                                        "takeProfit": { "type": "STRING" },
                                        "stopLoss": { "type": "STRING" },
                                        "rationale": { "type": "STRING" }
                                    }
                                }
                            }
                        }
                    }
                };
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

                const response = await fetchWithRetry(() => fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                }));
                
                const result = await response.json();
                
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    
                    const json = result.candidates[0].content.parts[0].text;
                    const parsedJson = JSON.parse(json);

                    let htmlContent = `
                        <h3 class="text-xl font-semibold text-green-400 mb-2">看多 (Bullish) 建议</h3>
                        <ul class="list-disc list-inside space-y-1 mb-4">
                            <li><strong>入场价格:</strong> ${parsedJson.bullish.entryPrice}</li>
                            <li><strong>止盈价格:</strong> ${parsedJson.bullish.takeProfit}</li>
                            <li><strong>止损价格:</strong> ${parsedJson.bullish.stopLoss}</li>
                        </ul>
                        <p class="text-gray-400 mb-6"><strong>理由:</strong> ${parsedJson.bullish.rationale}</p>
                        
                        <h3 class="text-xl font-semibold text-red-400 mb-2">看空 (Bearish) 建议</h3>
                        <ul class="list-disc list-inside space-y-1 mb-4">
                            <li><strong>入场价格:</strong> ${parsedJson.bearish.entryPrice}</li>
                            <li><strong>止盈价格:</strong> ${parsedJson.bearish.takeProfit}</li>
                            <li><strong>止损价格:</strong> ${parsedJson.bearish.stopLoss}</li>
                        </ul>
                        <p class="text-gray-400 mb-6"><strong>理由:</strong> ${parsedJson.bearish.rationale}</p>
                    `;
                    reportContent.innerHTML = htmlContent;
                    
                } else {
                    reportContent.innerHTML = `<p class="text-red-500">无法生成报告，API返回了意外的响应。</p>`;
                }

            } catch (error) {
                console.error('API 调用失败:', error);
                reportContent.innerHTML = `<p class="text-red-500">生成报告失败，请稍后再试。</p>`;
            }
        }

        /**
         * 启动应用程序的主要逻辑
         */
        function startApp() {
            try {
                // 为 AI 按钮添加事件监听器
                btcAnalyzeBtn.addEventListener('click', () => generateAnalysis('BTC'));
                ethAnalyzeBtn.addEventListener('click', () => generateAnalysis('ETH'));
                solAnalyzeBtn.addEventListener('click', () => generateAnalysis('SOL'));
                
                // 为每个提醒按钮添加事件监听器
                alertButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        const card = button.closest('.price-card');
                        const coinSymbol = card.dataset.symbol;
                        const binanceSymbol = symbols[coinSymbol];
                        
                        currentAlertSymbol = coinSymbol;
                        const currentPrice = previousPrices[binanceSymbol];

                        alertInputTitle.textContent = `${coinSymbol} 价格提醒`;
                        alertInputMessage.textContent = `当前价格为 $${currentPrice}，请输入你的提醒价格：`;
                        alertPriceInput.value = '';
                        alertInputModal.classList.remove('hidden');
                        alertPriceInput.focus();
                    });
                });
                
                cancelAlertBtn.addEventListener('click', () => {
                    alertInputModal.classList.add('hidden');
                    alertPriceInput.value = '';
                });

                setAlertBtn.addEventListener('click', () => {
                    const alertPrice = parseFloat(alertPriceInput.value);
                    if (alertPrice && !isNaN(alertPrice)) {
                        priceAlerts[symbols[currentAlertSymbol]] = alertPrice;
                        showAlertModal("提醒设置成功", `当 ${currentAlertSymbol} 价格达到 $${alertPrice} 时，你将会收到提醒。`);
                    } else {
                         showAlertModal("输入无效", "请输入一个有效的数字价格。");
                    }
                    alertInputModal.classList.add('hidden');
                    alertPriceInput.value = '';
                });

                closeNotificationBtn.addEventListener('click', () => {
                    notificationModal.classList.add('hidden');
                });
        
                // 初始加载和定期更新
                updatePrices();
                setInterval(updatePrices, 15000);
            } catch (error) {
                console.error("应用程序初始化失败:", error);
                showAlertModal("应用程序错误", `应用程序初始化失败。错误信息: ${error.message}`);
            }
        }
        
        window.onload = startApp;
    </script>
</body>
</html>
