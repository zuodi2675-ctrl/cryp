<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>LUMINA MOBILE</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-title" content="LUMINA">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 fill=%22%23000%22/><circle cx=%2250%22 cy=%2250%22 r=%2235%22 stroke=%22%2300e5ff%22 stroke-width=%228%22 fill=%22none%22/><text x=%2250%22 y=%2262%22 font-family=%22sans-serif%22 font-size=%2240%22 font-weight=%22900%22 fill=%22%23eee%22 text-anchor=%22middle%22>L</text></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 fill=%22%23000%22/><circle cx=%2250%22 cy=%2250%22 r=%2235%22 stroke=%22%2300e5ff%22 stroke-width=%228%22 fill=%22none%22/><text x=%2250%22 y=%2262%22 font-family=%22sans-serif%22 font-size=%2240%22 font-weight=%22900%22 fill=%22%23eee%22 text-anchor=%22middle%22>L</text></svg>">

    <script>
        const manifest={"name":"LUMINA Mobile","short_name":"LUMINA","start_url":".","display":"standalone","background_color":"#000000","theme_color":"#000000","icons":[{"src":"data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 fill=%22%23000%22/><circle cx=%2250%22 cy=%2250%22 r=%2235%22 stroke=%22%2300e5ff%22 stroke-width=%228%22 fill=%22none%22/><text x=%2250%22 y=%2262%22 font-family=%22sans-serif%22 font-size=%2240%22 font-weight=%22900%22 fill=%22%23eee%22 text-anchor=%22middle%22>L</text></svg>","sizes":"192x192 512x512","type":"image/svg+xml"}]};
        const blob=new Blob([JSON.stringify(manifest)],{type:'application/json'});
        const link=document.createElement('link');link.rel='manifest';link.href=URL.createObjectURL(blob);document.head.appendChild(link);
    </script>

    <style>
        :root { --bg: #000; --panel: #141414; --accent: #00e5ff; --text: #eee; --border: #333; --safe-top: env(safe-area-inset-top); --safe-bottom: env(safe-area-inset-bottom); }
        * { box-sizing: border-box; user-select: none; outline: none; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; -webkit-tap-highlight-color: transparent; }
        
        body { margin: 0; background: var(--bg); color: var(--text); height: 100vh; width: 100vw; overflow: hidden; display: flex; flex-direction: column; }

        /* --- Header (Mobile Style) --- */
        .header { 
            height: calc(50px + var(--safe-top)); padding-top: var(--safe-top); 
            background: rgba(20,20,20,0.9); backdrop-filter: blur(10px);
            display: flex; align-items: center; justify-content: space-between; padding-left: 15px; padding-right: 15px; 
            border-bottom: 1px solid #222; z-index: 200; flex-shrink: 0;
        }
        .brand { font-weight: 900; font-style: italic; font-size: 18px; letter-spacing: 1px; } .brand span { color: var(--accent); }
        .h-actions { display: flex; gap: 15px; }
        .icon-btn { font-size: 20px; color: #fff; cursor: pointer; padding: 5px; }
        
        /* éšè—åŸç”Ÿæ–‡ä»¶è¾“å…¥æ¡† */
        #fileInput { display: none; }

        /* --- Viewport --- */
        .viewport { flex: 1; position: relative; overflow: hidden; display: flex; justify-content: center; align-items: center; background: #000; }
        #stage { position: relative; box-shadow: 0 0 50px #000; display: none; }
        canvas { display: block; }
        
        #empty { position: absolute; inset: 0; display: flex; flex-direction: column; justify-content: center; align-items: center; color: #444; font-weight: bold; }
        .empty-icon { font-size: 60px; margin-bottom: 20px; color: #333; border: 2px dashed #333; border-radius: 50%; width: 100px; height: 100px; display: flex; justify-content: center; align-items: center; }

        /* --- Bottom Navigation --- */
        .bottom-nav { 
            height: calc(60px + var(--safe-bottom)); padding-bottom: var(--safe-bottom);
            background: #111; border-top: 1px solid #222; 
            display: flex; justify-content: space-around; align-items: center; z-index: 300;
        }
        .nav-item { display: flex; flex-direction: column; align-items: center; gap: 4px; color: #666; font-size: 10px; width: 60px; cursor: pointer; transition: 0.2s; }
        .nav-item.active { color: var(--accent); }
        .nav-icon { font-size: 20px; margin-top: 5px; }

        /* --- Drawers (Panels) --- */
        .drawer {
            position: fixed; bottom: calc(60px + var(--safe-bottom)); left: 0; right: 0;
            background: rgba(20,20,20,0.95); backdrop-filter: blur(15px);
            border-top: 1px solid var(--accent); border-top-left-radius: 12px; border-top-right-radius: 12px;
            height: 40vh; z-index: 250;
            transform: translateY(110%); transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            display: flex; flex-direction: column;
        }
        .drawer.open { transform: translateY(0); }
        
        .drawer-header { padding: 10px 15px; font-size: 12px; font-weight: bold; color: #888; border-bottom: 1px solid #333; display: flex; justify-content: space-between; }
        .drawer-content { flex: 1; overflow-y: auto; padding: 20px; -webkit-overflow-scrolling: touch; }

        /* --- Presets --- */
        .preset-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 10px; }
        .preset-card { background: #222; border-radius: 6px; padding: 10px; text-align: center; border: 1px solid transparent; }
        .preset-card.active { border-color: var(--accent); background: #2a2a2a; color: var(--accent); }
        .p-name { font-size: 12px; font-weight: bold; margin-bottom: 4px; }
        .p-tag { font-size: 9px; opacity: 0.5; background: #000; padding: 2px 4px; border-radius: 3px; display: inline-block; }

        /* --- Sliders --- */
        .slider-row { margin-bottom: 25px; }
        .slider-label { display: flex; justify-content: space-between; color: #ccc; font-size: 13px; margin-bottom: 10px; }
        .slider-val { color: var(--accent); font-family: monospace; }
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; background: #333; border-radius: 2px; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 20px; width: 20px; border-radius: 50%; background: #fff; margin-top: -8px; box-shadow: 0 2px 5px rgba(0,0,0,0.5); }
        
        /* --- Color Wheels (Mobile Optimized) --- */
        .wheel-cont { display: flex; gap: 15px; overflow-x: auto; padding-bottom: 10px; }
        .wheel-card { min-width: 140px; background: #222; border-radius: 8px; padding: 10px; display: flex; flex-direction: column; align-items: center; }
        .w-tit { font-size: 10px; color: #888; margin-bottom: 5px; text-transform: uppercase; }
        .wheel-canv { width: 100px; height: 100px; border-radius: 50%; background: #000; border: 2px solid #444; position: relative; margin-bottom: 10px; }
        .gear-row { display: flex; gap: 8px; width: 100%; height: 60px; }
        .gear-col { flex: 1; background: #111; border-radius: 4px; position: relative; overflow: hidden; }
        .gear-fill { position: absolute; bottom: 0; left: 0; right: 0; top: 50%; background: currentColor; opacity: 0.5; pointer-events: none; }
        
        /* --- Crop UI --- */
        .crop-layer { position: absolute; inset: 0; z-index: 50; display: none; pointer-events: none; }
        .crop-box { position: absolute; border: 1px solid #fff; box-shadow: 0 0 0 9999px rgba(0,0,0,0.8); pointer-events: auto; }
        .handle { width: 20px; height: 20px; background: var(--accent); border-radius: 50%; position: absolute; z-index: 60; }
        .h-tl { top:-10px; left:-10px; } .h-tr { top:-10px; right:-10px; }
        .h-bl { bottom:-10px; left:-10px; } .h-br { bottom:-10px; right:-10px; }
        
        /* --- Focus UI --- */
        .focus-pt { position: absolute; width: 40px; height: 40px; border: 2px solid #fff; border-radius: 50%; transform: translate(-50%,-50%); pointer-events: auto; z-index: 70; display: none; box-shadow: 0 0 10px var(--accent); }
        
        #toast { position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%); background: rgba(0,0,0,0.8); color: #fff; padding: 10px 20px; border-radius: 20px; pointer-events: none; opacity: 0; transition: 0.3s; z-index: 1000; font-weight: bold; }
    </style>
</head>
<body>

<header class="header">
    <div class="brand">LUMINA</div>
    <div class="h-actions">
        <div class="icon-btn" onclick="document.getElementById('fileInput').click()">ğŸ“‚</div>
        <div class="icon-btn" onclick="exportImg()">ğŸ’¾</div>
    </div>
    <input type="file" id="fileInput" accept="image/*">
</header>

<main class="viewport" id="vp">
    <div id="empty" onclick="document.getElementById('fileInput').click()">
        <div class="empty-icon">ï¼‹</div>
        <div>æ‰“å¼€å›¾ç‰‡</div>
    </div>
    
    <div id="stage">
        <canvas id="gl"></canvas>
        <div class="crop-layer" id="cropUI">
            <div id="cBox" class="crop-box">
                <div class="handle h-tl" data-d="nw"></div><div class="handle h-tr" data-d="ne"></div>
                <div class="handle h-bl" data-d="sw"></div><div class="handle h-br" data-d="se"></div>
            </div>
        </div>
        <div class="focus-pt" id="fPt"></div>
    </div>
    
    <div id="toast">ä¿å­˜æˆåŠŸ</div>
</main>

<div class="drawer" id="d-pre">
    <div class="drawer-header"><span>æ»¤é•œé¢„è®¾</span><span onclick="closeDrawer()">âœ•</span></div>
    <div class="drawer-content">
        <div class="preset-grid">
            <div class="preset-card active" onclick="setPre('none')" id="p-none"><div class="p-name">åŸå›¾</div><div class="p-tag">RAW</div></div>
            <div class="preset-card" onclick="setPre('portrait')" id="p-portrait"><div class="p-name">äººåƒ</div><div class="p-tag">SOFT</div></div>
            <div class="preset-card" onclick="setPre('land')" id="p-land"><div class="p-name">é£æ™¯</div><div class="p-tag">VIVID</div></div>
            <div class="preset-card" onclick="setPre('movie')" id="p-movie"><div class="p-name">ç”µå½±</div><div class="p-tag">TEAL</div></div>
            <div class="preset-card" onclick="setPre('kodak')" id="p-kodak"><div class="p-name">èƒ¶ç‰‡</div><div class="p-tag">GOLD</div></div>
            <div class="preset-card" onclick="setPre('fuji')" id="p-fuji"><div class="p-name">å¯Œå£«</div><div class="p-tag">NC</div></div>
            <div class="preset-card" onclick="setPre('leica')" id="p-leica"><div class="p-name">é»‘ç™½</div><div class="p-tag">BW</div></div>
            <div class="preset-card" onclick="setPre('food')" id="p-food"><div class="p-name">ç¾é£Ÿ</div><div class="p-tag">WARM</div></div>
        </div>
    </div>
</div>

<div class="drawer" id="d-adj">
    <div class="drawer-header">
        <span>å‚æ•°è°ƒèŠ‚</span>
        <span style="color:var(--accent)" onclick="resetParams()">é‡ç½®</span>
    </div>
    <div class="drawer-content">
        <div class="slider-row"><div class="slider-label"><span>äº®åº¦</span><span class="slider-val" id="v-brt">0</span></div><input type="range" id="s-brt" min="-0.5" max="0.5" step="0.01" value="0" oninput="upd('brt',this.value)"></div>
        <div class="slider-row"><div class="slider-label"><span>æ›å…‰</span><span class="slider-val" id="v-exp">0</span></div><input type="range" id="s-exp" min="-2" max="2" step="0.01" value="0" oninput="upd('exp',this.value)"></div>
        <div class="slider-row"><div class="slider-label"><span>å¯¹æ¯”åº¦</span><span class="slider-val" id="v-con">1.0</span></div><input type="range" id="s-con" min="0" max="2" step="0.01" value="1" oninput="upd('con',this.value)"></div>
        <div class="slider-row"><div class="slider-label"><span>é¥±å’Œåº¦</span><span class="slider-val" id="v-sat">1.0</span></div><input type="range" id="s-sat" min="0" max="2" step="0.01" value="1" oninput="upd('sat',this.value)"></div>
        <div class="slider-row"><div class="slider-label"><span>è‰²æ¸©</span><span class="slider-val" id="v-hue">0</span></div><input type="range" id="s-hue" min="-0.5" max="0.5" step="0.01" value="0" oninput="upd('hue',this.value)"></div>
        <div class="slider-row"><div class="slider-label"><span>æ°›å›´</span><span class="slider-val" id="v-boost">0</span></div><input type="range" id="s-boost" min="0" max="1" step="0.01" value="0" oninput="upd('boost',this.value)"></div>
    </div>
</div>

<div class="drawer" id="d-col">
    <div class="drawer-header"><span>è‰²å½©åˆ†çº§</span><span onclick="rstWAll()">â†º</span></div>
    <div class="drawer-content">
        <div class="wheel-cont">
            <div class="wheel-card">
                <div class="w-tit">æš—éƒ¨ Lift</div>
                <div class="wheel-canv" id="wc-lift">
                    <div class="grad" style="position:absolute;inset:2px;border-radius:50%;background:conic-gradient(red,magenta,blue,cyan,lime,yellow,red);opacity:0.6;"></div>
                    <div class="puck" id="pk-lift" style="width:10px;height:10px;background:#fff;border-radius:50%;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);border:1px solid #000;"></div>
                </div>
                <div class="gear-row">
                    <div class="gear-col c-r"><div class="gear-fill" id="gf-lift-r" style="color:red"></div></div>
                    <div class="gear-col c-g"><div class="gear-fill" id="gf-lift-g" style="color:lime"></div></div>
                    <div class="gear-col c-b"><div class="gear-fill" id="gf-lift-b" style="color:blue"></div></div>
                </div>
            </div>
             <div class="wheel-card">
                <div class="w-tit">ä¸­ç° Gamma</div>
                <div class="wheel-canv" id="wc-gamma">
                    <div class="grad" style="position:absolute;inset:2px;border-radius:50%;background:conic-gradient(red,magenta,blue,cyan,lime,yellow,red);opacity:0.6;"></div>
                    <div class="puck" id="pk-gamma" style="width:10px;height:10px;background:#fff;border-radius:50%;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);border:1px solid #000;"></div>
                </div>
                <div class="gear-row">
                    <div class="gear-col c-r"><div class="gear-fill" id="gf-gamma-r" style="color:red"></div></div>
                    <div class="gear-col c-g"><div class="gear-fill" id="gf-gamma-g" style="color:lime"></div></div>
                    <div class="gear-col c-b"><div class="gear-fill" id="gf-gamma-b" style="color:blue"></div></div>
                </div>
            </div>
        </div>
        <div style="font-size:10px;color:#666;text-align:center;margin-top:10px;">* ç‚¹å‡»è‰²è½®é€‰è‰²ï¼Œæ‹–åŠ¨ä¸‹æ–¹è‰²æ¡å¾®è°ƒ</div>
    </div>
</div>

<div class="drawer" id="d-tool">
    <div class="drawer-header"><span>å·¥å…·ç®±</span><span onclick="closeDrawer()">âœ•</span></div>
    <div class="drawer-content">
        <div style="display:flex; gap:10px; flex-wrap:wrap;">
            <button class="preset-card" style="flex:1;color:#eee" onclick="startCrop()">ğŸ“ è£å‰ªæ¨¡å¼</button>
            <button class="preset-card" style="flex:1;color:#eee" onclick="togDof(true)">ğŸ’§ è™šåŒ–/ç§»è½´</button>
        </div>
        
        <div id="tool-crop-act" style="display:none; margin-top:20px; border-top:1px solid #333; padding-top:15px;">
            <div style="display:flex; gap:10px;">
                <button class="preset-card" style="flex:1;background:var(--accent);color:#000" onclick="applyCrop()">ç¡®è®¤è£å‰ª</button>
                <button class="preset-card" style="flex:1" onclick="endCrop()">å–æ¶ˆ</button>
            </div>
        </div>

        <div id="tool-dof-act" style="display:none; margin-top:20px; border-top:1px solid #333; padding-top:15px;">
             <div class="slider-row"><div class="slider-label"><span>è™šåŒ–å¼ºåº¦</span><span class="slider-val" id="v-dof">0</span></div><input type="range" id="s-dof" min="0" max="100" value="0" oninput="upd('dof',this.value)"></div>
             <div style="font-size:10px;color:#666;text-align:center;">* æ‹–åŠ¨ç”»é¢åœ†åœˆé€‰æ‹©å¯¹ç„¦ç‚¹</div>
             <button class="preset-card" style="width:100%;margin-top:10px;" onclick="applyFocus()">åº”ç”¨è™šåŒ–æ•ˆæœ</button>
        </div>
    </div>
</div>

<nav class="bottom-nav">
    <div class="nav-item active" onclick="openDrawer('d-pre', this)">
        <div class="nav-icon">ğŸ¨</div><div>æ»¤é•œ</div>
    </div>
    <div class="nav-item" onclick="openDrawer('d-adj', this)">
        <div class="nav-icon">ğŸšï¸</div><div>å‚æ•°</div>
    </div>
    <div class="nav-item" onclick="openDrawer('d-col', this)">
        <div class="nav-icon">ğŸŒˆ</div><div>è‰²è½®</div>
    </div>
    <div class="nav-item" onclick="openDrawer('d-tool', this)">
        <div class="nav-icon">ğŸ› ï¸</div><div>å·¥å…·</div>
    </div>
</nav>

<script id="vs" type="x-shader/x-vertex">attribute vec2 p;attribute vec2 u;varying vec2 v;void main(){gl_Position=vec4(p,0,1);v=u;}</script>
<script id="fs" type="x-shader/x-fragment">
precision mediump float;uniform sampler2D t;varying vec2 v;uniform vec2 res,fPt;
uniform float brt,exp,con,sat,hue,boost,dof,dofEn,fSz;
uniform vec4 lft,gam,gan;
vec3 satf(vec3 c,float s){float g=dot(c,vec3(0.299,0.587,0.114));return mix(vec3(g),c,s);}
vec3 h2r(vec3 c){vec4 K=vec4(1.,2./3.,1./3.,3.);vec3 p=abs(fract(c.xxx+K.xyz)*6.-K.www);return c.z*mix(K.xxx,clamp(p-K.xxx,0.,1.),c.y);}
vec3 r2h(vec3 c){vec4 K=vec4(0.,-1./3.,2./3.,-1.);vec4 p=mix(vec4(c.bg,K.wz),vec4(c.gb,K.xy),step(c.b,c.g));vec4 q=mix(vec4(p.xyw,c.r),vec4(c.r,p.yzx),step(p.x,c.r));float d=q.x-min(q.w,q.y);float e=1.0e-10;return vec3(abs(q.z+(q.w-q.y)/(6.*d+e)),d/(q.x+e),q.x);}
void main(){
    vec4 px=texture2D(t,v);vec3 c=px.rgb;
    if(dofEn>.5&&dof>0.){
        float a=res.x/res.y;vec2 dv=(v-fPt);dv.x*=a;float d=length(dv);
        float mt=smoothstep(fSz*.8,fSz*1.2,d)*dof*.0002*20.;
        if(mt>.0001){vec3 b=texture2D(t,v+vec2(mt,0)).rgb;b+=texture2D(t,v-vec2(mt,0)).rgb;b+=texture2D(t,v+vec2(0,mt)).rgb;b+=texture2D(t,v-vec2(0,mt)).rgb;c=mix(c,b*.25,.9);}
    }
    if(abs(hue)>.001){vec3 h=r2h(c);h.x+=hue;c=h2r(h);}
    c+=brt;c*=pow(2.,exp);c=.5+(c-.5)*con;c=satf(c,sat);c=satf(c,1.+boost);
    vec3 L=lft.rgb;vec3 G=1./(1.+gam.rgb);vec3 A=1.+gan.rgb;
    c=(c+L*.2)*A;c=pow(max(vec3(0),c),G);
    gl_FragColor=vec4(c,px.a);
}
</script>

<script>
    const def={brt:0,exp:0,con:1,sat:1,hue:0,boost:0,dof:0,dofEn:0,fSz:0.2,fPt:{x:0.5,y:0.5},lift:{r:0,g:0,b:0},gamma:{r:0,g:0,b:0},gain:{r:0,g:0,b:0},pre:'none'};
    let st=JSON.parse(JSON.stringify(def)), tex=null, prog=null, cvs=document.getElementById('gl'), gl, tw=0, th=0, zoom=1;
    
    // --- System Init ---
    try{gl=cvs.getContext('webgl',{preserveDrawingBuffer:true});}catch(e){}
    window.onload=()=>{
        if(!gl)return alert("è®¾å¤‡ä¸æ”¯æŒWebGL");
        initGL();
        document.getElementById('fileInput').onchange=e=>{if(e.target.files.length)load(e.target.files[0])};
        
        // Touch Gestures for Viewport (Pan/Zoom)
        const vp=document.getElementById('vp');
        let lastD=0, lastX=0, lastY=0, pan=false;
        vp.addEventListener('touchstart',e=>{
            if(e.target.closest('.crop-box') || e.target.closest('.focus-pt') || !tex) return;
            if(e.touches.length==1){ pan=true; lastX=e.touches[0].clientX; lastY=e.touches[0].clientY; }
            if(e.touches.length==2){ lastD=Math.hypot(e.touches[0].clientX-e.touches[1].clientX, e.touches[0].clientY-e.touches[1].clientY); }
        });
        vp.addEventListener('touchmove',e=>{
            e.preventDefault(); 
            if(pan && e.touches.length==1){
                let dx=e.touches[0].clientX-lastX, dy=e.touches[0].clientY-lastY;
                updStage(px+=dx, py+=dy); lastX=e.touches[0].clientX; lastY=e.touches[0].clientY;
            }
            if(e.touches.length==2){
                let d=Math.hypot(e.touches[0].clientX-e.touches[1].clientX, e.touches[0].clientY-e.touches[1].clientY);
                let delta=d/lastD; zoom=Math.max(0.05,Math.min(5, zoom*delta)); lastD=d;
                updStage(px,py);
            }
        },{passive:false});
        vp.addEventListener('touchend',()=>pan=false);
        
        initWheelTouch(); initCrop(); initFocus();
    };

    // --- Core Funcs ---
    let px=0, py=0;
    function updStage(x,y){ document.getElementById('stage').style.transform=`translate(${x}px,${y}px) scale(${zoom})`; }
    function initGL(){
        const vs=gl.createShader(gl.VERTEX_SHADER); gl.shaderSource(vs,document.getElementById('vs').text); gl.compileShader(vs);
        const fs=gl.createShader(gl.FRAGMENT_SHADER); gl.shaderSource(fs,document.getElementById('fs').text); gl.compileShader(fs);
        prog=gl.createProgram(); gl.attachShader(prog,vs); gl.attachShader(prog,fs); gl.linkProgram(prog); gl.useProgram(prog);
        gl.bindBuffer(gl.ARRAY_BUFFER,gl.createBuffer()); gl.bufferData(gl.ARRAY_BUFFER,new Float32Array([-1,-1,0,1,1,-1,1,1,-1,1,0,0,-1,1,0,0,1,-1,1,1,1,1,1,0]),gl.STATIC_DRAW);
    }
    function load(f){
        const img=new Image();
        img.onload=()=>{
            const max=2048; tw=img.width; th=img.height;
            let w=tw, h=th; if(w>max||h>max){const s=Math.min(max/w,max/h);w=Math.floor(w*s);h=Math.floor(h*s);}
            const c=document.createElement('canvas'); c.width=w; c.height=h; c.getContext('2d').drawImage(img,0,0,w,h);
            if(tex)gl.deleteTexture(tex); tex=gl.createTexture(); gl.bindTexture(gl.TEXTURE_2D,tex);
            gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR); gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE); gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);
            gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,c);
            document.getElementById('empty').style.display='none'; document.getElementById('stage').style.display='block';
            cvs.width=w; cvs.height=h; cvs.style.width=w+'px'; cvs.style.height=h+'px';
            document.getElementById('stage').style.width=w+'px'; document.getElementById('stage').style.height=h+'px';
            gl.viewport(0,0,w,h);
            const vp=document.getElementById('vp'); zoom=Math.min((vp.clientWidth-20)/w, (vp.clientHeight-20)/h);
            px=0; py=0; updStage(0,0); resetAll(); openDrawer('d-pre', document.querySelector('.nav-item'));
        }; img.src=URL.createObjectURL(f); document.getElementById('fileInput').value='';
    }
    function draw(){
        if(!tex)return; gl.useProgram(prog);
        const p=gl.getAttribLocation(prog,"p"); gl.enableVertexAttribArray(p); gl.vertexAttribPointer(p,2,gl.FLOAT,false,16,0);
        const u=gl.getAttribLocation(prog,"u"); gl.enableVertexAttribArray(u); gl.vertexAttribPointer(u,2,gl.FLOAT,false,16,8);
        const f=(n,v)=>gl.uniform1f(gl.getUniformLocation(prog,n),v);
        f("brt",st.brt); f("exp",st.exp); f("con",st.con); f("sat",st.sat); f("hue",st.hue); f("boost",st.boost); 
        f("dof",st.dof); f("dofEn",st.dofEn); f("fSz",st.fSz);
        gl.uniform2f(gl.getUniformLocation(prog,"fPt"),st.fPt.x,st.fPt.y); gl.uniform2f(gl.getUniformLocation(prog,"res"),cvs.width,cvs.height);
        const v4=(n,o)=>gl.uniform4f(gl.getUniformLocation(prog,n),o.r,o.g,o.b,0);
        v4("lft",st.lift); v4("gam",st.gamma); v4("gan",st.gain); gl.drawArrays(gl.TRIANGLES,0,6);
    }
    
    // --- Logic Wrappers ---
    window.upd=(k,v)=>{st[k]=parseFloat(v); const el=document.getElementById('v-'+k); if(el)el.innerText=st[k]; draw();};
    window.setPre=(n)=>{
        resetParams(false); st.pre=n; 
        document.querySelectorAll('.preset-card').forEach(e=>e.classList.remove('active'));
        document.getElementById('p-'+n)?.classList.add('active');
        if(n=='portrait'){st.con=1.1; st.sat=0.9;} if(n=='land'){st.sat=1.3; st.con=1.1;}
        if(n=='kodak'){st.sat=1.1; st.lift.r=0.05; st.lift.b=-0.05;} if(n=='movie'){st.lift.b=-0.1; st.gain.r=0.05;}
        if(n=='food'){st.sat=1.2; st.gamma.r=0.05;} if(n=='leica'){st.sat=0;}
        syncUI(); draw();
    };
    function resetParams(full=true){
        if(full){st=JSON.parse(JSON.stringify(def)); document.querySelectorAll('.preset-card').forEach(e=>e.classList.remove('active'));}
        else{ const p=st.pre; st=JSON.parse(JSON.stringify(def)); st.pre=p; }
        syncUI(); draw();
    }
    window.resetAll=()=>resetParams(true);
    function syncUI(){
        ['brt','exp','con','sat','hue','boost','dof'].forEach(k=>{
            const s=document.getElementById('s-'+k); if(s){s.value=st[k]; document.getElementById('v-'+k).innerText=st[k];}
        });
        ['lift','gamma'].forEach(k=>['r','g','b'].forEach(c=>updWheelUI(k,c)));
    }

    // --- UI Drawers ---
    window.openDrawer=(id, el)=>{
        document.querySelectorAll('.drawer').forEach(d=>d.classList.remove('open'));
        document.getElementById(id).classList.add('open');
        document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
        if(el) el.classList.add('active');
    };
    window.closeDrawer=()=>{ document.querySelectorAll('.drawer').forEach(d=>d.classList.remove('open')); };

    // --- Color Wheels (Touch) ---
    function initWheelTouch(){
        ['lift','gamma'].forEach(k=>{
            const c=document.getElementById('wc-'+k);
            c.addEventListener('touchstart', e=>{
                e.preventDefault(); const rect=c.getBoundingClientRect();
                const touch=e.touches[0];
                const x=(touch.clientX-rect.left-50)/2.5; const y=(touch.clientY-rect.top-50)/2.5;
                st[k].r=x*0.01; st[k].b=-y*0.01; updWheelUI(k,'r'); updWheelUI(k,'b'); draw();
            });
            c.addEventListener('touchmove', e=>{
                e.preventDefault(); const rect=c.getBoundingClientRect();
                const touch=e.touches[0];
                st[k].r=(touch.clientX-rect.left-50)/50*0.2; st[k].b=-(touch.clientY-rect.top-50)/50*0.2;
                updWheelUI(k,'r'); updWheelUI(k,'b'); draw();
            });
        });
    }
    function updWheelUI(k,c){
        const v=st[k][c]; 
        if(c!='g'){
            const pk=document.getElementById('pk-'+k);
            pk.style.transform=`translate(${st[k].r*250-50}%, ${st[k].b*-250-50}%)`;
        }
        const bar=document.getElementById('gf-'+k+'-'+c);
        if(bar){ bar.style.height=Math.abs(v)*500+'%'; bar.style.top=(v>0?50-Math.abs(v)*500:50)+'%'; }
    }
    window.rstWAll=()=>{st.lift={r:0,g:0,b:0};st.gamma={r:0,g:0,b:0};syncUI();draw();};

    // --- Crop & Focus (Touch) ---
    function initCrop(){
        const b=document.getElementById('cBox'); let drag=null, s={};
        const start=(e)=>{
            e.preventDefault(); e.stopPropagation();
            const t=e.touches?e.touches[0]:e;
            drag=e.target.className.includes('handle')?e.target.dataset.d:'mv';
            s={mx:t.clientX,my:t.clientY,l:b.offsetLeft,t:b.offsetTop,w:b.offsetWidth,h:b.offsetHeight};
            document.addEventListener('touchmove',move,{passive:false}); document.addEventListener('touchend',end);
        };
        const move=(e)=>{
            if(!drag)return; e.preventDefault(); const t=e.touches[0]; const dx=(t.clientX-s.mx)/zoom, dy=(t.clientY-s.my)/zoom;
            if(drag=='mv'){b.style.left=(s.l+dx)+'px';b.style.top=(s.t+dy)+'px';}
            else{
                let nw=s.w,nh=s.h; 
                if(drag.includes('e'))nw+=dx; if(drag.includes('s'))nh+=dy;
                if(drag.includes('w')){nw-=dx;b.style.left=(s.l+dx)+'px';} if(drag.includes('n')){nh-=dy;b.style.top=(s.t+dy)+'px';}
                b.style.width=Math.max(50,nw)+'px'; b.style.height=Math.max(50,nh)+'px';
            }
        };
        const end=()=>{drag=null;document.removeEventListener('touchmove',move);document.removeEventListener('touchend',end);};
        b.addEventListener('touchstart',start);
    }
    window.startCrop=()=>{ if(!tex)return; document.getElementById('cropUI').style.display='block'; document.getElementById('tool-crop-act').style.display='block'; const w=cvs.width*zoom, h=cvs.height*zoom; document.getElementById('cBox').style.cssText=`width:${w*0.8}px;height:${h*0.8}px;left:${w*0.1}px;top:${h*0.1}px`; };
    window.endCrop=()=>{ document.getElementById('cropUI').style.display='none'; document.getElementById('tool-crop-act').style.display='none'; };
    window.applyCrop=()=>{
        const b=document.getElementById('cBox'); const x=b.offsetLeft, y=b.offsetTop, w=b.offsetWidth, h=b.offsetHeight;
        const tc=document.createElement('canvas'); tc.width=cvs.width; tc.height=cvs.height; tc.getContext('2d').drawImage(cvs,0,0);
        const c=document.createElement('canvas'); c.width=w; c.height=h; c.getContext('2d').drawImage(tc,-x,-y);
        const img=new Image(); img.onload=()=>{
            tw=w; th=h; gl.bindTexture(gl.TEXTURE_2D,tex); gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,c);
            resetAll(); cvs.width=w; cvs.height=h; cvs.style.width=w+'px'; cvs.style.height=h+'px';
            document.getElementById('stage').style.width=w+'px'; document.getElementById('stage').style.height=h+'px';
            gl.viewport(0,0,w,h); updStage(0,0); endCrop();
        }; img.src=c.toDataURL();
    };

    // --- Focus ---
    function initFocus(){
        const p=document.getElementById('fPt'); let d=false;
        const mv=(e)=>{if(!d)return; e.preventDefault(); const t=e.touches[0]; const r=document.getElementById('stage').getBoundingClientRect(); let x=(t.clientX-r.left)/zoom, y=(t.clientY-r.top)/zoom; p.style.left=x+'px'; p.style.top=y+'px'; st.fPt={x:x/cvs.width, y:1.0-y/cvs.height}; draw();}
        p.addEventListener('touchstart',e=>{d=true;e.stopPropagation();});
        document.addEventListener('touchmove',mv,{passive:false});
        document.addEventListener('touchend',()=>d=false);
    }
    window.togDof=(en)=>{
        st.dofEn=en?1:0; draw();
        document.getElementById('tool-dof-act').style.display=en?'block':'none';
        document.getElementById('fPt').style.display=en?'block':'none';
    };
    window.applyFocus=()=>{
        const t=document.createElement('canvas'); t.width=cvs.width; t.height=cvs.height; t.getContext('2d').drawImage(cvs,0,0);
        const i=new Image(); i.onload=()=>{gl.bindTexture(gl.TEXTURE_2D,tex);gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,t);st.dofEn=0;st.dof=0;togDof(false);}; i.src=t.toDataURL();
    };

    window.exportImg=()=>{
        if(!tex)return; draw();
        const a=document.createElement('a'); a.download='LUMINA_Mobile.jpg'; a.href=cvs.toDataURL('image/jpeg',0.95); a.click();
        const t=document.getElementById('toast'); t.style.opacity=1; setTimeout(()=>t.style.opacity=0, 2000);
    };
</script>
</body>
</html>
