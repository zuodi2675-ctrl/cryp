<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>LUMINA ‰∏ì‰∏öÁâà v1.4</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000">

    <style>
        /* --- Âü∫Á°ÄÂÆö‰πâ --- */
        :root { --accent: #00e5ff; --bg: #050505; --panel: #0a0a0a; --text: #eee; --safe-top: env(safe-area-inset-top); --safe-bottom: env(safe-area-inset-bottom); }
        * { box-sizing: border-box; user-select: none; outline: none; -webkit-tap-highlight-color: transparent; font-family: -apple-system, "PingFang SC", "Microsoft YaHei", sans-serif; }
        body { margin: 0; background: var(--bg); color: var(--text); height: 100vh; width: 100vw; overflow: hidden; display: flex; flex-direction: column; }

        /* --- È°∂ÈÉ®Ê†è --- */
        .top-bar {
            height: calc(54px + var(--safe-top)); padding-top: var(--safe-top);
            display: flex; justify-content: space-between; align-items: center; padding: var(--safe-top) 20px 0 20px;
            background: linear-gradient(to bottom, rgba(0,0,0,0.9), transparent); 
            z-index: 200; position: absolute; top:0; left:0; right:0; pointer-events: none;
        }
        .top-btn { 
            pointer-events: auto; background: rgba(30,30,30,0.4); backdrop-filter: blur(12px); 
            width: 38px; height: 38px; border-radius: 50%; display: flex; justify-content: center; align-items: center; 
            font-size: 16px; border: 1px solid rgba(255,255,255,0.1); cursor: pointer; transition: 0.2s; color: #fff;
        }
        .top-btn:active { transform: scale(0.92); background: var(--accent); color: #000; border-color:var(--accent); box-shadow: 0 0 15px var(--accent); }

        /* --- ËàûÂè∞Âå∫Âüü --- */
        .stage-area { 
            flex: 1; position: relative; background: radial-gradient(circle at center, #151515 0%, #000 100%); overflow: hidden; 
            display: flex; justify-content: center; align-items: center; z-index: 1;
        }
        #canvas-wrap { box-shadow: 0 20px 60px rgba(0,0,0,0.9); display: none; transform-origin: center center; position: relative; }
        canvas { display: block; width: 100%; height: 100%; pointer-events: none; }
        
        #empty-state { position: absolute; inset: 0; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 50; pointer-events: auto; opacity: 0.6; transition:0.3s; }
        #empty-state:active { opacity: 1; transform: scale(0.98); }
        .add-icon { font-size: 32px; color: #666; margin-bottom: 15px; width: 70px; height: 70px; border: 2px dashed #444; border-radius: 50%; display: flex; justify-content: center; align-items: center; }

        /* --- Ë£ÅÂâ™Â±Ç --- */
        .crop-layer { position: absolute; inset: 0; z-index: 80; display: none; background: transparent; }
        .crop-box { 
            position: absolute; border: 1px solid rgba(255,255,255,0.8); 
            box-shadow: 0 0 0 9999px rgba(0,0,0,0.85); 
            touch-action: none; 
        }
        .crop-grid { position: absolute; inset: 0; opacity: 0.3; pointer-events: none; background: linear-gradient(to right, transparent 33%, #fff 33%, #fff 33.5%, transparent 33.5%, transparent 66%, #fff 66%, #fff 66.5%, transparent 66.5%), linear-gradient(to bottom, transparent 33%, #fff 33%, #fff 33.5%, transparent 33.5%, transparent 66%, #fff 66%, #fff 66.5%, transparent 66.5%); }
        .crop-handle { position: absolute; width: 24px; height: 24px; border: 2px solid #fff; border-radius: 50%; background: var(--accent); z-index: 90; transform: translate(-50%, -50%); box-shadow: 0 0 10px var(--accent); }
        .ch-tl { top:0; left:0; } .ch-tr { top:0; left:100%; } .ch-bl { top:100%; left:0; } .ch-br { top:100%; left:100%; }
        .crop-btn-bar { position: absolute; bottom: 40px; left:0; right:0; display:flex; justify-content:center; gap:30px; z-index:100; pointer-events: auto; }

        /* --- Ê∂≤ÂåñÂºïÂØºÂ±Ç --- */
        #warp-overlay { 
            position: absolute; inset: 0; z-index: 90; 
            box-shadow: inset 0 0 0 4px var(--accent); border-radius: 4px; 
            display: none; 
            touch-action: none; 
            pointer-events: auto; 
        }
        #warp-guide { position: absolute; width: 60px; height: 60px; border: 2px solid rgba(255,255,255,0.5); border-radius: 50%; pointer-events: none; transform: translate(-50%,-50%); display: none; box-shadow: 0 0 10px rgba(0,0,0,0.5); }
        .warp-msg { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); text-align: center; color: var(--accent); font-weight: bold; font-size: 12px; text-shadow: 0 2px 10px #000; background: rgba(0,0,0,0.7); padding: 6px 12px; border-radius: 20px; backdrop-filter: blur(5px); pointer-events: none; white-space: nowrap; }
        
        /* ÈÄöÁî®ÊåâÈíÆ */
        .c-act-btn { background: #222; color:#ccc; border:1px solid #444; padding: 10px 24px; border-radius:30px; font-size:13px; font-weight:bold; letter-spacing:1px; transition:0.2s; pointer-events: auto; cursor: pointer; }
        .c-act-btn:active { transform:scale(0.95); }
        .c-act-btn.prim { background: var(--accent); color:#000; border-color:var(--accent); box-shadow: 0 0 20px rgba(0,229,255,0.3); }

        /* --- ÊµÆÂä®Â∑•ÂÖ∑Ê†è --- */
        .float-btns { position: absolute; bottom: 230px; right: 20px; display: none; flex-direction: column; gap: 18px; z-index: 150; }
        .fab {
            width: 44px; height: 44px; background: rgba(20,20,20,0.9); 
            border-radius: 50%; display: flex; justify-content: center; align-items: center; 
            font-size: 18px; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.15); 
            color: #ccc; box-shadow: 0 10px 20px rgba(0,0,0,0.5); pointer-events: auto; transition:0.2s;
        }
        .fab:active { transform: scale(0.9); background:#fff; color:#000; }
        .fab.active { color: #000; background: var(--accent); border-color: var(--accent); box-shadow: 0 0 20px var(--accent); }

        /* --- ÂØπÊØîÂàÜÂâ≤Á∫ø --- */
        #compare-overlay { position: absolute; inset: 0; pointer-events: none; display: none; z-index: 10; }
        .split-line { position: absolute; top: 0; bottom: 0; width: 1px; background: #fff; left: 50%; box-shadow: 0 0 15px rgba(0,229,255,0.8); pointer-events: auto; }
        .split-handle { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 36px; height: 36px; background: rgba(0,0,0,0.6); backdrop-filter:blur(4px); border: 1px solid #fff; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 14px; color:#fff; }

        /* --- ‰∏ªÊéßÂà∂Èù¢Êùø --- */
        .controls { 
            background: rgba(10,10,10,0.98); backdrop-filter: blur(25px);
            border-top-left-radius: 32px; border-top-right-radius: 32px;
            padding-bottom: var(--safe-bottom); position: relative; z-index: 100; /* Ensure > 90 (warp) */
            display: flex; flex-direction: column; border-top: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 -10px 50px rgba(0,0,0,0.8);
        }

        .panel-container { height: 200px; position: relative; overflow: hidden; margin-bottom: 5px; }
        .panel { position: absolute; inset: 0; display: none; flex-direction: column; padding: 20px 0; }
        .panel.active { display: flex; }

        /* 1. È¢ÑËÆæ */
        .preset-scroll { display: flex; overflow-x: auto; padding: 0 20px; gap: 12px; scrollbar-width: none; -webkit-overflow-scrolling: touch; align-items: center; height: 100%; }
        .preset-scroll::-webkit-scrollbar { display: none; }
        .p-chip { 
            flex: 0 0 72px; height: 96px; background: #161616; border-radius: 12px; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            border: 1px solid #282828; position: relative; overflow: hidden; transition: 0.2s;
        }
        .p-chip.active { border-color: var(--accent); background: #1a1a1a; box-shadow: 0 0 20px rgba(0,229,255,0.1); }
        .p-name { color: #ddd; font-size: 11px; font-weight: bold; margin-bottom: 4px; z-index: 2; letter-spacing:0.5px; }
        .p-tag { font-size: 9px; color: #666; background: #080808; padding: 2px 5px; border-radius: 4px; z-index: 2; font-weight:900; }
        .grp-label { writing-mode: vertical-rl; text-orientation: mixed; color: #333; font-size: 9px; font-weight: 900; transform: rotate(180deg); margin: 0 2px; letter-spacing: 2px; }

        /* 2. ÂÖâÊïàË∞ÉËäÇ */
        .param-bar { 
            display: flex; overflow-x: auto; gap: 24px; padding: 0 25px; 
            border-bottom: 1px solid #222; height: 45px; align-items: center; flex-shrink: 0;
            -webkit-overflow-scrolling: touch; 
            mask-image: linear-gradient(to right, transparent, black 10%, black 90%, transparent);
            -webkit-mask-image: linear-gradient(to right, transparent, black 10%, black 90%, transparent);
        }
        .param-bar::-webkit-scrollbar { display: none; }
        .param-item { font-size: 13px; color: #555; white-space: nowrap; font-weight: 600; transition: 0.2s; position: relative; letter-spacing:0.5px; }
        .param-item.active { color: var(--accent); font-size: 14px; text-shadow: 0 0 10px rgba(0,229,255,0.4); }
        
        .dial-area { flex: 1; position: relative; display: flex; flex-direction: column; justify-content: center; align-items: center; overflow: hidden; touch-action: none; cursor: ew-resize; }
        .dial-val { font-family: "Courier New", monospace; font-size: 26px; font-weight: 900; color: #fff; pointer-events: none; margin-bottom: 8px; text-shadow: 0 0 10px rgba(255,255,255,0.3); }
        .dial-track { 
            width: 100%; height: 50px; position: relative; 
            background: repeating-linear-gradient(90deg, transparent, transparent 9px, #333 9px, #333 10px); 
            mask-image: radial-gradient(circle at center, black 0%, transparent 80%);
            -webkit-mask-image: radial-gradient(circle at center, black 0%, transparent 80%);
        }
        .dial-cursor { position: absolute; top: 55%; left: 50%; transform: translate(-50%, -50%); width: 2px; height: 30px; background: var(--accent); box-shadow: 0 0 15px var(--accent); z-index: 5; border-radius:2px; }

        /* 3. Ëâ≤ËΩÆ */
        .col-tabs { display: flex; justify-content: center; gap: 8px; margin-bottom: 15px; padding: 0 15px; }
        .c-btn { font-size: 10px; color: #555; padding: 6px 0; flex:1; text-align:center; border-radius: 6px; border: 1px solid #222; background: #151515; font-weight:bold; transition:0.2s; }
        .c-btn.active { color: #000; background: var(--accent); border-color: var(--accent); box-shadow: 0 0 15px rgba(0,229,255,0.4); }

        .wheel-layout { display: flex; height: 130px; gap: 15px; padding: 0 20px; align-items:center; }
        .wheel-box { 
            flex: 0 0 110px; height: 110px; position: relative; 
            background: #000; border-radius: 50%; border: 3px solid #222; 
            box-shadow: inset 0 0 20px #000, 0 5px 15px rgba(0,0,0,0.5);
            display: flex; justify-content: center; align-items: center; overflow:hidden; 
            transition: background 0.1s;
        }
        .wheel-grad { width: 100%; height: 100%; background: conic-gradient(from 0deg, red, magenta, blue, cyan, lime, yellow, red); opacity: 0.6; border-radius: 50%; filter: blur(2px); mix-blend-mode: screen; pointer-events: none; }
        .wheel-puck { 
            width: 14px; height: 14px; border: 2px solid #fff; background: transparent;
            border-radius: 50%; position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%); 
            box-shadow: 0 0 4px rgba(0,0,0,0.8); pointer-events:none; 
            transition: all 0.1s;
        }
        .gears-box { flex: 1; display: flex; justify-content: space-between; align-items: center; height: 100%; padding-left: 10px; }
        .gear-col { flex: 1; display: flex; flex-direction: column; align-items: center; height: 100%; justify-content: center; gap:8px; }
        .gear-lbl { font-size: 9px; font-weight: 900; color: #444; font-family: sans-serif; }
        .camera-gear {
            width: 42px; height: 42px; border-radius: 50%;
            background: radial-gradient(circle at center, #111 40%, #222 100%);
            position: relative;
            background-image: repeating-conic-gradient(#181818 0% 4%, transparent 4% 8%), radial-gradient(#111 50%, #333 100%);
            background-blend-mode: normal;
            border: 1px solid #111;
            box-shadow: 0 4px 10px rgba(0,0,0,0.6), inset 0 1px 1px rgba(255,255,255,0.15);
            display: flex; justify-content: center; align-items: center;
            touch-action: none;
        }
        .camera-gear::before {
            content: ''; position: absolute; inset: 6px; border-radius: 50%;
            background: conic-gradient(from 180deg, #111, #333, #111);
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.8);
        }
        .gear-marker {
            position: absolute; width: 4px; height: 4px; border-radius: 50%; top: 4px; background: #fff;
            box-shadow: 0 0 4px currentColor; opacity: 0.6;
            transform-origin: center 17px;
        }
        .c-r { color: #ff4444; } .c-g { color: #44ff44; } .c-b { color: #4444ff; } .c-y { color: #ffffff; }

        /* --- LUTS Ê®°Âùó --- */
        .lut-panel-wrap { display: flex; flex-direction: column; height: 100%; padding: 0 20px; }
        .lut-actions { display: flex; gap: 15px; margin-bottom: 15px; }
        .lut-btn { flex: 1; background: #181818; border: 1px solid #333; color: #ccc; padding: 12px 0; border-radius: 8px; font-size: 11px; font-weight: bold; text-align: center; letter-spacing: 1px; transition: 0.2s; }
        .lut-btn:active { background: #333; transform: scale(0.98); }
        
        .lut-list-area { flex: 1; overflow-y: auto; background: rgba(0,0,0,0.3); border-radius: 8px; padding: 5px; border: 1px solid #222; }
        .lut-item { padding: 12px 15px; margin-bottom: 4px; background: #111; border-radius: 6px; font-size: 12px; color: #888; display: flex; justify-content: space-between; align-items: center; border: 1px solid transparent; transition: 0.2s; }
        .lut-item.active { border-color: var(--accent); background: #1a1a1a; color: #fff; }
        .lut-tag { background: #333; font-size: 9px; padding: 2px 4px; border-radius: 3px; font-weight: 900; }

        /* LUT Ë∞ÉËäÇÊµÆÂ±Ç */
        #lut-adjust-overlay { 
            position: absolute; top: 0; bottom: 0; left: 0; right: 0; 
            background: #0a0a0a; z-index: 200; 
            display: none; flex-direction: column; justify-content: center; padding: 20px 30px;
        }
        .la-title { font-size: 14px; font-weight: 900; color: #fff; margin-bottom: 25px; display: flex; justify-content: space-between; }
        .la-slider-box { height: 40px; position: relative; margin-bottom: 30px; display: flex; align-items: center; }
        .la-track { width: 100%; height: 4px; background: #333; border-radius: 2px; position: relative; }
        .la-fill { position: absolute; top:0; left:0; bottom:0; background: var(--accent); border-radius: 2px; width: 0%; }
        .la-knob { position: absolute; top: 50%; width: 24px; height: 24px; background: #fff; border-radius: 50%; transform: translate(-50%, -50%); box-shadow: 0 2px 10px rgba(0,0,0,0.5); touch-action: none; left: 0%; }
        
        .la-btns { display: flex; gap: 15px; }
        .la-btn { flex: 1; padding: 12px 0; text-align: center; border-radius: 8px; font-size: 12px; font-weight: bold; background: #222; color: #ccc; transition: 0.2s; }
        .la-btn:active { transform: scale(0.98); }
        .la-btn.confirm { background: var(--accent); color: #000; box-shadow: 0 0 15px rgba(0,229,255,0.3); }

        /* Â∫ïÈÉ®ÂØºËà™ */
        .nav-bar { display: flex; justify-content: space-around; height: 68px; align-items: center; border-top: 1px solid rgba(255,255,255,0.05); flex-shrink: 0; background: rgba(12,12,12,0.98); padding-bottom: var(--safe-bottom); position: relative; z-index: 300; }
        .nav-item { 
            flex: 1; display: flex; justify-content: center; align-items: center; 
            opacity: 0.3; height: 100%; transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            position: relative;
        }
        .nav-icon { width: 24px; height: 24px; fill: none; stroke: #fff; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; transition: 0.3s; }
        .nav-item.active { opacity: 1; }
        .nav-item.active .nav-icon { stroke: var(--accent); filter: drop-shadow(0 0 6px var(--accent)); transform: scale(1.15); }
        .nav-item.active::after { content:''; position: absolute; bottom: 12px; width: 4px; height: 4px; border-radius: 50%; background: var(--accent); box-shadow: 0 0 5px var(--accent); }

        #toast { position: fixed; top: 50%; left: 50%; transform: translate(-50%,-50%); background: rgba(0,0,0,0.85); border: 1px solid #333; color: #fff; padding: 12px 24px; border-radius: 30px; opacity: 0; pointer-events: none; transition: 0.3s; z-index: 999; font-weight: bold; font-size: 14px; letter-spacing: 1px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); backdrop-filter:blur(5px); }
        
        .slim-actions { display: flex; gap: 10px; padding: 10px 20px; }
        .slim-btn { flex: 1; border: 1px solid #333; background: #111; color: #888; font-size: 10px; font-weight: 900; padding: 8px 0; border-radius: 4px; text-align: center; cursor:pointer; }
        .slim-btn:active { background: #333; color: #fff; }
    </style>
</head>
<body>

<div id="toast">Â∑≤‰øùÂ≠òÂà∞Áõ∏ÂÜå</div>
<input type="file" id="fileInput" accept="image/*" style="display:none" onchange="loadFile(this)">
<input type="file" id="lutInput" accept=".cube" multiple style="display:none" onchange="loadLutFiles(this)">

<script>
    (function(){
        const man={name:"LUMINA ‰∏ì‰∏öÁâà",short_name:"LUMINA",start_url:".",display:"standalone",background_color:"#000000",theme_color:"#000000",icons:[{src:"icon.png",sizes:"192x192",type:"image/png"}]};
        const blob=new Blob([JSON.stringify(man)],{type:'application/json'});
        const link=document.createElement('link');link.rel='manifest';link.href=URL.createObjectURL(blob);document.head.appendChild(link);
        const ico=`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><rect width="512" height="512" fill="#050505"/><circle cx="256" cy="256" r="180" stroke="#00e5ff" stroke-width="24" fill="none"/><path d="M256 120 L350 380 L162 380 Z" fill="#fff"/></svg>`;
        const iconUrl='data:image/svg+xml;base64,'+btoa(ico);
        ['apple-touch-icon','icon'].forEach(r=>{const l=document.createElement('link');l.rel=r;l.href=iconUrl;document.head.appendChild(l);});
    })();
</script>

<div class="top-bar">
    <div class="top-btn" onclick="document.getElementById('fileInput').click()">üìÇ</div>
    <div style="font-weight:900; font-style:italic; font-size:18px; letter-spacing:1px; color:#fff;">LUMINA <span style="color:var(--accent)">‰∏ì‰∏öÁâà</span></div>
    <div class="top-btn" onclick="exportImg()">üíæ</div>
</div>

<main class="stage-area" id="stage-area">
    <div id="empty-state" onclick="document.getElementById('fileInput').click()">
        <div class="add-icon">Ôºã</div><div style="font-size:12px;color:#666;font-weight:bold;letter-spacing:2px;">ÊâìÂºÄÁÖßÁâá</div>
    </div>
    
    <div id="canvas-wrap">
        <canvas id="gl"></canvas>
        <div id="compare-overlay">
            <div class="split-line" id="split-line"><div class="split-handle">‚¨å</div></div>
        </div>
        <div class="crop-layer" id="crop-ui">
            <div class="crop-box" id="crop-box">
                <div class="crop-grid"></div>
                <div class="crop-handle ch-tl" data-d="nw"></div><div class="crop-handle ch-tr" data-d="ne"></div>
                <div class="crop-handle ch-bl" data-d="sw"></div><div class="crop-handle ch-br" data-d="se"></div>
            </div>
            <div class="crop-btn-bar">
                <div class="c-act-btn" onclick="toggleCrop(false)">ÂèñÊ∂à</div>
                <div class="c-act-btn prim" onclick="applyCrop()">Á°ÆËÆ§Ë£ÅÂâ™</div>
            </div>
        </div>
        
        <div id="warp-overlay">
            <div class="warp-msg">ËØ∑Âú®ÁîªÈù¢‰∏äÊãñÊãΩËøõË°å‰øÆÊï¥</div>
            <div id="warp-guide"></div>
            <div class="crop-btn-bar">
                <div class="c-act-btn" onclick="cancelWarp()">ÂèñÊ∂à</div>
                <div class="c-act-btn prim" onclick="applyWarp()">Â∫îÁî®</div>
            </div>
        </div>
    </div>

    <div class="float-btns" id="float-btns">
        <div class="fab" onclick="resetAll(false)">‚Ü∫</div>
        <div class="fab" id="btn-comp" onclick="toggleCompare()">üëÅ</div>
        <div class="fab" id="btn-crop" onclick="toggleCrop(true)">üìê</div>
        <div class="fab" id="btn-sound" onclick="togSnd()" style="font-size:14px">üîä</div>
    </div>
</main>

<div class="controls">
    <div class="panel-container">
        <div id="lut-adjust-overlay">
            <div class="la-title"><span>Ë∞ÉËäÇÊª§ÈïúÂº∫Â∫¶</span><span id="la-val">5%</span></div>
            <div class="la-slider-box" id="la-slider">
                <div class="la-track"><div class="la-fill" id="la-fill"></div></div>
                <div class="la-knob" id="la-knob"></div>
            </div>
            <div class="la-btns">
                <div class="la-btn" onclick="closeLutAdj(false)">ÂèñÊ∂à</div>
                <div class="la-btn confirm" onclick="closeLutAdj(true)">Â∫îÁî®</div>
            </div>
        </div>

        <div class="panel active" id="p-pre">
            <div class="preset-scroll" id="preset-list"></div>
        </div>

        <div class="panel" id="p-adj">
            <div class="param-bar" id="adj-params"></div>
            <div class="dial-area" id="adj-dial">
                <div class="dial-val" id="dial-val">0.0</div>
                <div class="dial-cursor"></div>
                <div class="dial-track" id="dial-track"></div>
            </div>
        </div>

        <div class="panel" id="p-col">
            <div class="col-tabs">
                <div class="c-btn active" onclick="setWheelTab('lft')" id="t-lft">ÊöóÈÉ®</div>
                <div class="c-btn" onclick="setWheelTab('gam')" id="t-gam">ÁÅ∞Â∫¶</div>
                <div class="c-btn" onclick="setWheelTab('gan')" id="t-gan">‰∫ÆÈÉ®</div>
                <div class="c-btn" onclick="setWheelTab('off')" id="t-off">ÂÅèÁßª</div>
            </div>
            
            <div class="wheel-layout">
                <div class="wheel-box" id="wheel-zone">
                    <div class="wheel-grad" id="wheel-grad"></div>
                    <div class="wheel-puck" id="wheel-puck"></div>
                </div>
                <div class="gears-box">
                    <div class="gear-col"><div class="gear-lbl">Á∫¢</div><div class="camera-gear" id="gw-r"><div class="gear-marker c-r" id="gm-r"></div></div></div>
                    <div class="gear-col"><div class="gear-lbl">Áªø</div><div class="camera-gear" id="gw-g"><div class="gear-marker c-g" id="gm-g"></div></div></div>
                    <div class="gear-col"><div class="gear-lbl">Ëìù</div><div class="camera-gear" id="gw-b"><div class="gear-marker c-b" id="gm-b"></div></div></div>
                    <div class="gear-col"><div class="gear-lbl">‰∫Æ</div><div class="camera-gear" id="gw-y"><div class="gear-marker c-y" id="gm-y"></div></div></div>
                </div>
            </div>
        </div>

        <div class="panel" id="p-por">
            <div class="slim-actions">
                <div class="slim-btn" onclick="toggleWarp(true, 'body')">ÊâãÂä®Áò¶Ë∫´ (Ê∂≤Âåñ)</div>
                <div class="slim-btn" onclick="toggleWarp(true, 'face')">ÊâãÂä®Áò¶ËÑ∏ (Ê∂≤Âåñ)</div>
            </div>
            <div class="param-bar" id="por-params"></div>
            <div class="dial-area" id="por-dial">
                <div class="dial-val" id="por-val">0.0</div>
                <div class="dial-cursor"></div>
                <div class="dial-track" id="por-track"></div>
            </div>
        </div>

        <div class="panel" id="p-lut">
            <div class="lut-panel-wrap">
                <div class="lut-actions">
                    <div class="lut-btn" onclick="document.getElementById('lutInput').click()">+ ÂØºÂÖ• .CUBE</div>
                    <div class="lut-btn" onclick="generateLut()">ÂØºÂá∫ LUT</div>
                </div>
                <div class="lut-list-area" id="lut-list">
                    <div style="padding:20px; text-align:center; color:#555; font-size:11px;">ÊöÇÊó†Êª§Èïú</div>
                </div>
            </div>
        </div>
    </div>

    <div class="nav-bar">
        <div class="nav-item active" onclick="nav('pre',this)">
            <svg class="nav-icon" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2" stroke="currentColor"/><path d="M7 3v18M17 3v18M3 9h4M17 9h4M3 15h4M17 15h4" stroke="currentColor"/></svg>
        </div>
        <div class="nav-item" onclick="nav('adj',this)">
            <svg class="nav-icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="5" stroke="currentColor"/><path d="M12 2v2M12 20v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2M20 12h2M6.34 17.66l-1.41 1.41M19.07 4.93l-1.41 1.41" stroke="currentColor"/></svg>
        </div>
        <div class="nav-item" onclick="nav('col',this)">
            <svg class="nav-icon" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10c.88 0 1.67-.25 2.34-.69.45-.29.75-.76.75-1.31 0-.83-.67-1.5-1.5-1.5h-1.58c-1.31 0-2.45-.88-2.78-2.16-.5-1.92.95-3.84 2.87-3.84h.5c.83 0 1.5-.67 1.5-1.5V9.5c0-.83-.67-1.5-1.5-1.5h-.06c-.8-.06-1.44-.76-1.44-1.56 0-.85.71-1.54 1.56-1.48C17.7 5.17 22 9.24 22 14.16V12c0-5.52-4.48-10-10-10z" stroke="currentColor"/><circle cx="6.5" cy="11.5" r="1.5" fill="currentColor"/><circle cx="9.5" cy="7.5" r="1.5" fill="currentColor"/><circle cx="14.5" cy="7.5" r="1.5" fill="currentColor"/></svg>
        </div>
        <div class="nav-item" onclick="nav('por',this)">
            <svg class="nav-icon" viewBox="0 0 24 24"><circle cx="12" cy="8" r="4" stroke="currentColor"/><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2" stroke="currentColor"/></svg>
        </div>
        <div class="nav-item" onclick="nav('lut',this)">
            <svg class="nav-icon" viewBox="0 0 24 24"><path d="M4 4h16v16H4z" stroke="currentColor" fill="none"/><path d="M4 10h16M10 4v16" stroke="currentColor"/><rect x="6" y="6" width="2" height="2" fill="currentColor"/><rect x="16" y="16" width="2" height="2" fill="currentColor"/></svg>
        </div>
    </div>
</div>

<script id="vs" type="x-shader/x-vertex">
    attribute vec2 p; attribute vec2 u; varying vec2 v; 
    uniform float ana; // Anamorphic squeeze factor
    void main(){
        vec2 pos = p;
        if(ana > 0.0) {
            pos.x *= (1.0 - ana * 0.15); // Slight compression on X
        }
        gl_Position=vec4(pos,0,1);
        v=u;
    }
</script>
<script id="fs" type="x-shader/x-fragment">
    precision highp float; uniform sampler2D t; uniform sampler2D lutTex;
    varying vec2 v; uniform vec2 res;
    uniform float brt,exp,con,sat,hue,boost,shadows,highlights,sm,wh,ros,nz,sharp;
    uniform float cmp, splitPos, lutStr, hasLut; 
    uniform vec4 lft,gam,gan,off;
    const vec3 W = vec3(0.299, 0.587, 0.114);

    vec3 satf(vec3 c, float s) { float g=dot(c,W); return mix(vec3(g),c,s); }
    vec3 rgb2hsv(vec3 c){vec4 K=vec4(0.,-1./3.,2./3.,-1.);vec4 p=mix(vec4(c.bg,K.wz),vec4(c.gb,K.xy),step(c.b,c.g));vec4 q=mix(vec4(p.xyw,c.r),vec4(c.r,p.yzx),step(p.x,c.r));float d=q.x-min(q.w,q.y);float e=1.0e-10;return vec3(abs(q.z+(q.w-q.y)/(6.*d+e)),d/(q.x+e),q.x);}
    vec3 hsv2rgb(vec3 c){vec4 K=vec4(1.,2./3.,1./3.,3.);vec3 p=abs(fract(c.xxx+K.xyz)*6.-K.www);return c.z*mix(K.xxx,clamp(p-K.xxx,0.,1.),c.y);}

    vec3 sampleLUT(vec3 c) {
        float size = 33.0;
        float sliceSize = 1.0 / size; 
        float slicePixelSize = sliceSize / size; 
        float width = size * size;
        float sliceInnerSize = slicePixelSize * (size - 1.0); 
        float zSlice0 = floor(c.b * (size - 1.0));
        float zSlice1 = min(size - 1.0, zSlice0 + 1.0);
        float xOffset = slicePixelSize * 0.5 + c.r * sliceInnerSize;
        float yOffset = slicePixelSize * 0.5 + c.g * sliceInnerSize;
        float s0 = xOffset + (zSlice0 * sliceSize);
        float s1 = xOffset + (zSlice1 * sliceSize);
        vec3 slice0Color = texture2D(lutTex, vec2(s0, yOffset)).rgb;
        vec3 slice1Color = texture2D(lutTex, vec2(s1, yOffset)).rgb;
        float zOffset = fract(c.b * (size - 1.0));
        return mix(slice0Color, slice1Color, zOffset);
    }

    void main(){
        vec4 px = texture2D(t, v); vec3 raw = px.rgb;
        if(cmp > 0.5 && v.x > splitPos) { gl_FragColor = vec4(raw, px.a); return; }
        vec3 c = raw;
        if(sharp > 0.0) { vec3 nb = texture2D(t, v + vec2(1.0,1.0)/res).rgb; c += (c - nb) * sharp * 2.0; }
        if(sm > 0.0) { vec2 d = vec2(2.0)/res; vec3 b = texture2D(t,v+d).rgb + texture2D(t,v-d).rgb; float isSkin = (c.r > c.g && c.g > c.b) ? 1.0 : 0.0; c = mix(c, b*0.5, sm * isSkin * 0.7); }
        if(wh > 0.0 && c.r > c.g && c.g > c.b) c = mix(c, pow(c, vec3(1.0 - wh*0.2)), 0.6);
        if(ros > 0.0 && c.r > c.g && c.g > c.b) c.r += ros * 0.06;
        if(abs(hue)>0.001){ vec3 h=rgb2hsv(c); h.x+=hue; c=hsv2rgb(h); }
        c += brt; c *= pow(2.0, exp); c = 0.5 + (c - 0.5) * con; c = satf(c, sat); c = satf(c, 1.0 + boost);
        float lum = dot(c, W); c += shadows * (1.0 - smoothstep(0.0, 0.5, lum)) * 0.2; c -= highlights * smoothstep(0.5, 1.0, lum) * 0.2;
        vec3 L = lft.rgb + lft.w; vec3 G = 1.0 / (1.0 + gam.rgb + gam.w); vec3 A = 1.0 + gan.rgb + gan.w; vec3 O = off.rgb + off.w;
        c = (c + L * 0.2) * A; c = pow(max(vec3(0.0), c), G); c += O * 0.2;
        if(hasLut > 0.5) { vec3 lutted = sampleLUT(clamp(c,0.0,1.0)); c = mix(c, lutted, lutStr); }
        gl_FragColor = vec4(c, px.a);
    }
</script>

<script>
    const presetsAI=[{id:'none',n:'ÂéüÂõæ',t:'RAW',v:{}},{id:'port',n:'‰∫∫ÂÉè',t:'SOFT',v:{sm:0.3,wh:0.2,con:1.05}},{id:'land',n:'È£éÊôØ',t:'VIVID',v:{sat:1.2,con:1.1,boost:0.1}},{id:'arch',n:'Âª∫Á≠ë',t:'HDR',v:{con:1.1,shadows:0.2,highlights:0.3}},{id:'food',n:'ÁæéÈ£ü',t:'WARM',v:{sat:1.2,gam:{r:0.05,w:0}}},{id:'plant',n:'Ê§çÁâ©',t:'FRESH',v:{sat:1.1,lft:{g:0.05,w:0}}},{id:'ani',n:'Âä®Áâ©',t:'SHARP',v:{con:1.15,exp:0.05,sharp:0.3}},{id:'mov',n:'ÁîµÂΩ±',t:'TEAL',v:{con:1.1,lft:{b:-0.1,w:0},gan:{r:0.1,w:0}}}];
    const presetsFilm=[{id:'fuji',n:'ÂØåÂ£´',t:'NC',v:{sat:1.1,lft:{b:0.08,w:0}}},{id:'kd',n:'ÊüØËææ',t:'GOLD',v:{sat:1.1,gam:{r:0.05,b:-0.05,w:0}}},{id:'leica',n:'ÂæïÂç°',t:'BW',v:{sat:0,con:1.3,lft:{r:-0.05,g:-0.05,b:-0.05,w:0}}},{id:'pana',n:'Êùæ‰∏ã',t:'LOG',v:{con:0.9,sat:0.9}},{id:'sony',n:'Á¥¢Â∞º',t:'STD',v:{con:1.2}},{id:'canon',n:'‰Ω≥ËÉΩ',t:'POR',v:{ros:0.1,sat:1.05}}];
    const adjParams = [{k:'exp',n:'ÊõùÂÖâ',min:-2,max:2,s:0.01},{k:'brt',n:'‰∫ÆÂ∫¶',min:-0.5,max:0.5,s:0.01},{k:'con',n:'ÂØπÊØîÂ∫¶',min:0,max:2,s:0.01},{k:'sat',n:'È•±ÂíåÂ∫¶',min:0,max:2,s:0.01},{k:'boost',n:'Ëâ≤ÂΩ©',min:0,max:1,s:0.01},{k:'sharp',n:'ÈîêÂåñ',min:0,max:1,s:0.01},{k:'shadows',n:'Èò¥ÂΩ±',min:-1,max:1,s:0.01},{k:'highlights',n:'È´òÂÖâ',min:-1,max:1,s:0.01},{k:'hue',n:'Ëâ≤Áõ∏',min:-0.5,max:0.5,s:0.01}];
    const porParams = [{k:'sm',n:'Á£®ÁöÆ',min:0,max:1,s:0.01},{k:'wh',n:'ÁæéÁôΩ',min:0,max:1,s:0.01},{k:'ros',n:'Á∫¢Ê∂¶',min:0,max:1,s:0.01},{k:'nz',n:'ÈôçÂô™',min:0,max:1,s:0.01},{k:'ana',n:'Êï¥‰ΩìÁò¶Ë∫´',min:0,max:1,s:0.01}];

    const def={brt:0,exp:0,con:1,sat:1,hue:0,boost:0,shadows:0,highlights:0,sm:0,wh:0,ros:0,nz:0,sharp:0,cmp:0,splitPos:0.5,ana:0,lft:{r:0,g:0,b:0,w:0},gam:{r:0,g:0,b:0,w:0},gan:{r:0,g:0,b:0,w:0},off:{r:0,g:0,b:0,w:0}};
    let st=JSON.parse(JSON.stringify(def));
    let gl, prog, tex, cvs=document.getElementById('gl');
    let lutTex; 
    let loadedLuts = []; 
    let activeLut = null; 
    let pendingLut = null; 
    let actWheel='lft'; let actParam={k:'exp',def:0};
    let state={zoom:1,panX:0,panY:0,lastDist:0,isDragging:false,startX:0,startY:0,mute:false};
    let audCtx=null;
    
    // Optimize Mesh: 20x20 is sufficient for mobile
    const MESH_GRID = 20; 
    let meshData = { p: null, u: null, count: 0 };
    let meshBackup = null; 
    let warpState = { active: false, radius: 0.15, mode: 'body' }; 

    window.onload=()=>{
        try{gl=cvs.getContext('webgl',{preserveDrawingBuffer:true});}catch(e){}
        if(!gl)return alert("WebGL Error");
        initGL(); renderPresets(); renderParamBars();
        initGestures(); initWheelUI(); initCompareDrag(); initDial(); initCropDrag(); initLutSlider(); initWarp();
        
        // Initialize Identity LUT to prevent black screen on load
        lutTex = gl.createTexture();
        gl.bindTexture(gl.TEXTURE_2D, lutTex);
        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR);
        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.LINEAR);
        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);
        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);
        // Dummy data for safety
        gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGB, 1, 1, 0, gl.RGB, gl.UNSIGNED_BYTE, new Uint8Array([0,0,0]));
    }

    function togSnd(){ state.mute=!state.mute; document.getElementById('btn-sound').innerText=state.mute?'üîá':'üîä'; }
    function tick(){
        if(state.mute) return;
        if(!audCtx){ try{audCtx=new (window.AudioContext||window.webkitAudioContext)();}catch(e){} }
        if(audCtx&&audCtx.state==='suspended') audCtx.resume();
        if(audCtx){
            const o=audCtx.createOscillator(); const g=audCtx.createGain();
            o.type='triangle'; o.frequency.setValueAtTime(600,audCtx.currentTime); o.frequency.exponentialRampToValueAtTime(100,audCtx.currentTime+0.04);
            g.gain.setValueAtTime(0.04,audCtx.currentTime); g.gain.exponentialRampToValueAtTime(0.001,audCtx.currentTime+0.04);
            o.connect(g); g.connect(audCtx.destination); o.start(); o.stop(audCtx.currentTime+0.05);
        }
        if(navigator.vibrate) navigator.vibrate(4);
    }

    function loadFile(el){
        if(!el.files.length)return; const f=el.files[0]; const img=new Image();
        img.onload=()=>{
            let w=img.width, h=img.height; const max=4096; if(w>max||h>max){const s=Math.min(max/w,max/h);w=Math.floor(w*s);h=Math.floor(h*s);}
            cvs.width=w; cvs.height=h;
            const area=document.getElementById('stage-area'); const padding=30; 
            const mw=area.clientWidth-padding; const mh=area.clientHeight-padding;
            let ratio=Math.min(mw/w, mh/h);
            const wrap=document.getElementById('canvas-wrap');
            wrap.style.width=(w*ratio)+'px'; wrap.style.height=(h*ratio)+'px'; wrap.style.display='block';
            const c=document.createElement('canvas');c.width=w;c.height=h;c.getContext('2d').drawImage(img,0,0,w,h);
            if(tex)gl.deleteTexture(tex); tex=gl.createTexture();
            gl.bindTexture(gl.TEXTURE_2D,tex); gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR); gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE); gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE); gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,c);
            document.getElementById('empty-state').style.display='none'; document.getElementById('float-btns').style.display='flex';
            state.zoom=1; state.panX=0; state.panY=0; updateTransform(); resetAll(true);
            
            // Safely recreate mesh for new image
            createGridMesh();
            
            requestAnimationFrame(()=>{gl.viewport(0,0,w,h);draw();});
            el.value = '';
        };
        img.src=URL.createObjectURL(f);
    }

    // --- Optimized Mesh System ---
    function createGridMesh() {
        const cols = MESH_GRID;
        const rows = MESH_GRID;
        const numVerts = cols * rows * 6; 
        meshData.p = new Float32Array(numVerts * 2);
        meshData.u = new Float32Array(numVerts * 2);
        meshData.count = numVerts;
        
        let i = 0;
        for (let y = 0; y < rows; y++) {
            for (let x = 0; x < cols; x++) {
                const x0 = (x / cols) * 2 - 1;
                const x1 = ((x+1) / cols) * 2 - 1;
                const y0 = (y / rows) * 2 - 1;
                const y1 = ((y+1) / rows) * 2 - 1;
                const u0 = x / cols;
                const u1 = (x+1) / cols;
                const v0 = 1.0 - (y / rows); 
                const v1 = 1.0 - ((y+1) / rows);
                
                meshData.p[i] = x0; meshData.p[i+1] = y0; meshData.u[i] = u0; meshData.u[i+1] = v0; i+=2;
                meshData.p[i] = x1; meshData.p[i+1] = y0; meshData.u[i] = u1; meshData.u[i+1] = v0; i+=2;
                meshData.p[i] = x0; meshData.p[i+1] = y1; meshData.u[i] = u0; meshData.u[i+1] = v1; i+=2;
                
                meshData.p[i] = x0; meshData.p[i+1] = y1; meshData.u[i] = u0; meshData.u[i+1] = v1; i+=2;
                meshData.p[i] = x1; meshData.p[i+1] = y0; meshData.u[i] = u1; meshData.u[i+1] = v0; i+=2;
                meshData.p[i] = x1; meshData.p[i+1] = y1; meshData.u[i] = u1; meshData.u[i+1] = v1; i+=2;
            }
        }
        uploadMesh();
    }
    
    function uploadMesh() {
        // Rebind to ensure state is clean
        gl.bindBuffer(gl.ARRAY_BUFFER, gl.createBuffer()); 
        gl.bufferData(gl.ARRAY_BUFFER, meshData.p, gl.DYNAMIC_DRAW);
        const p = gl.getAttribLocation(prog, "p");
        gl.vertexAttribPointer(p, 2, gl.FLOAT, false, 0, 0);
        gl.enableVertexAttribArray(p);

        gl.bindBuffer(gl.ARRAY_BUFFER, gl.createBuffer());
        gl.bufferData(gl.ARRAY_BUFFER, meshData.u, gl.STATIC_DRAW);
        const u = gl.getAttribLocation(prog, "u");
        gl.vertexAttribPointer(u, 2, gl.FLOAT, false, 0, 0);
        gl.enableVertexAttribArray(u);
    }

    function updateMeshP() {
        // Partial update for warp - just re-upload P buffer
        const p = gl.getAttribLocation(prog, "p");
        gl.bufferData(gl.ARRAY_BUFFER, meshData.p, gl.DYNAMIC_DRAW); 
        gl.vertexAttribPointer(p, 2, gl.FLOAT, false, 0, 0);
    }

    function initGL(){
        const vs=gl.createShader(gl.VERTEX_SHADER);gl.shaderSource(vs,document.getElementById('vs').text);gl.compileShader(vs);
        const fs=gl.createShader(gl.FRAGMENT_SHADER);gl.shaderSource(fs,document.getElementById('fs').text);gl.compileShader(fs);
        prog=gl.createProgram();gl.attachShader(prog,vs);gl.attachShader(prog,fs);gl.linkProgram(prog);gl.useProgram(prog);
        createGridMesh(); 
    }
    
    function draw(){
        if(!tex)return; gl.useProgram(prog); 
        const f=(k,v)=>gl.uniform1f(gl.getUniformLocation(prog,k),v);
        f("brt",st.brt);f("exp",st.exp);f("con",st.con);f("sat",st.sat);f("hue",st.hue);f("boost",st.boost);
        f("shadows",st.shadows);f("highlights",st.highlights);f("sharp",st.sharp);
        f("sm",st.sm);f("wh",st.wh);f("ros",st.ros);f("nz",st.nz);f("cmp",st.cmp);f("splitPos",st.splitPos);
        f("ana", st.ana); 
        
        gl.uniform2f(gl.getUniformLocation(prog,"res"),cvs.width,cvs.height);
        const v4=(k,v)=>gl.uniform4f(gl.getUniformLocation(prog,k),v.r,v.g,v.b,v.w);
        v4("lft",st.lft);v4("gam",st.gam);v4("gan",st.gan);v4("off",st.off);
        
        gl.uniform1i(gl.getUniformLocation(prog, "t"), 0);
        gl.uniform1i(gl.getUniformLocation(prog, "lutTex"), 1);
        
        gl.activeTexture(gl.TEXTURE0); gl.bindTexture(gl.TEXTURE_2D, tex);
        
        // Always bind something to unit 1 to avoid crash
        gl.activeTexture(gl.TEXTURE1); 
        if(activeLut) {
            gl.uniform1f(gl.getUniformLocation(prog, "hasLut"), 1.0);
            gl.uniform1f(gl.getUniformLocation(prog, "lutStr"), activeLut.str);
            gl.bindTexture(gl.TEXTURE_2D, activeLut.tex);
        } else {
            gl.uniform1f(gl.getUniformLocation(prog, "hasLut"), 0.0);
            gl.bindTexture(gl.TEXTURE_2D, lutTex); // Bind dummy
        }

        gl.drawArrays(gl.TRIANGLES, 0, meshData.count);
    }

    // --- Warp / Liquify Logic ---
    function initWarp() {
        const area = document.getElementById('warp-overlay');
        let isWarping = false;
        let lx=0, ly=0;
        
        area.addEventListener('touchstart', e=>{
            if (e.target.closest('.c-act-btn')) return; 
            isWarping = true;
            e.stopPropagation(); e.preventDefault();
            const t = e.touches[0];
            const r = area.getBoundingClientRect();
            lx = ((t.clientX - r.left) / r.width) * 2 - 1;
            ly = -(((t.clientY - r.top) / r.height) * 2 - 1); 
            
            const g = document.getElementById('warp-guide');
            g.style.left = t.clientX + 'px';
            g.style.top = t.clientY + 'px';
            g.style.display = 'block';
        });
        
        area.addEventListener('touchmove', e=>{
            if(!isWarping) return;
            e.stopPropagation(); e.preventDefault();
            const t = e.touches[0];
            const r = area.getBoundingClientRect();
            
            const cx = ((t.clientX - r.left) / r.width) * 2 - 1;
            const cy = -(((t.clientY - r.top) / r.height) * 2 - 1);
            
            const dx = cx - lx;
            const dy = cy - ly;
            
            const radius = warpState.radius; 
            const str = 0.5;
            
            let changed = false;
            for(let i=0; i<meshData.p.length; i+=2) {
                const vx = meshData.p[i];
                const vy = meshData.p[i+1]; 
                const dist = Math.sqrt((vx-cx)*(vx-cx) + (vy-cy)*(vy-cy));
                
                if(dist < radius) {
                    const falloff = Math.pow(1.0 - dist/radius, 2);
                    meshData.p[i] += dx * falloff * str;
                    meshData.p[i+1] += dy * falloff * str;
                    changed = true;
                }
            }
            
            if(changed) {
                updateMeshP();
                draw();
            }
            
            lx = cx; ly = cy;
            
            const g = document.getElementById('warp-guide');
            g.style.left = t.clientX + 'px';
            g.style.top = t.clientY + 'px';
        });
        
        area.addEventListener('touchend', ()=>{
            isWarping = false;
            document.getElementById('warp-guide').style.display = 'none';
        });
    }

    window.toggleWarp = (active, mode) => {
        const o = document.getElementById('warp-overlay');
        const guide = document.getElementById('warp-guide');
        if(active) {
            meshBackup = new Float32Array(meshData.p);
            warpState.active = true;
            warpState.mode = mode;
            warpState.radius = mode === 'body' ? 0.3 : 0.12; 
            o.style.display = 'block';
            guide.style.width = guide.style.height = (warpState.radius * cvs.offsetWidth) + 'px'; 
            document.querySelector('.warp-msg').innerText = mode==='body' ? "ÊãñÊãΩËÖ∞ÈÉ®/ËÖøÈÉ®ËøõË°åÁò¶Ë∫´" : "ÊãñÊãΩËÑ∏ÈÉ®ËæπÁºòËøõË°å‰øÆÊï¥";
        } else {
            warpState.active = false;
            o.style.display = 'none';
        }
    }
    
    window.cancelWarp = () => {
        if(meshBackup) {
            meshData.p = new Float32Array(meshBackup);
            updateMeshP();
            draw();
        }
        toggleWarp(false);
    }
    
    window.applyWarp = () => {
        toggleWarp(false);
    }

    // --- LUT System ---
    function loadLutFiles(el) {
        if(!el.files.length) return;
        const list = document.getElementById('lut-list');
        if(loadedLuts.length === 0) list.innerHTML = '';
        
        Array.from(el.files).forEach(file => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const content = e.target.result;
                const rawData = parseCube(content);
                if(rawData) {
                    const size = 33;
                    const reordered = new Uint8Array(size * size * size * 3);
                    let texIdx = 0;
                    for (let y = 0; y < size; y++) {        
                        for (let x = 0; x < size * size; x++) { 
                            const b = Math.floor(x / size);
                            const r = x % size;
                            const cubeIdx = (b * size * size + y * size + r) * 3;
                            reordered[texIdx++] = rawData[cubeIdx];
                            reordered[texIdx++] = rawData[cubeIdx+1];
                            reordered[texIdx++] = rawData[cubeIdx+2];
                        }
                    }

                    const t = gl.createTexture();
                    gl.bindTexture(gl.TEXTURE_2D, t);
                    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR);
                    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.LINEAR);
                    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);
                    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);
                    gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGB, 33*33, 33, 0, gl.RGB, gl.UNSIGNED_BYTE, reordered);
                    
                    const id = Date.now() + Math.random();
                    const lutObj = { id: id, name: file.name.replace('.cube',''), tex: t, str: 0.05 };
                    loadedLuts.push(lutObj);
                    
                    const div = document.createElement('div');
                    div.className = 'lut-item';
                    div.id = 'lut-item-' + id;
                    div.innerHTML = `<span>${lutObj.name}</span><span class="lut-tag">CUBE</span>`;
                    div.onclick = () => openLutAdjust(lutObj);
                    list.appendChild(div);
                }
            };
            reader.readAsText(file);
        });
        el.value = '';
    }

    function parseCube(text) {
        const lines = text.split('\n');
        let data = [];
        for(let line of lines) {
            line = line.trim();
            if(!line || line.startsWith('#') || line.startsWith('TITLE') || line.startsWith('LUT') || line.startsWith('DOMAIN')) continue;
            const parts = line.split(' ');
            if(parts.length >= 3 && !isNaN(parseFloat(parts[0]))) {
                data.push(Math.floor(parseFloat(parts[0]) * 255));
                data.push(Math.floor(parseFloat(parts[1]) * 255));
                data.push(Math.floor(parseFloat(parts[2]) * 255));
            }
        }
        if(data.length < 33*33*33*3) return null;
        return new Uint8Array(data);
    }

    let sliderState = { isDrag: false };
    function initLutSlider() {
        const box = document.getElementById('la-slider');
        const knob = document.getElementById('la-knob');
        const fill = document.getElementById('la-fill');
        
        const update = (cX) => {
            const r = box.getBoundingClientRect();
            let pct = (cX - r.left) / r.width;
            pct = Math.max(0, Math.min(1, pct));
            knob.style.left = (pct*100) + '%';
            fill.style.width = (pct*100) + '%';
            document.getElementById('la-val').innerText = Math.round(pct*100) + '%';
            if(pendingLut) {
                pendingLut.str = pct;
                activeLut = pendingLut; 
                draw();
            }
        };
        
        box.addEventListener('touchstart', e=>{ sliderState.isDrag=true; update(e.touches[0].clientX); e.preventDefault(); });
        window.addEventListener('touchmove', e=>{ if(sliderState.isDrag) update(e.touches[0].clientX); });
        window.addEventListener('touchend', ()=>{ sliderState.isDrag=false; });
    }

    function openLutAdjust(lut) {
        pendingLut = { ...lut }; 
        document.getElementById('lut-adjust-overlay').style.display = 'flex'; 
        const pct = pendingLut.str;
        document.getElementById('la-knob').style.left = (pct*100)+'%';
        document.getElementById('la-fill').style.width = (pct*100)+'%';
        document.getElementById('la-val').innerText = Math.round(pct*100) + '%';
        activeLut = pendingLut;
        draw();
    }
    
    window.closeLutAdj = (apply) => {
        document.getElementById('lut-adjust-overlay').style.display = 'none';
        if(apply) {
            const idx = loadedLuts.findIndex(l => l.id === pendingLut.id);
            if(idx !== -1) loadedLuts[idx].str = pendingLut.str;
            activeLut = loadedLuts[idx];
            document.querySelectorAll('.lut-item').forEach(i=>i.classList.remove('active'));
            if(activeLut) document.getElementById('lut-item-'+activeLut.id).classList.add('active');
            tick();
        } else {
            activeLut = null;
            document.querySelectorAll('.lut-item').forEach(i=>i.classList.remove('active'));
            draw();
        }
        pendingLut = null;
    }

    window.generateLut = () => {
        if(!tex) return;
        const size = 33;
        const width = size * size; 
        const height = size;       
        const data = new Uint8Array(width * height * 4);
        let idx = 0;
        for(let y=0; y<height; y++) {
            const g = y / (size - 1);
            for(let x=0; x<width; x++) {
                const b = Math.floor(x / size) / (size - 1);
                const r = (x % size) / (size - 1);
                data[idx++] = r * 255;
                data[idx++] = g * 255;
                data[idx++] = b * 255;
                data[idx++] = 255;
            }
        }
        
        const idTex = gl.createTexture();
        gl.bindTexture(gl.TEXTURE_2D, idTex);
        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST);
        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);
        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);
        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);
        gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, width, height, 0, gl.RGBA, gl.UNSIGNED_BYTE, data);

        const oldV = gl.getParameter(gl.VIEWPORT);
        gl.bindTexture(gl.TEXTURE_2D, idTex);
        gl.viewport(0, 0, width, height);
        
        gl.drawArrays(gl.TRIANGLES, 0, meshData.count);
        
        const result = new Uint8Array(width * height * 4);
        gl.readPixels(0, 0, width, height, gl.RGBA, gl.UNSIGNED_BYTE, result);
        
        gl.viewport(oldV[0], oldV[1], oldV[2], oldV[3]);
        gl.bindTexture(gl.TEXTURE_2D, tex);
        gl.deleteTexture(idTex);
        draw(); 
        
        let fileStr = "TITLE \"Generated_By_LUMINA\"\nLUT_3D_SIZE 33\nDOMAIN_MIN 0.0 0.0 0.0\nDOMAIN_MAX 1.0 1.0 1.0\n\n";
        
        for(let b=0; b<size; b++) {
            for(let g=0; g<size; g++) {
                for(let r=0; r<size; r++) {
                    const tx = b * size + r;
                    const ty = g;
                    const i = (ty * width + tx) * 4;
                    const valR = (result[i] / 255).toFixed(6);
                    const valG = (result[i+1] / 255).toFixed(6);
                    const valB = (result[i+2] / 255).toFixed(6);
                    fileStr += `${valR} ${valG} ${valB}\n`;
                }
            }
        }
        
        const blob = new Blob([fileStr], {type: "text/plain"});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = "LUMINA_Looks.cube";
        a.click();
        const t=document.getElementById('toast');
        t.innerText = "LUT Â∑≤ÂØºÂá∫";
        t.style.opacity=1;setTimeout(()=>t.style.opacity=0,2000);
        tick();
    }

    // --- UI Logic ---
    function renderPresets(){
        const con=document.getElementById('preset-list');
        let h='<div class="grp-label">Êô∫ËÉΩÂú∫ÊôØ</div>';
        presetsAI.forEach(p=>{h+=`<div class="p-chip" onclick="applyPre(this,'${p.id}','ai')"><span class="p-name">${p.n}</span><span class="p-tag">${p.t}</span></div>`;});
        h+='<div class="grp-label" style="margin-left:15px">ËÉ∂ÁâáÊ®°Êãü</div>';
        presetsFilm.forEach(p=>{h+=`<div class="p-chip" onclick="applyPre(this,'${p.id}','film')"><span class="p-name">${p.n}</span><span class="p-tag">${p.t}</span></div>`;});
        con.innerHTML=h;
    }
    function renderParamBars(){
        const mk=(arr,id)=>{document.getElementById(id).innerHTML=arr.map((p,i)=>`<div class="param-item ${i===0?'active':''}" onclick="selParam('${p.k}',this,'${id}')">${p.n.toUpperCase()}</div>`).join('');};
        mk(adjParams,'adj-params'); mk(porParams,'por-params');
    }

    function initDial(){
        ['adj-dial','por-dial'].forEach(id=>{
            const el=document.getElementById(id); let sx=0,sv=0,lx=0;
            const update=(dx)=>{
                const cfg=[...adjParams,...porParams].find(x=>x.k===actParam.k); if(!cfg)return;
                let v=sv+dx*cfg.s*0.2; v=Math.max(cfg.min,Math.min(cfg.max,v)); st[actParam.k]=v;
                
                const dVal = (v>0?'+':'')+v.toFixed(2);
                if(document.getElementById('dial-val')) document.getElementById('dial-val').innerText=dVal;
                if(document.getElementById('por-val')) document.getElementById('por-val').innerText=dVal;
                
                el.querySelector('.dial-track').style.backgroundPositionX=(dx*3)+'px';
                draw(); if(Math.abs(dx-lx)>5){ tick(); lx=dx; }
            };
            el.addEventListener('touchstart',e=>{sx=e.touches[0].clientX;sv=st[actParam.k];lx=0;e.stopPropagation();},{passive:false});
            el.addEventListener('touchmove',e=>{e.preventDefault();e.stopPropagation();update(e.touches[0].clientX-sx);},{passive:false});
        });
    }
    window.selParam=(k,el,barId)=>{
        document.getElementById(barId).querySelectorAll('.param-item').forEach(e=>e.classList.remove('active')); el.classList.add('active');
        actParam={k:k}; 
        const val=st[k]||0; const dVal=(val>0?'+':'')+val.toFixed(2);
        if(document.getElementById('dial-val')) document.getElementById('dial-val').innerText=dVal;
        if(document.getElementById('por-val')) document.getElementById('por-val').innerText=dVal;
        document.querySelectorAll('.dial-track').forEach(t => t.style.backgroundPositionX = '0px');
        tick();
    };

    function initWheelUI(){
        const zone=document.getElementById('wheel-zone');
        const hW=(e)=>{
            e.preventDefault(); e.stopPropagation();
            const rect=zone.getBoundingClientRect(); const t=e.touches[0]||e;
            let dx=(t.clientX-(rect.left+rect.width/2))/(rect.width/2);
            let dy=(t.clientY-(rect.top+rect.height/2))/(rect.height/2);
            const dist=Math.sqrt(dx*dx+dy*dy); if(dist>1){dx/=dist;dy/=dist;}
            if(st[actWheel]){ 
                st[actWheel].r=dx*0.25; st[actWheel].b=-dy*0.25; 
                st[actWheel].g=-(st[actWheel].r+st[actWheel].b)*0.5;
                updWheelVis(); draw(); 
                if(Math.random()>0.7) tick();
            }
        };
        zone.addEventListener('touchstart',hW,{passive:false}); zone.addEventListener('touchmove',hW,{passive:false});
        zone.addEventListener('dblclick',()=>{if(st[actWheel]){st[actWheel]={r:0,g:0,b:0,w:0};updWheelVis();draw();tick();}});

        ['r','g','b','y'].forEach(ch=>{
            const gear=document.getElementById('gw-'+ch); let sY=0, sV=0, ly=0;
            const targetKey=ch==='y'?'w':ch;
            gear.addEventListener('touchstart',e=>{ sY=e.touches[0].clientY; sV=st[actWheel][targetKey]; ly=0; e.stopPropagation(); },{passive:false});
            gear.addEventListener('touchmove',e=>{
                e.preventDefault(); e.stopPropagation();
                const dy=sY-e.touches[0].clientY; 
                let val=sV+dy*0.005; val=Math.max(-0.5,Math.min(0.5,val));
                st[actWheel][targetKey]=val;
                if(ch==='y'){
                    const lum = 120 - val * 100;
                    document.getElementById('wheel-box').style.background = `radial-gradient(circle, #222, #000 ${lum}%)`;
                }
                updWheelVis(); draw();
                if(Math.abs(dy-ly)>8){ tick(); ly=dy; }
            },{passive:false});
        });
    }

    function updWheelVis(){
        if(!st[actWheel])return;
        const x=(st[actWheel].r/0.25)*50; const y=-(st[actWheel].b/0.25)*50;
        document.getElementById('wheel-puck').style.transform=`translate(calc(-50% + ${x}%), calc(-50% + ${y}%))`;
        const map={r:'r',g:'g',b:'b',y:'w'};
        for(let k in map){
            const val=st[actWheel][map[k]]; 
            document.getElementById('gm-'+k).style.transform=`rotate(${val*300}deg) translateX(-17px)`;
        }
    }
    window.setWheelTab=(w)=>{
        actWheel=w; document.querySelectorAll('.c-btn').forEach(b=>b.classList.remove('active'));
        document.getElementById('t-'+w).classList.add('active'); updWheelVis(); tick();
    };

    function initCropDrag(){
        const box=document.getElementById('crop-box'); let s=null;
        box.addEventListener('touchstart',e=>{
            if(e.target.className.includes('crop-handle')){
                e.stopPropagation();e.preventDefault();const t=e.touches[0];
                s={mode:'resize',d:e.target.dataset.d,mx:t.clientX,my:t.clientY,cw:box.offsetWidth,ch:box.offsetHeight,cl:box.offsetLeft,ct:box.offsetTop};
            }else if(e.target===box||e.target.className==='crop-grid'){
                e.stopPropagation();e.preventDefault();const t=e.touches[0];
                s={mode:'move',mx:t.clientX,my:t.clientY,cl:box.offsetLeft,ct:box.offsetTop};
            }
        },{passive:false});
        window.addEventListener('touchmove',e=>{
            if(!s)return;const t=e.touches[0];const dx=t.clientX-s.mx;const dy=t.clientY-s.my;
            if(s.mode==='move'){box.style.left=(s.cl+dx)+'px';box.style.top=(s.ct+dy)+'px';}
            else{
                let nw=s.cw,nh=s.ch;
                if(s.d.includes('e'))nw+=dx; if(s.d.includes('s'))nh+=dy;
                if(s.d.includes('w')){nw-=dx;box.style.left=(s.cl+dx)+'px';} if(s.d.includes('n')){nh-=dy;box.style.top=(s.ct+dy)+'px';}
                box.style.width=Math.max(50,nw)+'px'; box.style.height=Math.max(50,nh)+'px';
            }
        },{passive:false});
        window.addEventListener('touchend',()=>s=null);
    }
    window.toggleCrop=(show)=>{
        const ui=document.getElementById('crop-ui');
        if(show&&tex){
            ui.style.display='block'; const wrap=document.getElementById('canvas-wrap');
            const b=document.getElementById('crop-box');
            b.style.width=wrap.offsetWidth*0.8+'px'; b.style.height=wrap.offsetHeight*0.8+'px';
            b.style.left=wrap.offsetWidth*0.1+'px'; b.style.top=wrap.offsetHeight*0.1+'px';
        }else{ui.style.display='none';}
        tick();
    }
    window.applyCrop=()=>{
        const b=document.getElementById('crop-box'); const wrap=document.getElementById('canvas-wrap');
        const scaleX=cvs.width/wrap.offsetWidth; const scaleY=cvs.height/wrap.offsetHeight;
        const cx=b.offsetLeft*scaleX; const cy=b.offsetTop*scaleY; const cw=b.offsetWidth*scaleX; const ch=b.offsetHeight*scaleY;
        const tc=document.createElement('canvas'); tc.width=cw; tc.height=ch;
        tc.getContext('2d').drawImage(cvs,cx,cy,cw,ch,0,0,cw,ch);
        cvs.width=cw; cvs.height=ch;
        const area=document.getElementById('stage-area');
        const ratio=Math.min((area.clientWidth-30)/cw, (area.clientHeight-30)/ch);
        wrap.style.width=(cw*ratio)+'px'; wrap.style.height=(ch*ratio)+'px';
        gl.bindTexture(gl.TEXTURE_2D,tex); gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,tc);
        const oldMute=state.mute; resetAll(false); state.mute=oldMute;
        gl.viewport(0,0,cw,ch); toggleCrop(false); st.cmp=0; draw(); tick();
    }

    window.exportImg=()=>{if(!tex)return;const o=st.cmp;st.cmp=0;draw();const a=document.createElement('a');a.download='LUMINA_Pro.jpg';a.href=cvs.toDataURL('image/jpeg',0.95);a.click();const t=document.getElementById('toast');t.style.opacity=1;setTimeout(()=>t.style.opacity=0,2000);st.cmp=o;draw();tick();};
    
    window.resetAll=(isInit=false)=>{
        st=JSON.parse(JSON.stringify(def));
        if(!isInit){
            document.querySelectorAll('.dial-track').forEach(d => d.style.backgroundPositionX = '0px');
            document.querySelectorAll('.dial-val').forEach(d => d.innerText = '0.00');
            document.querySelectorAll('.p-chip').forEach(c=>c.classList.remove('active'));
            activeLut = null; 
            document.querySelectorAll('.lut-item').forEach(i=>i.classList.remove('active'));
            createGridMesh(); // Reset geometry
            nav('adj', document.querySelectorAll('.nav-item')[1]);
            updWheelVis(); draw(); tick();
        }
    };

    window.nav=(id,el)=>{
        document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active')); document.getElementById('p-'+id).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active')); el.classList.add('active');
        
        if(id === 'adj') {
            const first = document.querySelector('#adj-params .param-item');
            if(first) selParam('exp', first, 'adj-params');
        } else if (id === 'por') {
            const first = document.querySelector('#por-params .param-item');
            if(first) selParam('sm', first, 'por-params');
        } else if(id === 'col') {
            setTimeout(updWheelVis,50);
        }
        tick();
    };

    function initGestures(){
        const area=document.getElementById('stage-area');
        area.addEventListener('touchstart',e=>{
            if(warpState.active) return;
            if(e.touches.length===1&&!st.cmp){state.isDragging=true;state.startX=e.touches[0].clientX-state.panX;state.startY=e.touches[0].clientY-state.panY;}
            else if(e.touches.length===2){state.isDragging=false;state.lastDist=Math.hypot(e.touches[0].clientX-e.touches[1].clientX,e.touches[0].clientY-e.touches[1].clientY);}
        },{passive:false});
        area.addEventListener('touchmove',e=>{
            if(!tex)return;e.preventDefault();
            if(warpState.active) return;
            if(e.touches.length===1&&state.isDragging&&!st.cmp){state.panX=e.touches[0].clientX-state.startX;state.panY=e.touches[0].clientY-state.startY;updateTransform();}
            else if(e.touches.length===2){const dist=Math.hypot(e.touches[0].clientX-e.touches[1].clientX,e.touches[0].clientY-e.touches[1].clientY);if(dist>0&&state.lastDist>0){state.zoom*=dist/state.lastDist;state.zoom=Math.max(0.5,Math.min(5,state.zoom));updateTransform();}state.lastDist=dist;}
        },{passive:false});
        area.addEventListener('touchend',()=>{state.isDragging=false;});
    }
    function updateTransform(){document.getElementById('canvas-wrap').style.transform=`translate(${state.panX}px,${state.panY}px) scale(${state.zoom})`;}
    window.toggleCompare=()=>{if(!tex)return;st.cmp=st.cmp?0:1;const b=document.getElementById('btn-comp'),o=document.getElementById('compare-overlay');if(st.cmp){b.classList.add('active');o.style.display='block';st.splitPos=0.5;document.getElementById('split-line').style.left='50%';}else{b.classList.remove('active');o.style.display='none';}draw();tick();}
    function initCompareDrag(){const ov=document.getElementById('compare-overlay'),l=document.getElementById('split-line');ov.addEventListener('touchstart',e=>{if(!st.cmp)return;e.preventDefault();e.stopPropagation();},{passive:false});ov.addEventListener('touchmove',e=>{if(!st.cmp)return;e.preventDefault();e.stopPropagation();const r=ov.getBoundingClientRect();let x=e.touches[0].clientX-r.left;x=Math.max(0,Math.min(r.width,x));st.splitPos=x/r.width;l.style.left=(st.splitPos*100)+'%';draw();},{passive:false});}
</script>
</body>
</html>
