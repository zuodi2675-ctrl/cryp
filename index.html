<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>加密货币实时价格与分析</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- D3.js for charting -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117;
            color: #c9d1d9;
        }
        .main-container {
            max-width: 900px;
            transform-origin: center center;
            transition: transform 0.2s ease-in-out;
        }
        .price-card {
            min-width: 200px;
        }
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid #3498db;
            width: 30px;
            height: 30px;
            -webkit-animation: spin 1s linear infinite; /* Safari */
            animation: spin 1s linear infinite;
        }
        /* Safari */
        @-webkit-keyframes spin {
            0% { -webkit-transform: rotate(0deg); }
            100% { -webkit-transform: rotate(360deg); }
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .modal {
            transition: opacity 0.3s ease-in-out;
        }
        .chart-container {
            width: 100%;
            height: 200px;
        }
        .chart-tooltip {
            position: absolute;
            text-align: center;
            width: auto;
            height: auto;
            padding: 8px;
            font-size: 12px;
            background: #2d3748; /* bg-gray-800 */
            border: 0px;
            border-radius: 8px;
            pointer-events: none;
            color: #fff;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
    </style>
</head>
<body class="p-4">

    <!-- 主容器 -->
    <div class="main-container mx-auto p-6 bg-gray-800 rounded-2xl shadow-xl">
        
        <!-- 5分钟倒计时、周期计数器和新的提醒按钮排列在同一行 -->
        <div class="flex items-center justify-between bg-gray-900 rounded-xl p-4 mb-8 shadow-inner">
            <h2 class="text-lg font-semibold text-gray-300">5分钟趋势分析周期</h2>
            <p id="timer-display" class="text-4xl font-bold text-yellow-400 mt-2">
                <span id="cycle-countdown">05:00</span>
                <span class="text-lg text-gray-400 font-normal ml-4" id="cycle-counter"> (第 1 周期 / 12)</span>
            </p>
            <!-- 统一的提醒设置按钮 -->
            <button id="set-alert-main-btn" class="bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-semibold py-2 px-6 mt-0 rounded-full text-sm transition-colors duration-300">设置价格提醒</button>
        </div>

        <!-- 缩放控制按钮 -->
        <div class="flex items-center justify-center mb-6 space-x-4">
            <button id="zoom-out" class="w-10 h-10 bg-gray-700 text-white rounded-full font-bold text-2xl hover:bg-gray-600 transition-colors">-</button>
            <span class="text-lg text-gray-400">缩放</span>
            <button id="zoom-in" class="w-10 h-10 bg-gray-700 text-white rounded-full font-bold text-2xl hover:bg-gray-600 transition-colors">+</button>
        </div>

        <!-- 实时价格展示区 -->
        <div id="price-display" class="flex flex-col gap-6 mb-8">
            <!-- BTC 价格卡片 -->
            <div id="btc-card" class="price-card p-6 bg-gray-700 rounded-xl shadow-lg transition-transform transform hover:scale-105" data-symbol="BTC">
                <h2 class="text-xl font-semibold mb-2 text-blue-400">BTC/USDT</h2>
                <div class="flex items-center justify-between">
                    <p class="flex items-center text-4xl font-bold text-white">
                        <span id="btc-price">-</span>
                        <span id="btc-trend-indicator" class="ml-2 text-2xl font-bold"></span>
                        <span id="btc-stars" class="ml-2 text-xl text-yellow-400"></span>
                    </p>
                    <div class="flex flex-col space-y-2">
                         <!-- "AI 交易分析" 按钮已移除 -->
                    </div>
                </div>
                 <!-- 价格曲线图容器 -->
                <div id="btc-chart-container" class="chart-container mt-4"></div>
            </div>
            <!-- ETH 价格卡片 -->
            <div id="eth-card" class="price-card p-6 bg-gray-700 rounded-xl shadow-lg transition-transform transform hover:scale-105" data-symbol="ETH">
                <h2 class="text-xl font-semibold mb-2 text-purple-400">ETH/USDT</h2>
                <div class="flex items-center justify-between">
                    <p class="flex items-center text-4xl font-bold text-white">
                        <span id="eth-price">-</span>
                        <span id="eth-trend-indicator" class="ml-2 text-2xl font-bold"></span>
                        <span id="eth-stars" class="ml-2 text-xl text-yellow-400"></span>
                    </p>
                    <div class="flex flex-col space-y-2">
                        <!-- "AI 交易分析" 按钮已移除 -->
                    </div>
                </div>
                <!-- 价格曲线图容器 -->
                <div id="eth-chart-container" class="chart-container mt-4"></div>
            </div>
            <!-- SOL 价格卡片 -->
            <div id="sol-card" class="price-card p-6 bg-gray-700 rounded-xl shadow-lg transition-transform transform hover:scale-105" data-symbol="SOL">
                <h2 class="text-xl font-semibold mb-2 text-emerald-400">SOL/USDT</h2>
                <div class="flex items-center justify-between">
                    <p class="flex items-center text-4xl font-bold text-white">
                        <span id="sol-price">-</span>
                        <span id="sol-trend-indicator" class="ml-2 text-2xl font-bold"></span>
                        <span id="sol-stars" class="ml-2 text-xl text-yellow-400"></span>
                    </p>
                    <div class="flex flex-col space-y-2">
                        <!-- "AI 交易分析" 按钮已移除 -->
                    </div>
                </div>
                <!-- 价格曲线图容器 -->
                <div id="sol-chart-container" class="chart-container mt-4"></div>
            </div>

            <!-- 新增币种卡片 -->
            <!-- PEOPLE 价格卡片 -->
            <div id="people-card" class="price-card p-6 bg-gray-700 rounded-xl shadow-lg transition-transform transform hover:scale-105" data-symbol="PEOPLE">
                <h2 class="text-xl font-semibold mb-2 text-amber-400">PEOPLE/USDT</h2>
                <div class="flex items-center justify-between">
                    <p class="flex items-center text-4xl font-bold text-white">
                        <span id="people-price">-</span>
                        <span id="people-trend-indicator" class="ml-2 text-2xl font-bold"></span>
                        <span id="people-stars" class="ml-2 text-xl text-yellow-400"></span>
                    </p>
                </div>
                <div id="people-chart-container" class="chart-container mt-4"></div>
            </div>
            <!-- PNUT 价格卡片 -->
            <div id="pnut-card" class="price-card p-6 bg-gray-700 rounded-xl shadow-lg transition-transform transform hover:scale-105" data-symbol="PNUT">
                <h2 class="text-xl font-semibold mb-2 text-pink-400">PNUT/USDT</h2>
                <div class="flex items-center justify-between">
                    <p class="flex items-center text-4xl font-bold text-white">
                        <span id="pnut-price">-</span>
                        <span id="pnut-trend-indicator" class="ml-2 text-2xl font-bold"></span>
                        <span id="pnut-stars" class="ml-2 text-xl text-yellow-400"></span>
                    </p>
                </div>
                <div id="pnut-chart-container" class="chart-container mt-4"></div>
            </div>
            <!-- SUI 价格卡片 -->
            <div id="sui-card" class="price-card p-6 bg-gray-700 rounded-xl shadow-lg transition-transform transform hover:scale-105" data-symbol="SUI">
                <h2 class="text-xl font-semibold mb-2 text-teal-400">SUI/USDT</h2>
                <div class="flex items-center justify-between">
                    <p class="flex items-center text-4xl font-bold text-white">
                        <span id="sui-price">-</span>
                        <span id="sui-trend-indicator" class="ml-2 text-2xl font-bold"></span>
                        <span id="sui-stars" class="ml-2 text-xl text-yellow-400"></span>
                    </p>
                </div>
                <div id="sui-chart-container" class="chart-container mt-4"></div>
            </div>
            <!-- WIF 价格卡片 -->
            <div id="wif-card" class="price-card p-6 bg-gray-700 rounded-xl shadow-lg transition-transform transform hover:scale-105" data-symbol="WIF">
                <h2 class="text-xl font-semibold mb-2 text-orange-400">WIF/USDT</h2>
                <div class="flex items-center justify-between">
                    <p class="flex items-center text-4xl font-bold text-white">
                        <span id="wif-price">-</span>
                        <span id="wif-trend-indicator" class="ml-2 text-2xl font-bold"></span>
                        <span id="wif-stars" class="ml-2 text-xl text-yellow-400"></span>
                    </p>
                </div>
                <div id="wif-chart-container" class="chart-container mt-4"></div>
            </div>
            <!-- AAVE 价格卡片 -->
            <div id="aave-card" class="price-card p-6 bg-gray-700 rounded-xl shadow-lg transition-transform transform hover:scale-105" data-symbol="AAVE">
                <h2 class="text-xl font-semibold mb-2 text-indigo-400">AAVE/USDT</h2>
                <div class="flex items-center justify-between">
                    <p class="flex items-center text-4xl font-bold text-white">
                        <span id="aave-price">-</span>
                        <span id="aave-trend-indicator" class="ml-2 text-2xl font-bold"></span>
                        <span id="aave-stars" class="ml-2 text-xl text-yellow-400"></span>
                    </p>
                </div>
                <div id="aave-chart-container" class="chart-container mt-4"></div>
            </div>
            <!-- CRV 价格卡片 -->
            <div id="crv-card" class="price-card p-6 bg-gray-700 rounded-xl shadow-lg transition-transform transform hover:scale-105" data-symbol="CRV">
                <h2 class="text-xl font-semibold mb-2 text-red-400">CRV/USDT</h2>
                <div class="flex items-center justify-between">
                    <p class="flex items-center text-4xl font-bold text-white">
                        <span id="crv-price">-</span>
                        <span id="crv-trend-indicator" class="ml-2 text-2xl font-bold"></span>
                        <span id="crv-stars" class="ml-2 text-xl text-yellow-400"></span>
                    </p>
                </div>
                <div id="crv-chart-container" class="chart-container mt-4"></div>
            </div>
        </div>

        <!-- 价格提醒输入模态框 (新增) -->
        <div id="alert-input-modal" class="hidden modal fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50">
            <div class="bg-gray-800 p-8 rounded-xl shadow-2xl w-full max-w-sm">
                <h2 id="alert-input-title" class="text-2xl font-bold text-white mb-4 text-center">设置价格提醒</h2>
                <div class="flex flex-col gap-4">
                    <!-- 新增币种选择下拉菜单 -->
                    <select id="alert-symbol-select" class="bg-gray-700 text-white p-3 rounded-lg w-full focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="BTCUSDT">BTC/USDT</option>
                        <option value="ETHUSDT">ETH/USDT</option>
                        <option value="SOLUSDT">SOL/USDT</option>
                        <option value="PEOPLEUSDT">PEOPLE/USDT</option>
                        <option value="PNUTUSDT">PNUT/USDT</option>
                        <option value="SUIUSDT">SUI/USDT</option>
                        <option value="WIFUSDT">WIF/USDT</option>
                        <option value="AAVEUSDT">AAVE/USDT</option>
                        <option value="CRVUSDT">CRV/USDT</option>
                    </select>
                    <p id="alert-input-message" class="text-lg text-gray-300 mb-2 text-center"></p>
                    <input id="alert-price-input" type="number" step="0.01" class="bg-gray-700 text-white p-3 rounded-lg w-full focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="输入提醒价格">
                    <div class="flex justify-between gap-4 mt-4">
                        <button id="cancel-alert-btn" class="flex-1 bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-full transition-colors duration-300">取消</button>
                        <button id="set-alert-btn" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-full transition-colors duration-300">设置</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 通知模态框 (用于提醒和错误信息) -->
        <div id="notification-modal" class="hidden modal fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50">
            <div class="bg-gray-800 p-8 rounded-xl shadow-2xl w-full max-w-sm text-center">
                <h2 id="notification-title" class="text-2xl font-bold text-white mb-4"></h2>
                <p id="notification-message" class="text-lg text-gray-300 mb-6"></p>
                <button id="close-notification-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-full transition-colors duration-300">确定</button>
            </div>
        </div>
    </div>

    <script>
        // 定义全局变量，供 Canvas 环境注入
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : '';
        const apiKey = ""; // API 密钥，在 Canvas 环境中会自动填充

        // 加密货币符号映射
        const symbols = {
            'BTC': 'BTCUSDT',
            'ETH': 'ETHUSDT',
            'SOL': 'SOLUSDT',
            'PEOPLE': 'PEOPLEUSDT',
            'PNUT': 'PNUTUSDT',
            'SUI': 'SUIUSDT',
            'WIF': 'WIFUSDT',
            'AAVE': 'AAVEUSDT',
            'CRV': 'CRVUSDT'
        };
        const symbolMap = {
            'BTCUSDT': 'BTC',
            'ETHUSDT': 'ETH',
            'SOLUSDT': 'SOL',
            'PEOPLEUSDT': 'PEOPLE',
            'PNUTUSDT': 'PNUT',
            'SUIUSDT': 'SUI',
            'WIFUSDT': 'WIF',
            'AAVEUSDT': 'AAVE',
            'CRVUSDT': 'CRV'
        };

        // 获取 DOM 元素
        const mainContainer = document.querySelector('.main-container');
        const zoomInBtn = document.getElementById('zoom-in');
        const zoomOutBtn = document.getElementById('zoom-out');
        const setAlertMainBtn = document.getElementById('set-alert-main-btn');
        const notificationModal = document.getElementById('notification-modal');
        const notificationTitle = document.getElementById('notification-title');
        const notificationMessage = document.getElementById('notification-message');
        const closeNotificationBtn = document.getElementById('close-notification-btn');
        const cycleCountdownEl = document.getElementById('cycle-countdown');
        const cycleCounterEl = document.getElementById('cycle-counter');
        const alertInputModal = document.getElementById('alert-input-modal');
        const alertInputTitle = document.getElementById('alert-input-title');
        const alertInputMessage = document.getElementById('alert-input-message');
        const alertPriceInput = document.getElementById('alert-price-input');
        const cancelAlertBtn = document.getElementById('cancel-alert-btn');
        const setAlertBtn = document.getElementById('set-alert-btn');
        const alertSymbolSelect = document.getElementById('alert-symbol-select');
        
        // 缩放状态
        let currentScale = 1.0;
        const maxScale = 1.5;
        const minScale = 0.8;
        const scaleStep = 0.1;

        // 存储上一个周期的价格
        let previousPrices = {};
        Object.values(symbols).forEach(s => previousPrices[s] = null);

        // 存储价格历史，用于趋势判断（最近3个价格）
        let priceHistory = {};
        Object.values(symbols).forEach(s => priceHistory[s] = []);

        // 存储价格提醒
        let priceAlerts = {};
        Object.values(symbols).forEach(s => priceAlerts[s] = null);

        // 用于跟踪5分钟趋势的五角星数量
        let trendStars = {};
        Object.values(symbols).forEach(s => trendStars[s] = 0);

        // 用于跟踪上一个5分钟K线的收盘价，以便判断趋势
        let lastFiveMinClose = {};
        Object.values(symbols).forEach(s => lastFiveMinClose[s] = null);
        
        // 倒计时和周期计数器状态
        let countdownMinutes = 5;
        let countdownSeconds = 0;
        let cycleCount = 1;
        const maxCycles = 12;

        /**
         * 使用指数退避安全地调用 API
         * @param {Function} apiCall - 包含 API 调用的异步函数
         * @param {number} retries - 重试次数
         */
        async function fetchWithRetry(apiCall, retries = 3) {
            let delay = 1000;
            for (let i = 0; i < retries; i++) {
                try {
                    return await apiCall();
                } catch (error) {
                    console.error(`API 调用失败，正在重试第 ${i + 1} 次...`, error);
                    if (i < retries - 1) {
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2;
                    } else {
                        throw error;
                    }
                }
            }
        }

        /**
         * 从 Binance API 获取实时价格
         * @param {string} symbol - 货币符号，例如 'BTCUSDT'
         * @returns {Promise<string>} - 价格字符串
         */
        async function fetchPrice(symbol) {
            const response = await fetchWithRetry(() => fetch(`https://api.binance.com/api/v3/ticker/price?symbol=${symbol}`));
            if (!response.ok) {
                throw new Error('网络请求失败');
            }
            const data = await response.json();
            return parseFloat(data.price).toFixed(2);
        }

        /**
         * 从 Binance API 获取 K 线数据
         * @param {string} symbol - 货币符号，例如 'BTCUSDT'
         * @param {string} interval - 时间间隔，例如 '1h' 或 '5m'
         * @returns {Promise<Array>} - K 线数据数组
         */
        async function fetchKlines(symbol, interval = '5m') {
            const response = await fetchWithRetry(() => fetch(`https://api.binance.com/api/v3/klines?symbol=${symbol}&interval=${interval}&limit=2`));
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`获取 K 线数据失败: ${response.status} ${response.statusText} - ${errorText}`);
            }
            const data = await response.json();
            if (!Array.isArray(data) || data.length < 2) {
                 throw new Error('K 线数据为空或格式不正确');
            }
            return data;
        }
        
        /**
         * 从 Binance API 获取最近一小时的 K 线数据 (1分钟间隔)
         * @param {string} symbol - 货币符号，例如 'BTCUSDT'
         * @returns {Promise<Array>} - K 线数据数组
         */
        async function fetchHourlyData(symbol) {
            const response = await fetchWithRetry(() => fetch(`https://api.binance.com/api/v3/klines?symbol=${symbol}&interval=1m&limit=60`));
            if (!response.ok) {
                 const errorText = await response.text();
                 throw new Error(`获取小时数据失败: ${response.status} ${response.statusText} - ${errorText}`);
            }
            return await response.json();
        }

        /**
         * 更新所有货币的价格，并根据价格变动改变颜色
         */
        async function updatePrices() {
            try {
                // 动态生成所有币种的 API 请求
                const pricePromises = Object.values(symbols).map(symbol => fetchPrice(symbol));
                const allPrices = await Promise.all(pricePromises);

                Object.keys(symbols).forEach((coin, index) => {
                    const symbol = symbols[coin];
                    const price = allPrices[index];
                    const priceEl = document.getElementById(`${coin.toLowerCase()}-price`);
                    const indicatorEl = document.getElementById(`${coin.toLowerCase()}-trend-indicator`);
                    
                    if (priceEl && indicatorEl) {
                        updatePriceDisplay(priceEl, symbol, price);
                        updateTrendIndicator(indicatorEl, symbol, price);
                    }
                });
                
                checkPriceAlerts();

            } catch (error) {
                console.error('更新价格失败:', error);
                showAlertModal("更新失败", "无法获取实时价格，请检查网络连接或稍后再试。");
            }
        }

        /**
         * 更新价格显示并根据价格变化设置字体颜色
         * @param {HTMLElement} element - 显示价格的 DOM 元素
         * @param {string} symbol - 货币符号
         * @param {string} newPrice - 新价格
         */
        function updatePriceDisplay(element, symbol, newPrice) {
            const oldPrice = previousPrices[symbol];
            const priceText = `${newPrice}`;

            element.classList.remove('text-green-500', 'text-red-500', 'text-white');
            
            if (oldPrice === null) {
                element.classList.add('text-white');
            } else if (parseFloat(newPrice) > parseFloat(oldPrice)) {
                element.classList.add('text-green-500');
            } else if (parseFloat(newPrice) < parseFloat(oldPrice)) {
                element.classList.add('text-red-500');
            } else {
                element.classList.add('text-white');
            }

            element.textContent = `$${priceText}`;
            previousPrices[symbol] = newPrice;
        }

        /**
         * 更新趋势指示箭头
         * @param {HTMLElement} element - 显示箭头的 DOM 元素
         * @param {string} symbol - 货币符号
         * @param {string} newPrice - 新价格
         */
        function updateTrendIndicator(element, symbol, newPrice) {
            priceHistory[symbol].push(parseFloat(newPrice));
            if (priceHistory[symbol].length > 3) {
                priceHistory[symbol].shift();
            }

            if (priceHistory[symbol].length === 3) {
                const [p1, p2, p3] = priceHistory[symbol];
                element.classList.remove('text-green-500', 'text-red-500');

                if (p1 < p2 && p2 < p3) {
                    element.innerHTML = '&#8599;';
                    element.classList.add('text-green-500');
                } else if (p1 > p2 && p2 > p3) {
                    element.innerHTML = '&#8600;';
                    element.classList.add('text-red-500');
                } else {
                    element.innerHTML = '';
                }
            } else {
                element.innerHTML = '';
            }
        }

        /**
         * 检查是否有价格提醒被触发
         */
        function checkPriceAlerts() {
            for (const symbol in priceAlerts) {
                const alert = priceAlerts[symbol];
                if (alert && alert.price !== null) {
                    const currentPrice = parseFloat(previousPrices[symbol]);
                    const alertPrice = parseFloat(alert.price);
                    const initialPrice = parseFloat(alert.initialPrice);

                    // 检查价格是否从任意方向越过了提醒价格
                    const crossedUp = currentPrice >= alertPrice && initialPrice < alertPrice;
                    const crossedDown = currentPrice <= alertPrice && initialPrice > alertPrice;

                    if (crossedUp || crossedDown) {
                        triggerAudioAlert();
                        showAlertModal("价格提醒", `${symbolMap[symbol]} 已达到你的提醒价格 $${alertPrice}！`);
                        priceAlerts[symbol] = null; // 提醒后清除
                    }
                }
            }
        }

        /**
         * 播放音频提醒
         */
        function triggerAudioAlert() {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.type = 'sine';
            oscillator.frequency.value = 440;
            gainNode.gain.setValueAtTime(0, audioContext.currentTime);
            gainNode.gain.linearRampToValueAtTime(0.5, audioContext.currentTime + 0.1);

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            oscillator.start();
            
            setTimeout(() => {
                gainNode.gain.linearRampToValueAtTime(0, audioContext.currentTime + 0.1);
                oscillator.stop(audioContext.currentTime + 0.1);
            }, 2000);
        }

        /**
         * 显示通知模态框
         * @param {string} title - 标题
         * @param {string} message - 消息内容
         */
        function showAlertModal(title, message) {
            notificationTitle.textContent = title;
            notificationMessage.textContent = message;
            notificationModal.classList.remove('hidden');
        }

        /**
         * 更新五角星显示
         * @param {string} symbol - 货币符号
         * @param {number} starCount - 五角星数量
         */
        function renderStars(symbol, starCount) {
            const starsElement = document.getElementById(symbol.toLowerCase() + '-stars');
            if (starsElement) {
                starsElement.innerHTML = '&#9733;'.repeat(starCount);
            }
        }

        /**
         * 更新趋势五角星
         */
        async function updateTrendStars() {
            try {
                const klinesPromises = Object.values(symbols).map(symbol => fetchKlines(symbol));
                const allKlines = await Promise.all(klinesPromises);

                Object.keys(symbols).forEach((coin, index) => {
                    const symbol = symbols[coin];
                    const klines = allKlines[index];

                    if (!klines || klines.length < 2) return;

                    const prevClosePrice = parseFloat(klines[0][4]);
                    const currentClosePrice = parseFloat(klines[1][4]);

                    if (lastFiveMinClose[symbol] === null) {
                        lastFiveMinClose[symbol] = prevClosePrice;
                        return;
                    }
                    
                    if (currentClosePrice > lastFiveMinClose[symbol]) {
                        trendStars[symbol] = Math.min(5, trendStars[symbol] + 1);
                    } else if (currentClosePrice <= lastFiveMinClose[symbol]) {
                        trendStars[symbol] = 0;
                    }

                    lastFiveMinClose[symbol] = currentClosePrice;
                    renderStars(coin, trendStars[symbol]);
                });
            } catch (error) {
                console.error("更新五角星失败:", error);
            }
        }
        
        /**
         * 更新倒计时和周期计数
         */
        function updateTimer() {
            if (countdownMinutes === 0 && countdownSeconds === 0) {
                countdownMinutes = 5;
                countdownSeconds = 0;
                
                cycleCount++;
                if (cycleCount > maxCycles) {
                    cycleCount = 1;
                }
                
                updateTrendStars();
            }
            
            if (countdownSeconds === 0) {
                countdownMinutes--;
                countdownSeconds = 59;
            } else {
                countdownSeconds--;
            }
            
            const formattedMinutes = String(countdownMinutes).padStart(2, '0');
            const formattedSeconds = String(countdownSeconds).padStart(2, '0');
            cycleCountdownEl.textContent = `${formattedMinutes}:${formattedSeconds}`;
            cycleCounterEl.textContent = `(第 ${cycleCount} 周期 / ${maxCycles})`;
        }

        /**
         * 绘制价格曲线图
         * @param {string} symbol - 货币符号
         * @param {string} containerId - 图表容器的 ID
         */
        async function fetchAndDrawHourlyChart(symbol, containerId) {
            try {
                const klines = await fetchHourlyData(symbols[symbol]);
                if (!klines || klines.length === 0) {
                    console.error(`没有获取到 ${symbol} 的小时数据.`);
                    document.getElementById(containerId).innerHTML = `<p class="text-red-500 text-center">无法加载图表数据。</p>`;
                    return;
                }

                const data = klines.map(d => ({
                    time: new Date(d[0]),
                    price: parseFloat(d[4])
                }));

                const container = d3.select(`#${containerId}`);
                container.select("svg").remove();

                const margin = { top: 10, right: 30, bottom: 30, left: 60 };
                const width = container.node().getBoundingClientRect().width - margin.left - margin.right;
                const height = 200 - margin.top - margin.bottom;

                const svg = container.append("svg")
                    .attr("width", width + margin.left + margin.right)
                    .attr("height", height + margin.top + margin.bottom)
                    .append("g")
                    .attr("transform", `translate(${margin.left},${margin.top})`);

                const x = d3.scaleTime()
                    .domain(d3.extent(data, d => d.time))
                    .range([0, width]);
                
                const xAxis = d3.axisBottom(x)
                    .ticks(d3.timeMinute.every(10))
                    .tickFormat(d3.timeFormat("%H:%M", 'Asia/Shanghai'));

                svg.append("g")
                    .attr("transform", `translate(0,${height})`)
                    .call(xAxis)
                    .call(g => g.select(".domain").remove())
                    .selectAll("text")
                    .style("fill", "#c9d1d9");

                const y = d3.scaleLinear()
                    .domain([d3.min(data, d => d.price) * 0.99, d3.max(data, d => d.price) * 1.01])
                    .range([height, 0]);

                svg.append("g")
                    .call(d3.axisLeft(y).tickFormat(d3.format(".2f")).ticks(5))
                    .call(g => g.select(".domain").remove())
                    .selectAll("text")
                    .style("fill", "#c9d1d9");

                svg.append("path")
                    .datum(data)
                    .attr("fill", "none")
                    .attr("stroke", "#60a5fa")
                    .attr("stroke-width", 2)
                    .attr("d", d3.line()
                        .x(d => x(d.time))
                        .y(d => y(d.price))
                    );

                // 添加 tooltip
                const tooltip = d3.select("body").append("div")
                    .attr("class", "chart-tooltip hidden");

                const focus = svg.append("g")
                    .attr("class", "focus hidden");

                focus.append("circle")
                    .attr("r", 5)
                    .attr("fill", "#fff")
                    .attr("stroke", "#60a5fa")
                    .attr("stroke-width", 2);

                svg.append("rect")
                    .attr("class", "overlay")
                    .attr("width", width)
                    .attr("height", height)
                    .style("fill", "none")
                    .style("pointer-events", "all")
                    .on("mouseover", function() { focus.classed("hidden", false); tooltip.classed("hidden", false); })
                    .on("mouseout", function() { focus.classed("hidden", true); tooltip.classed("hidden", true); })
                    .on("mousemove", mousemove);

                function mousemove(event) {
                    const bisectDate = d3.bisector(d => d.time).left;
                    const x0 = x.invert(d3.pointer(event)[0]);
                    const i = bisectDate(data, x0, 1);
                    const d0 = data[i - 1];
                    const d1 = data[i];
                    const d = x0 - d0.time > d1.time - x0 ? d1 : d0;
                    focus.attr("transform", `translate(${x(d.time)},${y(d.price)})`);
                    tooltip.style("left", `${event.pageX + 10}px`)
                           .style("top", `${event.pageY - 28}px`)
                           .html(`<strong>${d3.timeFormat("%H:%M", 'Asia/Shanghai')(d.time)}</strong><br>$${d.price.toFixed(2)}`);
                }
            } catch (error) {
                console.error(`绘制 ${symbol} 图表失败:`, error);
                document.getElementById(containerId).innerHTML = `<p class="text-red-500 text-center">加载图表时出错。</p>`;
            }
        }
        
        /**
         * 更新提醒对话框中的币种当前价格信息
         */
        function updateAlertMessage() {
            const binanceSymbol = alertSymbolSelect.value;
            const coinSymbol = symbolMap[binanceSymbol];
            const currentPrice = previousPrices[binanceSymbol];
            alertInputMessage.textContent = `当前 ${coinSymbol} 价格为 $${currentPrice || '-'}，请输入你的提醒价格：`;
        }

        /**
         * 启动应用程序的主要逻辑
         */
        function startApp() {
            try {
                zoomInBtn.addEventListener('click', () => {
                    if (currentScale < maxScale) {
                        currentScale += scaleStep;
                        mainContainer.style.transform = `scale(${currentScale})`;
                    }
                });

                zoomOutBtn.addEventListener('click', () => {
                    if (currentScale > minScale) {
                        currentScale -= scaleStep;
                        mainContainer.style.transform = `scale(${currentScale})`;
                    }
                });
                
                setAlertMainBtn.addEventListener('click', () => {
                    updateAlertMessage();
                    alertInputModal.classList.remove('hidden');
                    alertPriceInput.focus();
                });
                
                alertSymbolSelect.addEventListener('change', updateAlertMessage);

                cancelAlertBtn.addEventListener('click', () => {
                    alertInputModal.classList.add('hidden');
                    alertPriceInput.value = '';
                });

                setAlertBtn.addEventListener('click', () => {
                    const alertPrice = parseFloat(alertPriceInput.value);
                    const binanceSymbol = alertSymbolSelect.value;
                    const coinSymbol = symbolMap[binanceSymbol];
                    const currentPrice = previousPrices[binanceSymbol];

                    if (alertPrice && !isNaN(alertPrice)) {
                        priceAlerts[binanceSymbol] = { 
                            price: alertPrice, 
                            initialPrice: currentPrice 
                        };
                        showAlertModal("提醒设置成功", `当 ${coinSymbol} 价格达到 $${alertPrice} 时，你将会收到提醒。`);
                    } else {
                         showAlertModal("输入无效", "请输入一个有效的数字价格。");
                    }
                    alertInputModal.classList.add('hidden');
                    alertPriceInput.value = '';
                });

                closeNotificationBtn.addEventListener('click', () => {
                    notificationModal.classList.add('hidden');
                });
        
                updatePrices();
                updateTrendStars();
                
                // 动态绘制所有币种的图表
                Object.keys(symbols).forEach(coin => {
                    fetchAndDrawHourlyChart(coin, `${coin.toLowerCase()}-chart-container`);
                });

                // 定时更新
                setInterval(updatePrices, 15000);
                setInterval(updateTimer, 1000);
                setInterval(() => {
                    Object.keys(symbols).forEach(coin => {
                        fetchAndDrawHourlyChart(coin, `${coin.toLowerCase()}-chart-container`);
                    });
                }, 60000);

            } catch (error) {
                console.error("应用程序初始化失败:", error);
                showAlertModal("应用程序错误", `应用程序初始化失败。错误信息: ${error.message}`);
            }
        }
        
        window.onload = startApp;
    </script>
</body>
</html>
