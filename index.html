<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>LUMINA PRO</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#000000">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><circle cx=%2250%22 cy=%2250%22 r=%2240%22 fill=%22%23000%22 stroke=%22%2300e5ff%22 stroke-width=%225%22/><text x=%2250%22 y=%2265%22 font-family=%22sans-serif%22 font-weight=%22900%22 font-size=%2250%22 fill=%22%23fff%22 text-anchor=%22middle%22>L</text></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 fill=%22%23111%22/><circle cx=%2250%22 cy=%2250%22 r=%2240%22 fill=%22none%22 stroke=%22%2300e5ff%22 stroke-width=%225%22/><text x=%2250%22 y=%2265%22 font-family=%22sans-serif%22 font-weight=%22900%22 font-size=%2250%22 fill=%22%23fff%22 text-anchor=%22middle%22>L</text></svg>">
    
    <script>
        // PWA Manifest Injection
        const manifest = {
            "name": "LUMINA Pro",
            "short_name": "LUMINA",
            "display": "standalone",
            "background_color": "#000000",
            "theme_color": "#000000",
            "icons": [{"src": "data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 fill=%22%23111%22/><circle cx=%2250%22 cy=%2250%22 r=%2240%22 fill=%22none%22 stroke=%22%2300e5ff%22 stroke-width=%225%22/><text x=%2250%22 y=%2265%22 font-family=%22sans-serif%22 font-weight=%22900%22 font-size=%2250%22 fill=%22%23fff%22 text-anchor=%22middle%22>L</text></svg>", "sizes": "192x192 512x512", "type": "image/svg+xml"}]
        };
        const link = document.createElement('link'); link.rel = 'manifest'; link.href = URL.createObjectURL(new Blob([JSON.stringify(manifest)], {type: 'application/json'})); document.head.appendChild(link);
    </script>

    <style>
        :root { --accent: #00e5ff; --bg: #000; --panel: #121212; --text: #eee; --safe-top: env(safe-area-inset-top); --safe-bottom: env(safe-area-inset-bottom); }
        * { box-sizing: border-box; user-select: none; outline: none; -webkit-tap-highlight-color: transparent; font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", Roboto, sans-serif; }
        body { margin: 0; background: var(--bg); color: var(--text); height: 100vh; width: 100vw; overflow: hidden; display: flex; flex-direction: column; }

        /* --- 1. Top Bar --- */
        .top-bar {
            height: calc(50px + var(--safe-top)); padding-top: var(--safe-top);
            display: flex; justify-content: space-between; align-items: center; padding-left: 15px; padding-right: 15px;
            background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent); z-index: 100; position: absolute; top:0; left:0; right:0; pointer-events: none;
        }
        .top-btn { pointer-events: auto; background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); width: 36px; height: 36px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 16px; border: 1px solid rgba(255,255,255,0.1); }
        .top-btn:active { background: rgba(255,255,255,0.3); }

        /* --- 2. Stage (Canvas) --- */
        .stage-area { flex: 1; position: relative; display: flex; justify-content: center; align-items: center; overflow: hidden; background: #000; }
        #canvas-wrap { transition: transform 0.1s linear; box-shadow: 0 0 40px rgba(0,0,0,0.5); }
        canvas { display: block; }
        
        #empty-state { position: absolute; inset: 0; display: flex; flex-direction: column; justify-content: center; align-items: center; color: #666; gap: 15px; z-index: 50; }
        .add-btn { width: 60px; height: 60px; border-radius: 50%; border: 2px dashed #444; display: flex; justify-content: center; align-items: center; font-size: 30px; color: #444; }

        /* --- 3. Bottom Controls (Main UI) --- */
        .controls { 
            background: var(--panel); border-top-left-radius: 20px; border-top-right-radius: 20px;
            padding-bottom: var(--safe-bottom); position: relative; z-index: 100;
            display: flex; flex-direction: column; transition: height 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            box-shadow: 0 -5px 20px rgba(0,0,0,0.5);
        }

        /* Nav Tabs */
        .nav-bar { display: flex; justify-content: space-around; height: 60px; align-items: center; border-bottom: 1px solid #222; flex-shrink: 0; }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; opacity: 0.5; transition: 0.2s; height: 100%; gap: 4px; }
        .nav-item.active { opacity: 1; color: var(--accent); }
        .nav-icon { font-size: 20px; }
        .nav-lbl { font-size: 10px; font-weight: 500; }

        /* Functional Panels */
        .panel-container { height: 160px; overflow: hidden; position: relative; }
        .panel { position: absolute; inset: 0; display: none; padding: 15px 0; animation: fade In 0.2s; }
        .panel.active { display: block; }

        /* A. Presets (Horizontal Scroll) */
        .scroll-row { display: flex; overflow-x: auto; padding: 0 15px; gap: 12px; height: 100%; align-items: center; -webkit-overflow-scrolling: touch; scrollbar-width: none; }
        .scroll-row::-webkit-scrollbar { display: none; }
        .preset-chip { 
            flex-shrink: 0; width: 70px; height: 90px; background: #222; border-radius: 8px; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 5px;
            border: 1px solid #333; transition: 0.1s; position: relative; overflow: hidden;
        }
        .preset-chip.active { border-color: var(--accent); background: #222; }
        .preset-chip.active::after { content:''; position: absolute; bottom:0; left:0; right:0; height:3px; background:var(--accent); }
        .p-name { font-size: 11px; font-weight: bold; color: #ccc; }
        .p-sub { font-size: 9px; color: #666; text-transform: uppercase; }

        /* B. Sliders (Adjust) */
        .slider-list { padding: 0 20px; height: 100%; overflow-y: auto; }
        .slider-group { margin-bottom: 15px; }
        .sl-header { display: flex; justify-content: space-between; font-size: 12px; color: #aaa; margin-bottom: 8px; }
        .sl-val { color: var(--accent); font-family: monospace; }
        input[type=range] { width: 100%; -webkit-appearance: none; background: transparent; height: 20px; display: block; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; background: #333; border-radius: 2px; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 18px; width: 18px; border-radius: 50%; background: #eee; margin-top: -7px; box-shadow: 0 2px 4px rgba(0,0,0,0.5); border: 2px solid #000; }
        input[type=range]:active::-webkit-slider-thumb { background: var(--accent); transform: scale(1.2); }

        /* C. Color Wheels (Optimized) */
        .col-tabs { display: flex; justify-content: center; gap: 20px; margin-bottom: 15px; }
        .c-tab { font-size: 12px; color: #666; padding: 4px 10px; border-radius: 12px; border: 1px solid transparent; }
        .c-tab.active { color: #fff; border-color: #444; background: #222; }
        
        .wheel-area { display: flex; justify-content: center; position: relative; height: 100px; }
        .wheel-disk { width: 100px; height: 100px; border-radius: 50%; background: #000; border: 2px solid #333; position: relative; touch-action: none; }
        .wheel-grad { position: absolute; inset: 2px; border-radius: 50%; background: conic-gradient(red, magenta, blue, cyan, lime, yellow, red); opacity: 0.8; pointer-events: none; }
        .wheel-puck { width: 14px; height: 14px; border: 2px solid #fff; background: transparent; border-radius: 50%; position: absolute; top: 50%; left: 50%; transform: translate(-50%,-50%); pointer-events: none; box-shadow: 0 0 4px rgba(0,0,0,1); }

        /* Toast & Overlays */
        #toast { position: fixed; top: 50%; left: 50%; transform: translate(-50%,-50%); background: rgba(0,0,0,0.85); color: #fff; padding: 12px 24px; border-radius: 30px; font-size: 14px; font-weight: bold; pointer-events: none; opacity: 0; transition: 0.3s; z-index: 999; backdrop-filter: blur(5px); display: flex; align-items: center; gap: 8px; }
        .comp-btn { position: absolute; bottom: 180px; right: 20px; width: 44px; height: 44px; background: rgba(255,255,255,0.15); border-radius: 50%; display: flex; justify-content: center; align-items: center; backdrop-filter: blur(10px); z-index: 90; border: 1px solid rgba(255,255,255,0.2); font-size: 20px; }
        .comp-btn:active { background: var(--accent); color: #000; }

        /* File Input */
        #file-in { display: none; }
    </style>
</head>
<body>

<div class="top-bar">
    <div class="top-btn" onclick="document.getElementById('file-in').click()">üìÇ</div>
    <div style="font-weight:900; font-style:italic; letter-spacing:1px; font-size:18px;">LUMINA <span style="color:var(--accent)">PRO</span></div>
    <div class="top-btn" onclick="exportImage()">üíæ</div>
</div>
<input type="file" id="file-in" accept="image/*">

<main class="stage-area" id="stage">
    <div id="empty-state" onclick="document.getElementById('file-in').click()">
        <div class="add-btn">Ôºã</div>
        <div style="font-size:12px; opacity:0.7">ÊâìÂºÄÁÖßÁâáÂºÄÂßãÁºñËæë</div>
    </div>
    <div id="canvas-wrap">
        <canvas id="gl"></canvas>
    </div>
    <div class="comp-btn" id="btn-comp" ontouchstart="setCompare(true)" ontouchend="setCompare(false)" onmousedown="setCompare(true)" onmouseup="setCompare(false)">üëÅ</div>
</main>

<div class="controls">
    <div class="panel-container">
        
        <div class="panel active" id="p-presets">
            <div class="scroll-row" id="preset-list">
                </div>
        </div>

        <div class="panel" id="p-adjust">
            <div class="slider-list">
                <div class="slider-group"><div class="sl-header"><span>ÊõùÂÖâ Exposure</span><span class="sl-val" id="v-exp">0</span></div><input type="range" id="s-exp" min="-2" max="2" step="0.01" oninput="u('exp',this.value)"></div>
                <div class="slider-group"><div class="sl-header"><span>ÂØπÊØîÂ∫¶ Contrast</span><span class="sl-val" id="v-con">1.0</span></div><input type="range" id="s-con" min="0" max="2" step="0.01" oninput="u('con',this.value)"></div>
                <div class="slider-group"><div class="sl-header"><span>È•±ÂíåÂ∫¶ Saturation</span><span class="sl-val" id="v-sat">1.0</span></div><input type="range" id="s-sat" min="0" max="2" step="0.01" oninput="u('sat',this.value)"></div>
                <div class="slider-group"><div class="sl-header"><span>Ëâ≤Ê∏© Temp</span><span class="sl-val" id="v-hue">0</span></div><input type="range" id="s-hue" min="-0.2" max="0.2" step="0.01" oninput="u('hue',this.value)"></div>
                <div class="slider-group"><div class="sl-header"><span>Ê∞õÂõ¥ Boost</span><span class="sl-val" id="v-boost">0</span></div><input type="range" id="s-boost" min="0" max="1" step="0.01" oninput="u('boost',this.value)"></div>
                <div class="slider-group"><div class="sl-header"><span>ÈîêÂåñ Sharpness</span><span class="sl-val" id="v-shp">0</span></div><input type="range" id="s-shp" min="0" max="2" step="0.01" oninput="u('shp',this.value)"></div>
            </div>
        </div>

        <div class="panel" id="p-color">
            <div class="col-tabs">
                <div class="c-tab active" onclick="setWheelMode('lift')" id="t-lift">ÊöóÈÉ® Lift</div>
                <div class="c-tab" onclick="setWheelMode('gamma')" id="t-gamma">‰∏≠ÁÅ∞ Gamma</div>
                <div class="c-tab" onclick="setWheelMode('gain')" id="t-gain">‰∫ÆÈÉ® Gain</div>
                <div class="c-tab" onclick="setWheelMode('offset')" id="t-offset">ÂÅèÁßª Offset</div>
            </div>
            <div class="wheel-area">
                <div class="wheel-disk" id="wheel-touch">
                    <div class="wheel-grad"></div>
                    <div class="wheel-puck" id="puck"></div>
                </div>
            </div>
            <div style="text-align:center; font-size:10px; color:#555; margin-top:10px;">ÂèåÂáªËâ≤ËΩÆÂ§ç‰ΩçÂΩìÂâçËâ≤Ë∞É</div>
        </div>
    </div>

    <div class="nav-bar">
        <div class="nav-item active" onclick="nav('presets', this)">
            <div class="nav-icon">üéûÔ∏è</div><div class="nav-lbl">Êª§Èïú</div>
        </div>
        <div class="nav-item" onclick="nav('adjust', this)">
            <div class="nav-icon">üéöÔ∏è</div><div class="nav-lbl">ÂèÇÊï∞</div>
        </div>
        <div class="nav-item" onclick="nav('color', this)">
            <div class="nav-icon">üé®</div><div class="nav-lbl">Ëâ≤ËΩÆ</div>
        </div>
    </div>
</div>

<div id="toast">‚úÖ Â∑≤‰øùÂ≠òÂà∞Áõ∏ÂÜå</div>

<script id="vs" type="x-shader/x-vertex">attribute vec2 p; attribute vec2 u; varying vec2 v; void main(){ gl_Position=vec4(p,0,1); v=u; }</script>
<script id="fs" type="x-shader/x-fragment">
precision mediump float; uniform sampler2D t; varying vec2 v; uniform vec2 res;
uniform float brt,exp,con,sat,hue,boost,shp,cmp; 
uniform vec4 lft,gam,gan,off;
const vec3 W=vec3(0.299,0.587,0.114);
vec3 satf(vec3 c, float s){ float g=dot(c,W); return mix(vec3(g),c,s); }
vec3 h2r(vec3 c){vec4 K=vec4(1.,2./3.,1./3.,3.);vec3 p=abs(fract(c.xxx+K.xyz)*6.-K.www);return c.z*mix(K.xxx,clamp(p-K.xxx,0.,1.),c.y);}
vec3 r2h(vec3 c){vec4 K=vec4(0.,-1./3.,2./3.,-1.);vec4 p=mix(vec4(c.bg,K.wz),vec4(c.gb,K.xy),step(c.b,c.g));vec4 q=mix(vec4(p.xyw,c.r),vec4(c.r,p.yzx),step(p.x,c.r));float d=q.x-min(q.w,q.y);float e=1.0e-10;return vec3(abs(q.z+(q.w-q.y)/(6.*d+e)),d/(q.x+e),q.x);}

void main(){
    vec4 px = texture2D(t, v);
    if(cmp > 0.5) { gl_FragColor = px; return; } // Compare Mode
    
    vec3 c = px.rgb;
    
    // Sharpen (Simple)
    if(shp > 0.0) {
        vec2 d = 1.0/res; 
        vec3 s = texture2D(t, v+vec2(0,d.y)).rgb + texture2D(t, v-vec2(0,d.y)).rgb + texture2D(t, v+vec2(d.x,0)).rgb + texture2D(t, v-vec2(d.x,0)).rgb;
        c = c + (c - s*0.25) * shp;
    }

    // Hue Rot
    if(abs(hue) > 0.001) { vec3 h = r2h(c); h.x += hue; c = h2r(h); }

    // Basic
    c += brt; c *= pow(2.0, exp); c = 0.5 + (c - 0.5) * con; c = satf(c, sat); c = satf(c, 1.0 + boost);

    // Color Grading (ASC-CDL approx)
    vec3 L = lft.rgb + lft.w; vec3 G = 1.0 / (1.0 + gam.rgb + gam.w); vec3 A = 1.0 + gan.rgb + gan.w; vec3 O = off.rgb + off.w;
    c = (c + L * 0.2) * A; c = pow(max(vec3(0.0), c), G); c += O * 0.2;

    gl_FragColor = vec4(c, px.a);
}
</script>

<script>
    // --- State & Config ---
    const presets = [
        {id:'none', n:'ÂéüÂõæ', t:'RAW', v:{}},
        {id:'port', n:'‰∫∫ÂÉè', t:'SOFT', v:{con:1.05, sat:0.9, exp:0.1, gam:{r:0.05,g:0,b:0}}},
        {id:'land', n:'È£éÊôØ', t:'VIVID', v:{sat:1.3, con:1.15, lft:{b:0.05}}},
        {id:'city', n:'Âª∫Á≠ë', t:'HDR', v:{shp:0.5, con:1.1, sat:0.8, lft:{r:0.02,g:0.02,b:0.02}}},
        {id:'food', n:'ÁæéÈ£ü', t:'WARM', v:{sat:1.2, exp:0.1, gam:{r:0.05, g:0.02}}},
        {id:'film', n:'ËÉ∂Áâá', t:'CINE', v:{con:1.1, sat:0.9, lft:{b:-0.05}, gan:{r:0.05}}},
        {id:'teal', n:'ÈùíÊ©ô', t:'MOVIE', v:{lft:{r:-0.1}, gan:{r:0.1, b:-0.1}, sat:1.1}},
        {id:'bw',   n:'ÈªëÁôΩ', t:'MONO', v:{sat:0, con:1.2, exp:0.05}},
        {id:'fuji', n:'ÂØåÂ£´', t:'NC', v:{sat:1.1, lft:{b:0.08}, gan:{g:0.02}}},
        {id:'kd',   n:'ÊüØËææ', t:'GOLD', v:{sat:1.15, gam:{r:0.05,b:-0.05}, con:1.1}},
        {id:'sony', n:'Á¥¢Â∞º', t:'STD', v:{con:1.15, sat:1.05}},
        {id:'canon',n:'‰Ω≥ËÉΩ', t:'SKIN', v:{sat:1.05, gan:{r:0.05}}},
        {id:'nikon',n:'Â∞ºÂ∫∑', t:'NEU', v:{con:1.1, shp:0.3}},
        {id:'leica',n:'ÂæïÂç°', t:'VIVID', v:{con:1.3, sat:1.1, lft:{r:-0.05,g:-0.05,b:-0.05}}}
    ];
    
    const def = { brt:0, exp:0, con:1, sat:1, hue:0, boost:0, shp:0, cmp:0, lft:{r:0,g:0,b:0,w:0}, gam:{r:0,g:0,b:0,w:0}, gan:{r:0,g:0,b:0,w:0}, off:{r:0,g:0,b:0,w:0} };
    let st = JSON.parse(JSON.stringify(def));
    let gl, prog, tex, cvs = document.getElementById('gl');
    let activeWheel = 'lift'; // 'lift', 'gamma', 'gain', 'offset'

    // --- Init ---
    window.onload = () => {
        try { gl = cvs.getContext('webgl', {preserveDrawingBuffer:true}); } catch(e){}
        if(!gl) return alert("WebGL Error");
        
        initGL();
        renderPresets();
        
        // File Input
        document.getElementById('file-in').onchange = e => { if(e.target.files.length) loadImg(e.target.files[0]); };

        // Wheel Touch Logic
        const wd = document.getElementById('wheel-touch');
        wd.addEventListener('touchstart', e => { e.preventDefault(); handleWheel(e.touches[0], true); }, {passive:false});
        wd.addEventListener('touchmove', e => { e.preventDefault(); handleWheel(e.touches[0], false); }, {passive:false});
        wd.addEventListener('dblclick', () => { 
            st[activeWheel] = {r:0,g:0,b:0,w:0}; updateWheelPuck(); draw(); haptic();
        });

        // Zoom/Pan logic
        const stage = document.getElementById('canvas-wrap');
        let zScale = 1, zStart = 0;
        document.getElementById('stage').addEventListener('touchstart', e => {
            if(e.touches.length === 2) { zStart = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY); }
        });
        document.getElementById('stage').addEventListener('touchmove', e => {
            if(e.touches.length === 2) {
                e.preventDefault();
                const dist = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY);
                const delta = dist / zStart;
                zScale = Math.min(Math.max(0.8, zScale * delta), 4.0); // Limit zoom
                stage.style.transform = `scale(${zScale})`;
                zStart = dist;
            }
        });
    };

    // --- Core Functions ---
    function initGL() {
        const vs = gl.createShader(gl.VERTEX_SHADER); gl.shaderSource(vs, document.getElementById('vs').text); gl.compileShader(vs);
        const fs = gl.createShader(gl.FRAGMENT_SHADER); gl.shaderSource(fs, document.getElementById('fs').text); gl.compileShader(fs);
        prog = gl.createProgram(); gl.attachShader(prog, vs); gl.attachShader(prog, fs); gl.linkProgram(prog); gl.useProgram(prog);
        gl.bindBuffer(gl.ARRAY_BUFFER, gl.createBuffer()); gl.bufferData(gl.ARRAY_BUFFER, new Float32Array([-1,-1,0,1,1,-1,1,1,-1,1,0,0,-1,1,0,0,1,-1,1,1,1,1,1,0]), gl.STATIC_DRAW);
    }

    function loadImg(file) {
        const img = new Image();
        img.onload = () => {
            // Resize for performance on mobile
            let w = img.width, h = img.height;
            const max = 2048;
            if (w > max || h > max) { const s = Math.min(max/w, max/h); w = Math.floor(w*s); h = Math.floor(h*s); }
            
            cvs.width = w; cvs.height = h;
            // CSS Fit
            const stageH = document.getElementById('stage').clientHeight;
            const stageW = document.getElementById('stage').clientWidth;
            const ratio = Math.min((stageW-20)/w, (stageH-20)/h);
            cvs.style.width = (w*ratio)+'px'; cvs.style.height = (h*ratio)+'px';

            const c = document.createElement('canvas'); c.width = w; c.height = h;
            c.getContext('2d').drawImage(img,0,0,w,h);
            
            if(tex) gl.deleteTexture(tex);
            tex = gl.createTexture(); gl.bindTexture(gl.TEXTURE_2D, tex);
            gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR);
            gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);
            gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);
            gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, c);
            
            document.getElementById('empty-state').style.display = 'none';
            document.getElementById('btn-comp').style.display = 'flex';
            resetAll(true);
        };
        img.src = URL.createObjectURL(file);
    }

    function draw() {
        if(!tex) return;
        gl.useProgram(prog);
        const p = gl.getAttribLocation(prog,"p"); gl.enableVertexAttribArray(p); gl.vertexAttribPointer(p,2,gl.FLOAT,false,16,0);
        const u = gl.getAttribLocation(prog,"u"); gl.enableVertexAttribArray(u); gl.vertexAttribPointer(u,2,gl.FLOAT,false,16,8);
        
        const f = (n,v) => gl.uniform1f(gl.getUniformLocation(prog,n), v);
        f("brt", st.brt); f("exp", st.exp); f("con", st.con); f("sat", st.sat); 
        f("hue", st.hue); f("boost", st.boost); f("shp", st.shp); f("cmp", st.cmp);
        gl.uniform2f(gl.getUniformLocation(prog,"res"), cvs.width, cvs.height);
        
        const v4 = (n,v) => gl.uniform4f(gl.getUniformLocation(prog,n), v.r, v.g, v.b, v.w);
        v4("lft", st.lft); v4("gam", st.gam); v4("gan", st.gan); v4("off", st.off);
        
        gl.drawArrays(gl.TRIANGLES, 0, 6);
    }

    // --- UI Logic ---
    window.nav = (pid, el) => {
        document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
        document.getElementById('p-'+pid).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        el.classList.add('active');
    };

    window.u = (k, v) => {
        st[k] = parseFloat(v);
        document.getElementById('v-'+k).innerText = st[k];
        draw();
        // Debounce haptic to avoid buzzing madness
        if(Math.random()>0.7) haptic();
    };

    window.resetAll = (full=true) => {
        st = JSON.parse(JSON.stringify(def));
        if(full) {
            document.querySelectorAll('.preset-chip').forEach(c=>c.classList.remove('active'));
            document.getElementById('pre-none').classList.add('active');
        }
        syncUI(); draw();
    };

    function syncUI() {
        ['exp','con','sat','hue','boost','shp'].forEach(k => {
            const el = document.getElementById('s-'+k);
            if(el) { el.value = st[k]; document.getElementById('v-'+k).innerText = st[k]; }
        });
        updateWheelPuck();
    }

    // --- Presets System ---
    function renderPresets() {
        const c = document.getElementById('preset-list');
        c.innerHTML = '';
        presets.forEach(p => {
            const div = document.createElement('div');
            div.className = 'preset-chip';
            div.id = 'pre-' + p.id;
            if(p.id === 'none') div.classList.add('active');
            div.innerHTML = `<span class="p-name">${p.n}</span><span class="p-sub">${p.t}</span>`;
            div.onclick = () => applyPreset(p);
            c.appendChild(div);
        });
    }

    function applyPreset(p) {
        document.querySelectorAll('.preset-chip').forEach(c=>c.classList.remove('active'));
        document.getElementById('pre-'+p.id).classList.add('active');
        st = JSON.parse(JSON.stringify(def)); // Reset first
        // Merge preset values
        for(let k in p.v) st[k] = (typeof p.v[k] === 'object') ? {...st[k], ...p.v[k]} : p.v[k];
        syncUI(); draw(); haptic();
    }

    // --- Color Wheel System ---
    window.setWheelMode = (m) => {
        activeWheel = m;
        document.querySelectorAll('.c-tab').forEach(t => t.classList.remove('active'));
        document.getElementById('t-'+m).classList.add('active');
        updateWheelPuck();
        haptic();
    };

    function handleWheel(touch, isStart) {
        const disk = document.getElementById('wheel-touch');
        const rect = disk.getBoundingClientRect();
        const cx = rect.left + rect.width/2;
        const cy = rect.top + rect.height/2;
        
        let dx = (touch.clientX - cx) / (rect.width/2);
        let dy = (touch.clientY - cy) / (rect.height/2);
        
        // Clamp to circle
        const dist = Math.sqrt(dx*dx + dy*dy);
        if(dist > 1) { dx /= dist; dy /= dist; }
        
        // Update State (Scale down effect for precision)
        const factor = 0.2; // Sensitivity
        st[activeWheel].r = dx * factor;
        st[activeWheel].b = -dy * factor; // Y is inverted in CSS transform vs standard
        
        updateWheelPuck();
        draw();
    }

    function updateWheelPuck() {
        const factor = 0.2;
        const x = (st[activeWheel].r / factor) * 50; 
        const y = -(st[activeWheel].b / factor) * 50; 
        document.getElementById('puck').style.transform = `translate(calc(-50% + ${x}px), calc(-50% + ${y}px))`;
    }

    // --- Utils ---
    window.setCompare = (bool) => { st.cmp = bool ? 1 : 0; draw(); };
    
    window.exportImage = () => {
        if(!tex) return;
        draw();
        const lnk = document.createElement('a');
        lnk.download = 'LUMINA_Edit.jpg';
        lnk.href = cvs.toDataURL('image/jpeg', 0.95);
        lnk.click();
        showToast();
    };

    function showToast() {
        const t = document.getElementById('toast');
        t.style.opacity = 1; t.style.top = '50%';
        setTimeout(() => { t.style.opacity = 0; }, 2000);
    }
    
    function haptic() {
        if(navigator.vibrate) navigator.vibrate(5);
    }
</script>
</body>
</html>
